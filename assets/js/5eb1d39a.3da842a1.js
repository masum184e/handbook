"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[6327],{28453(e,n,r){r.d(n,{R:()=>o,x:()=>l});var s=r(96540);const i={},t=s.createContext(i);function o(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(t.Provider,{value:n},e.children)}},29123(e,n,r){r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"nextjs/Custom Server","title":"Custom Server","description":"Set Up Custom Server","source":"@site/docs/nextjs/15. Custom Server.md","sourceDirName":"nextjs","slug":"/nextjs/Custom Server","permalink":"/handbook/docs/nextjs/Custom Server","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":17,"frontMatter":{"title":"Custom Server","sidebar_position":17},"sidebar":"nextjsSidebar","previous":{"title":"Internationalization","permalink":"/handbook/docs/nextjs/Internationlization"},"next":{"title":"Testing","permalink":"/handbook/docs/nextjs/Testing"}}');var i=r(74848),t=r(28453);const o={title:"Custom Server",sidebar_position:17},l=void 0,d={},c=[{value:"Set Up Custom Server",id:"set-up-custom-server",level:2},{value:"Setting Up a Custom Server",id:"setting-up-a-custom-server",level:3},{value:"When to Use Custom Server?",id:"when-to-use-custom-server",level:3},{value:"Differences vs. Default Next.js Server",id:"differences-vs-default-nextjs-server",level:3},{value:"Custom Server Configuration",id:"custom-server-configuration",level:2},{value:"Common Custom Configurations",id:"common-custom-configurations",level:3},{value:"Environment Variables",id:"environment-variables",level:4},{value:"Custom Webpack Config",id:"custom-webpack-config",level:4},{value:"Redirects",id:"redirects",level:4},{value:"Rewrites",id:"rewrites",level:4},{value:"Headers",id:"headers",level:4},{value:"Image Optimization",id:"image-optimization",level:4},{value:"Internationalization (i18n)",id:"internationalization-i18n",level:4}];function a(e){const n={code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"set-up-custom-server",children:"Set Up Custom Server"}),"\n",(0,i.jsx)(n.p,{children:"By default, Next.js provides a built-in server (using Node.js) that handles:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Routing"}),"\n",(0,i.jsx)(n.li,{children:"API routes"}),"\n",(0,i.jsx)(n.li,{children:"Static files"}),"\n",(0,i.jsx)(n.li,{children:"SSR (server-side rendering)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"But sometimes you need more control over the server, such as:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Adding custom routes not handled by Next.js."}),"\n",(0,i.jsx)(n.li,{children:"Adding custom middleware (e.g., authentication, logging)."}),"\n",(0,i.jsx)(n.li,{children:"Integrating with an existing backend (e.g., Express, Koa, Fastify)."}),"\n",(0,i.jsx)(n.li,{children:"Setting up custom headers or proxies."}),"\n",(0,i.jsx)(n.li,{children:"For this, you can create a custom server instead of relying only on Next.js\u2019s built-in one."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Important Note (Next.js 13+)"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"In modern versions, Next.js recommends using Middleware, API routes, or Edge Functions instead of custom servers."}),"\n",(0,i.jsx)(n.li,{children:"But for self-hosted apps (not Vercel) or legacy apps, custom servers are still useful."}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"setting-up-a-custom-server",children:"Setting Up a Custom Server"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Install Dependencies"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"npm install next react react-dom express@4\r\nnpm install --save-dev typescript @types/node @types/react @types/react-dom @types/express ts-node nodemon\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["Update ",(0,i.jsx)(n.code,{children:"package.json"})," Scripts"]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'"scripts": {\r\n  "dev": "nodemon --watch server.ts --exec ts-node server.ts",\r\n  "build": "next build",\r\n  "start": "NODE_ENV=production node dist/server.js"\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"dev"})," \u2192 runs your custom server in development mode (with hot reload)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"build"})," \u2192 compiles your Next.js app."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"start"})," \u2192 runs the compiled server in production."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["Write ",(0,i.jsx)(n.code,{children:"server.ts"})]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'import express, { type Request, type Response } from "express";\r\nimport next from "next";\r\n\r\nconst dev = process.env.NODE_ENV !== "production";\r\nconst app = next({ dev });\r\nconst handle = app.getRequestHandler(); // Next.js request handler\r\n\r\napp.prepare().then(() => {\r\n  const server = express();\r\n\r\n  server.get("/p/:id", (req: Request, res: Response) => {\r\n    app.render(req, res, "/post", { id: req.params.id });\r\n  });\r\n\r\n  server.get("/hello", (_req: Request, res: Response) => {\r\n    res.send("Hello from custom server!");\r\n  });\r\n\r\n  // Express 5 compatible catch-all\r\n  server.all(/.*/, (req: Request, res: Response) => handle(req, res));\r\n\r\n  server.listen(3000, (err?: Error) => {\r\n    if (err) throw err;\r\n    console.log("\ud83d\ude80 Server running at http://localhost:3000");\r\n  });\r\n});\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"next({ dev })"})," \u2192 Initializes Next.js in dev or production mode."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"app.prepare()"})," \u2192 Prepares Next.js to handle requests."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"handle"})," \u2192 Next.js\u2019s built-in request handler (used for normal pages/static files)."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"server.get('/p/:id')"})," \u2192 Custom Express route mapping ",(0,i.jsx)(n.code,{children:"/p/:id"})," \u2192 Next.js ",(0,i.jsx)(n.code,{children:"/post"})," page."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"server.all('*')"})," \u2192 For all other routes, fall back to Next.js default handler."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"when-to-use-custom-server",children:"When to Use Custom Server?"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Use it if you need:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Custom routing logic (rewrites, redirects, slugs)."}),"\n",(0,i.jsx)(n.li,{children:"Middleware (auth, logging, analytics)."}),"\n",(0,i.jsx)(n.li,{children:"Integration with Express/Koa backend APIs."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Avoid it if:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"You\u2019re deploying to Vercel \u2192 Vercel does not support custom servers."}),"\n",(0,i.jsxs)(n.li,{children:["You only need rewrites/redirects \u2192 Use ",(0,i.jsx)(n.code,{children:"next.config.js"})," instead."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"differences-vs-default-nextjs-server",children:"Differences vs. Default Next.js Server"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Feature"}),(0,i.jsxs)(n.th,{children:["Default Server (",(0,i.jsx)(n.code,{children:"next start"}),")"]}),(0,i.jsx)(n.th,{children:"Custom Server"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Routing"}),(0,i.jsx)(n.td,{children:"Automatic (file-based)"}),(0,i.jsx)(n.td,{children:"Manual + Next.js handler"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Middleware"}),(0,i.jsx)(n.td,{children:"Not supported"}),(0,i.jsx)(n.td,{children:"Fully supported (Express/Koa etc.)"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Vercel support"}),(0,i.jsx)(n.td,{children:"\u2705 Yes"}),(0,i.jsx)(n.td,{children:"\u274c No"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Deployment complexity"}),(0,i.jsx)(n.td,{children:"Easy"}),(0,i.jsx)(n.td,{children:"Higher (manage yourself)"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"custom-server-configuration",children:"Custom Server Configuration"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"next.config.js"})," is a configuration file at the root of your Next.js project."]}),"\n",(0,i.jsx)(n.li,{children:"It allows you to customize Next.js\u2019s default behavior without modifying the framework itself."}),"\n",(0,i.jsxs)(n.li,{children:["Common use cases:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Adding environment variables"}),"\n",(0,i.jsx)(n.li,{children:"Configuring custom webpack settings"}),"\n",(0,i.jsx)(n.li,{children:"Enabling experimental features"}),"\n",(0,i.jsx)(n.li,{children:"Optimizing images, redirects, and rewrites"}),"\n",(0,i.jsx)(n.li,{children:"Setting internationalization (i18n)"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Think of it as the central place to tweak how Next.js works."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"/** @type {import('next').NextConfig} */\r\nconst nextConfig = {\r\n  reactStrictMode: true, // Enable React strict mode\r\n  swcMinify: true, // Use SWC for faster builds\r\n};\r\n\r\nmodule.exports = nextConfig;\n"})}),"\n",(0,i.jsx)(n.p,{children:"This enables React strict mode (catches potential problems) and SWC minification for faster builds."}),"\n",(0,i.jsx)(n.h3,{id:"common-custom-configurations",children:"Common Custom Configurations"}),"\n",(0,i.jsx)(n.h4,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,i.jsx)(n.p,{children:"You can define public and server-side environment variables."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const nextConfig = {\r\n  env: {\r\n    CUSTOM_API_URL: "https://api.example.com",\r\n  },\r\n};\r\n\r\nmodule.exports = nextConfig;\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Accessible in your code: ",(0,i.jsx)(n.code,{children:"console.log(process.env.CUSTOM_API_URL)"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"env"})," variables are exposed to the browser too. For server-only secrets, use ",(0,i.jsx)(n.code,{children:".env.local"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"custom-webpack-config",children:"Custom Webpack Config"}),"\n",(0,i.jsx)(n.p,{children:"Modify Webpack to add loaders or plugins."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const nextConfig = {\r\n  webpack: (config, { isServer }) => {\r\n    // Example: Add a rule for SVG imports\r\n    config.module.rules.push({\r\n      test: /\\.svg$/,\r\n      use: ["@svgr/webpack"],\r\n    });\r\n\r\n    return config;\r\n  },\r\n};\r\n\r\nmodule.exports = nextConfig;\n'})}),"\n",(0,i.jsx)(n.p,{children:"This lets you import SVGs as React components:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'import Logo from "@/public/logo.svg";\r\nexport default function Home() {\r\n  return <Logo />;\r\n}\n'})}),"\n",(0,i.jsx)(n.h4,{id:"redirects",children:"Redirects"}),"\n",(0,i.jsx)(n.p,{children:"Define server-side redirects."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const nextConfig = {\r\n  async redirects() {\r\n    return [\r\n      {\r\n        source: "/old-blog/:slug*",\r\n        destination: "/new-blog/:slug*",\r\n        permanent: true,\r\n      },\r\n    ];\r\n  },\r\n};\r\n\r\nmodule.exports = nextConfig;\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Visiting ",(0,i.jsx)(n.code,{children:"/old-blog/hello-world"})," \u2192 Redirects to ",(0,i.jsx)(n.code,{children:"/new-blog/hello-world"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"rewrites",children:"Rewrites"}),"\n",(0,i.jsx)(n.p,{children:"Rewrites allow you to mask an API endpoint with a different URL."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const nextConfig = {\r\n  async rewrites() {\r\n    return [\r\n      {\r\n        source: "/api/:path*",\r\n        destination: "https://external-api.com/:path*",\r\n      },\r\n    ];\r\n  },\r\n};\r\n\r\nmodule.exports = nextConfig;\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Visiting ",(0,i.jsx)(n.code,{children:"/api/users"})," \u2192 Internally fetches from ",(0,i.jsx)(n.code,{children:"https://external-api.com/users"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"headers",children:"Headers"}),"\n",(0,i.jsx)(n.p,{children:"Set custom HTTP headers (e.g., security headers)."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const nextConfig = {\r\n  async headers() {\r\n    return [\r\n      {\r\n        source: "/(.*)",\r\n        headers: [\r\n          { key: "X-Frame-Options", value: "DENY" },\r\n          { key: "X-Content-Type-Options", value: "nosniff" },\r\n        ],\r\n      },\r\n    ];\r\n  },\r\n};\r\n\r\nmodule.exports = nextConfig;\n'})}),"\n",(0,i.jsx)(n.p,{children:"This applies headers to all routes."}),"\n",(0,i.jsx)(n.h4,{id:"image-optimization",children:"Image Optimization"}),"\n",(0,i.jsxs)(n.p,{children:["Control domains allowed for ",(0,i.jsx)(n.code,{children:"<Image />"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const nextConfig = {\r\n  images: {\r\n    domains: ["example.com", "cdn.example.org"],\r\n  },\r\n};\r\n\r\nmodule.exports = nextConfig;\n'})}),"\n",(0,i.jsx)(n.p,{children:"Lets you safely load images from external domains."}),"\n",(0,i.jsx)(n.h4,{id:"internationalization-i18n",children:"Internationalization (i18n)"}),"\n",(0,i.jsx)(n.p,{children:"Enable multiple locales."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'const nextConfig = {\r\n  i18n: {\r\n    locales: ["en", "fr", "de"],\r\n    defaultLocale: "en",\r\n  },\r\n};\r\n\r\nmodule.exports = nextConfig;\n'})}),"\n",(0,i.jsx)(n.p,{children:"Adds automatic locale-based routing:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/fr/about"})," \u2192 French version"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"/de/about"})," \u2192 German version"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);