"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[759],{28453(e,r,n){n.d(r,{R:()=>t,x:()=>o});var s=n(96540);const i={},a=s.createContext(i);function t(e){const r=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(a.Provider,{value:r},e.children)}},84470(e,r,n){n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>t,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"prisma/Advanced Query","title":"Advanced Query","description":"Aggregations","source":"@site/docs/prisma/6. Advanced Query.md","sourceDirName":"prisma","slug":"/prisma/Advanced Query","permalink":"/handbook/docs/prisma/Advanced Query","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"sidebar_position":6},"sidebar":"prismaApiSidebar","previous":{"title":"Prisma Client","permalink":"/handbook/docs/prisma/Prisma Client"},"next":{"title":"Middleware","permalink":"/handbook/docs/prisma/Middleware"}}');var i=n(74848),a=n(28453);const t={sidebar_position:6},o=void 0,d={},l=[{value:"Aggregations",id:"aggregations",level:2},{value:"Grouped Aggregations",id:"grouped-aggregations",level:2},{value:"Distinct Queries",id:"distinct-queries",level:2},{value:"Raw Database Queries",id:"raw-database-queries",level:2},{value:"Raw Queries",id:"raw-queries",level:3},{value:"Raw Query Methods",id:"raw-query-methods",level:3},{value:"Safe vs Unsafe Raw Queries",id:"safe-vs-unsafe-raw-queries",level:3}];function c(e){const r={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.h2,{id:"aggregations",children:"Aggregations"}),"\n",(0,i.jsx)(r.p,{children:"These are typically used with:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"prisma.model.aggregate()"})," \u2192 For overall aggregation."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"prisma.model.groupBy()"})," \u2192 For grouped aggregation."]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Basic Aggregations"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"const stats = await prisma.order.aggregate({\r\n  _count: true, // counts all rows\r\n  _avg: {\r\n    quantity: true, // average quantity\r\n    price: true, // average price\r\n  },\r\n  _sum: {\r\n    quantity: true, // total quantity ordered\r\n    price: true, // total sales (sum of price)\r\n  },\r\n  _min: {\r\n    price: true, // minimum price in orders\r\n  },\r\n  _max: {\r\n    price: true, // maximum price in orders\r\n  },\r\n});\n"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Filtering Aggregations"})}),"\n",(0,i.jsxs)(r.p,{children:["You can add ",(0,i.jsx)(r.code,{children:"where"})," conditions to aggregate only a subset."]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:'const electronicsStats = await prisma.order.aggregate({\r\n  where: {\r\n    product: { contains: "Laptop" },\r\n  },\r\n  _count: true,\r\n  _sum: { price: true },\r\n  _avg: { price: true },\r\n});\n'})}),"\n",(0,i.jsx)(r.h2,{id:"grouped-aggregations",children:"Grouped Aggregations"}),"\n",(0,i.jsxs)(r.p,{children:["Prisma\u2019s ",(0,i.jsx)(r.code,{children:"groupBy"})," feature is very similar to SQL\u2019s ",(0,i.jsx)(r.code,{children:"GROUP BY"}),". It allows you to group records by one or more fields and then perform aggregations (",(0,i.jsx)(r.code,{children:"count"}),", ",(0,i.jsx)(r.code,{children:"avg"}),", ",(0,i.jsx)(r.code,{children:"sum"}),", ",(0,i.jsx)(r.code,{children:"min"}),", ",(0,i.jsx)(r.code,{children:"max"}),") within each group."]}),"\n",(0,i.jsx)(r.p,{children:"The general structure is:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"const result = await prisma.model.groupBy({\r\n  by: [\r\n    /* fields to group by */\r\n  ],\r\n  _count: {\r\n    /* fields or _all */\r\n  },\r\n  _avg: {\r\n    /* numeric fields */\r\n  },\r\n  _sum: {\r\n    /* numeric fields */\r\n  },\r\n  _min: {\r\n    /* fields */\r\n  },\r\n  _max: {\r\n    /* fields */\r\n  },\r\n  where: {\r\n    /* optional filters */\r\n  },\r\n  orderBy: {\r\n    /* optional sorting */\r\n  },\r\n  having: {\r\n    /* optional conditions after aggregation */\r\n  },\r\n  take: 10, // optional limit\r\n  skip: 5, // optional offset\r\n});\n"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.strong,{children:"Group by multiple fields"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:'const grouped = await prisma.order.groupBy({\r\n  by: ["product", "createdAt"],\r\n  _count: { _all: true },\r\n  _sum: { price: true },\r\n});\n'})}),"\n",(0,i.jsx)(r.h2,{id:"distinct-queries",children:"Distinct Queries"}),"\n",(0,i.jsxs)(r.p,{children:["The ",(0,i.jsx)(r.code,{children:"distinct"})," option is available in the ",(0,i.jsx)(r.code,{children:"findMany"})," query."]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"const result = await prisma.model.findMany({\r\n  distinct: ['field1', 'field2'],\r\n  where: { ... },     // optional filter\r\n  orderBy: { ... },   // optional sorting\r\n  take: 10,           // optional limit\r\n  skip: 5             // optional offset\r\n});\n"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"distinct: ['field']"})," \u2192 removes duplicate rows based on a single field."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"distinct: ['field1', 'field2']"})," \u2192 removes duplicates based on the combination of multiple fields."]}),"\n",(0,i.jsx)(r.li,{children:"Duplicates are removed at the query level, not after fetching."}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"raw-database-queries",children:"Raw Database Queries"}),"\n",(0,i.jsxs)(r.p,{children:["Prisma provides ",(0,i.jsx)(r.code,{children:"$queryRaw"})," and ",(0,i.jsx)(r.code,{children:"$executeRaw"})," for cases where the Prisma Client API is not enough. These methods allow you to run raw SQL queries directly against the database, while still benefiting from Prisma\u2019s type-safety (when used safely)."]}),"\n",(0,i.jsx)(r.h3,{id:"raw-queries",children:"Raw Queries"}),"\n",(0,i.jsx)(r.p,{children:"Although Prisma\u2019s query engine covers most use cases (CRUD, filtering, aggregations, groupBy), sometimes you need:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Complex SQL joins not supported in Prisma."}),"\n",(0,i.jsxs)(r.li,{children:["Database-specific functions (e.g., ",(0,i.jsx)(r.code,{children:"ILIKE"}),", ",(0,i.jsx)(r.code,{children:"JSONB"})," in Postgres)."]}),"\n",(0,i.jsx)(r.li,{children:"Optimized queries for performance."}),"\n",(0,i.jsx)(r.li,{children:"Running migrations, stored procedures, or advanced reporting."}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"raw-query-methods",children:"Raw Query Methods"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"$queryRaw"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Used for SELECT queries (reading data)."}),"\n",(0,i.jsx)(r.li,{children:"Returns rows from the database."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"$executeRaw"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Used for non-SELECT queries (INSERT, UPDATE, DELETE)."}),"\n",(0,i.jsx)(r.li,{children:"Returns the number of affected rows."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"safe-vs-unsafe-raw-queries",children:"Safe vs Unsafe Raw Queries"}),"\n",(0,i.jsx)(r.p,{children:"Prisma has two forms:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"Safe (Tagged Template) \u2192 Prevents SQL injection."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:'await prisma.$queryRaw`SELECT * FROM "Order" WHERE id = ${orderId}`;\n'})}),"\n",(0,i.jsx)(r.p,{children:"Prisma automatically escapes variables."}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["\n",(0,i.jsx)(r.p,{children:"Unsafe (Function form) \u2192 Use only when necessary."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:"await prisma.$queryRawUnsafe('SELECT * FROM \"Order\" WHERE id = ' + orderId);\n"})}),"\n",(0,i.jsx)(r.p,{children:"Vulnerable if user input is concatenated.Safe vs Unsafe Raw Queries"}),"\n"]}),"\n"]})]})}function u(e={}){const{wrapper:r}={...(0,a.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);