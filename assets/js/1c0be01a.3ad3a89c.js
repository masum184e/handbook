"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[57088],{28453(e,i,n){n.d(i,{R:()=>l,x:()=>d});var r=n(96540);const t={},s=r.createContext(t);function l(e){const i=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function d(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),r.createElement(s.Provider,{value:i},e.children)}},93011(e,i,n){n.r(i),n.d(i,{assets:()=>c,contentTitle:()=>d,default:()=>a,frontMatter:()=>l,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"nginx/Rate Limiting","title":"Rate Limiting","description":"Rate limiting restricts how many requests a client can make to your server within a defined time window.","source":"@site/docs/nginx/18. Rate Limiting.md","sourceDirName":"nginx","slug":"/nginx/Rate Limiting","permalink":"/handbook/docs/nginx/Rate Limiting","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":18,"frontMatter":{},"sidebar":"nginxApiSidebar","previous":{"title":"HTTP to HTTPS","permalink":"/handbook/docs/nginx/HTTP to HTTPS"},"next":{"title":"Connection Limiting","permalink":"/handbook/docs/nginx/Connection Limiting"}}');var t=n(74848),s=n(28453);const l={},d=void 0,c={},o=[{value:"How <code>limit_req</code> Works (Internals)",id:"how-limit_req-works-internals",level:2},{value:"Core Components of <code>limit_req</code>",id:"core-components-of-limit_req",level:2},{value:"<code>limit_req_zone</code> (Define the Rate Limit)",id:"limit_req_zone-define-the-rate-limit",level:3},{value:"<code>limit_req</code> (Apply the Limit)",id:"limit_req-apply-the-limit",level:3},{value:"Basic Example: Global Rate Limiting",id:"basic-example-global-rate-limiting",level:2},{value:"Strict Security Example: Block Bruteforce Logins",id:"strict-security-example-block-bruteforce-logins",level:2},{value:"API Rate Limiting (Recommended Pattern)",id:"api-rate-limiting-recommended-pattern",level:2},{value:"Using Custom Keys (More Secure)",id:"using-custom-keys-more-secure",level:2},{value:"Burst vs No Burst (Security Impact)",id:"burst-vs-no-burst-security-impact",level:2},{value:"Custom Error Response for Rate Limit",id:"custom-error-response-for-rate-limit",level:2},{value:"Combining Rate Limiting with HTTPS",id:"combining-rate-limiting-with-https",level:2},{value:"Common Security Mistakes",id:"common-security-mistakes",level:2},{value:"Rate Limiting Behind Load Balancers",id:"rate-limiting-behind-load-balancers",level:2},{value:"Testing Rate Limiting",id:"testing-rate-limiting",level:2},{value:"<code>limit_req</code> vs <code>limit_conn</code>",id:"limit_req-vs-limit_conn",level:2}];function h(e){const i={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.p,{children:"Rate limiting restricts how many requests a client can make to your server within a defined time window."}),"\n",(0,t.jsxs)(i.p,{children:["In NGINX, this is implemented using the ",(0,t.jsx)(i.code,{children:"limit_req"})," module, which protects against:"]}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"Brute-force login attacks"}),"\n",(0,t.jsx)(i.li,{children:"DDoS and HTTP flood attacks"}),"\n",(0,t.jsx)(i.li,{children:"API abuse"}),"\n",(0,t.jsx)(i.li,{children:"Excessive bot traffic"}),"\n",(0,t.jsx)(i.li,{children:"Resource exhaustion"}),"\n"]}),"\n",(0,t.jsxs)(i.h2,{id:"how-limit_req-works-internals",children:["How ",(0,t.jsx)(i.code,{children:"limit_req"})," Works (Internals)"]}),"\n",(0,t.jsx)(i.p,{children:"NGINX uses the leaky bucket algorithm:"}),"\n",(0,t.jsxs)(i.ol,{children:["\n",(0,t.jsx)(i.li,{children:"Each client (IP, user, token, etc.) has a \u201cbucket\u201d"}),"\n",(0,t.jsx)(i.li,{children:"Requests add water to the bucket"}),"\n",(0,t.jsxs)(i.li,{children:["Water leaks out at a fixed rate (",(0,t.jsx)(i.code,{children:"rate"}),")"]}),"\n",(0,t.jsx)(i.li,{children:"If the bucket overflows \u2192 request is delayed or rejected"}),"\n"]}),"\n",(0,t.jsx)(i.p,{children:"Key idea:"}),"\n",(0,t.jsxs)(i.blockquote,{children:["\n",(0,t.jsx)(i.p,{children:"Requests are allowed at a steady rate, with controlled bursts."}),"\n"]}),"\n",(0,t.jsxs)(i.h2,{id:"core-components-of-limit_req",children:["Core Components of ",(0,t.jsx)(i.code,{children:"limit_req"})]}),"\n",(0,t.jsxs)(i.h3,{id:"limit_req_zone-define-the-rate-limit",children:[(0,t.jsx)(i.code,{children:"limit_req_zone"})," (Define the Rate Limit)"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;\n"})}),"\n",(0,t.jsxs)(i.table,{children:[(0,t.jsx)(i.thead,{children:(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.th,{children:"Part"}),(0,t.jsx)(i.th,{children:"Meaning"})]})}),(0,t.jsxs)(i.tbody,{children:[(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"$binary_remote_addr"})}),(0,t.jsx)(i.td,{children:"Client identifier (IP address)"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"zone=api_limit:10m"})}),(0,t.jsx)(i.td,{children:"Shared memory zone (10 MB)"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"rate=10r/s"})}),(0,t.jsx)(i.td,{children:"10 requests per second per client"})]})]})]}),"\n",(0,t.jsx)(i.p,{children:"10 MB \u2248 160,000 unique IPs"}),"\n",(0,t.jsxs)(i.h3,{id:"limit_req-apply-the-limit",children:[(0,t.jsx)(i.code,{children:"limit_req"})," (Apply the Limit)"]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"limit_req zone=api_limit burst=20 nodelay;\n"})}),"\n",(0,t.jsxs)(i.table,{children:[(0,t.jsx)(i.thead,{children:(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.th,{children:"Option"}),(0,t.jsx)(i.th,{children:"Purpose"})]})}),(0,t.jsxs)(i.tbody,{children:[(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"zone"})}),(0,t.jsx)(i.td,{children:"Which rate limit to apply"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"burst"})}),(0,t.jsx)(i.td,{children:"Allow short traffic spikes"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"nodelay"})}),(0,t.jsx)(i.td,{children:"Reject excess immediately"})]})]})]}),"\n",(0,t.jsx)(i.h2,{id:"basic-example-global-rate-limiting",children:"Basic Example: Global Rate Limiting"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"http {\r\n    limit_req_zone $binary_remote_addr zone=global:10m rate=5r/s;\r\n\r\n    server {\r\n        listen 80;\r\n\r\n        location / {\r\n            limit_req zone=global burst=10;\r\n            proxy_pass http://backend;\r\n        }\r\n    }\r\n}\n"})}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"5 requests/sec allowed per IP"}),"\n",(0,t.jsx)(i.li,{children:"Up to 10 extra requests queued"}),"\n",(0,t.jsx)(i.li,{children:"Excess requests are delayed"}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"strict-security-example-block-bruteforce-logins",children:"Strict Security Example: Block Bruteforce Logins"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;\r\n\r\nserver {\r\n    listen 443 ssl;\r\n\r\n    location /login {\r\n        limit_req zone=login burst=3 nodelay;\r\n        proxy_pass http://auth_backend;\r\n    }\r\n}\n"})}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"Max 1 request per second"}),"\n",(0,t.jsx)(i.li,{children:"Burst of 3 attempts"}),"\n",(0,t.jsx)(i.li,{children:"Excess requests \u2192 HTTP 503"}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"api-rate-limiting-recommended-pattern",children:"API Rate Limiting (Recommended Pattern)"}),"\n",(0,t.jsx)(i.p,{children:"Define Limit per Client"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"limit_req_zone $binary_remote_addr zone=api:20m rate=20r/s;\n"})}),"\n",(0,t.jsx)(i.p,{children:"Apply to API Endpoints"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"location /api/ {\r\n    limit_req zone=api burst=40 nodelay;\r\n    proxy_pass http://api_backend;\r\n}\n"})}),"\n",(0,t.jsx)(i.p,{children:"Result:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"20 requests/sec"}),"\n",(0,t.jsx)(i.li,{children:"Burst up to 40"}),"\n",(0,t.jsx)(i.li,{children:"Hard limit beyond burst"}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"using-custom-keys-more-secure",children:"Using Custom Keys (More Secure)"}),"\n",(0,t.jsx)(i.p,{children:"Rate Limit by API Key Header"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"limit_req_zone $http_x_api_key zone=api_key:10m rate=10r/s;\n"})}),"\n",(0,t.jsx)(i.p,{children:"If header is missing \u2192 all requests share the same bucket"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"Useful for authenticated APIs"}),"\n",(0,t.jsx)(i.li,{children:"Better than IP-based limiting"}),"\n"]}),"\n",(0,t.jsx)(i.h2,{id:"burst-vs-no-burst-security-impact",children:"Burst vs No Burst (Security Impact)"}),"\n",(0,t.jsxs)(i.table,{children:[(0,t.jsx)(i.thead,{children:(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.th,{children:"Config"}),(0,t.jsx)(i.th,{children:"Behavior"})]})}),(0,t.jsxs)(i.tbody,{children:[(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"burst=0"})}),(0,t.jsx)(i.td,{children:"Hard limit"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"burst=10"})}),(0,t.jsx)(i.td,{children:"Allows short spikes"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:(0,t.jsx)(i.code,{children:"burst=10 nodelay"})}),(0,t.jsx)(i.td,{children:"Reject excess immediately"})]})]})]}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"limit_req zone=api burst=10 nodelay;\n"})}),"\n",(0,t.jsx)(i.p,{children:"Best for security-critical endpoints"}),"\n",(0,t.jsx)(i.h2,{id:"custom-error-response-for-rate-limit",children:"Custom Error Response for Rate Limit"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"limit_req_status 429;\r\n\r\nlocation /api/ {\r\n    limit_req zone=api burst=20;\r\n}\n"})}),"\n",(0,t.jsx)(i.p,{children:"Returns HTTP 429 Too Many Requests"}),"\n",(0,t.jsx)(i.h2,{id:"combining-rate-limiting-with-https",children:"Combining Rate Limiting with HTTPS"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"server {\r\n    listen 443 ssl;\r\n\r\n    ssl_certificate     /path/fullchain.pem;\r\n    ssl_certificate_key /path/privkey.pem;\r\n\r\n    location /api/ {\r\n        limit_req zone=api burst=20 nodelay;\r\n        proxy_pass http://backend;\r\n    }\r\n}\n"})}),"\n",(0,t.jsx)(i.h2,{id:"common-security-mistakes",children:"Common Security Mistakes"}),"\n",(0,t.jsxs)(i.table,{children:[(0,t.jsx)(i.thead,{children:(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.th,{children:"Mistake"}),(0,t.jsx)(i.th,{children:"Risk"})]})}),(0,t.jsxs)(i.tbody,{children:[(0,t.jsxs)(i.tr,{children:[(0,t.jsxs)(i.td,{children:["Using ",(0,t.jsx)(i.code,{children:"$remote_addr"})," instead of ",(0,t.jsx)(i.code,{children:"$binary_remote_addr"})]}),(0,t.jsx)(i.td,{children:"Higher memory usage"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsxs)(i.td,{children:["No rate limiting on ",(0,t.jsx)(i.code,{children:"/login"})]}),(0,t.jsx)(i.td,{children:"Brute-force vulnerability"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsxs)(i.td,{children:["Too high ",(0,t.jsx)(i.code,{children:"burst"})]}),(0,t.jsx)(i.td,{children:"Ineffective protection"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsxs)(i.td,{children:["No ",(0,t.jsx)(i.code,{children:"limit_req_status"})]}),(0,t.jsx)(i.td,{children:"Poor monitoring"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:"IP-only limits behind proxy"}),(0,t.jsx)(i.td,{children:"All users share one bucket"})]})]})]}),"\n",(0,t.jsx)(i.h2,{id:"rate-limiting-behind-load-balancers",children:"Rate Limiting Behind Load Balancers"}),"\n",(0,t.jsx)(i.p,{children:"Fix Real Client IP"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"set_real_ip_from 10.0.0.0/8;\r\nreal_ip_header X-Forwarded-For;\n"})}),"\n",(0,t.jsx)(i.p,{children:"Then use:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"limit_req_zone $binary_remote_addr zone=realip:10m rate=5r/s;\n"})}),"\n",(0,t.jsx)(i.h2,{id:"testing-rate-limiting",children:"Testing Rate Limiting"}),"\n",(0,t.jsx)(i.p,{children:"Using curl"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:"for i in {1..20}; do curl -I https://example.com/login; done\n"})}),"\n",(0,t.jsx)(i.p,{children:"Expected:"}),"\n",(0,t.jsxs)(i.ul,{children:["\n",(0,t.jsx)(i.li,{children:"Initial success"}),"\n",(0,t.jsx)(i.li,{children:"Then 429 or 503 errors"}),"\n"]}),"\n",(0,t.jsxs)(i.h2,{id:"limit_req-vs-limit_conn",children:[(0,t.jsx)(i.code,{children:"limit_req"})," vs ",(0,t.jsx)(i.code,{children:"limit_conn"})]}),"\n",(0,t.jsxs)(i.table,{children:[(0,t.jsx)(i.thead,{children:(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.th,{children:"Feature"}),(0,t.jsx)(i.th,{children:"limit_req"}),(0,t.jsx)(i.th,{children:"limit_conn"})]})}),(0,t.jsxs)(i.tbody,{children:[(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:"Limits"}),(0,t.jsx)(i.td,{children:"Request rate"}),(0,t.jsx)(i.td,{children:"Concurrent connections"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:"Use case"}),(0,t.jsx)(i.td,{children:"APIs, login"}),(0,t.jsx)(i.td,{children:"WebSocket, slow clients"})]}),(0,t.jsxs)(i.tr,{children:[(0,t.jsx)(i.td,{children:"Algorithm"}),(0,t.jsx)(i.td,{children:"Leaky bucket"}),(0,t.jsx)(i.td,{children:"Hard counter"})]})]})]})]})}function a(e={}){const{wrapper:i}={...(0,s.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(h,{...e})}):h(e)}}}]);