"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[70204],{13525(e,n,s){s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>h,frontMatter:()=>l,metadata:()=>r,toc:()=>a});const r=JSON.parse('{"id":"nodejs/Event Loop","title":"Event Loop","description":"Node.js uses a single-threaded, non-blocking, asynchronous architecture built on top of libuv.","source":"@site/docs/nodejs/19. Event Loop.md","sourceDirName":"nodejs","slug":"/nodejs/Event Loop","permalink":"/handbook/docs/nodejs/Event Loop","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":19,"frontMatter":{},"sidebar":"nodejsApiSidebar","previous":{"title":"Clustering","permalink":"/handbook/docs/nodejs/Clustering"},"next":{"title":"Database Optimization","permalink":"/handbook/docs/nodejs/Database Optimization"}}');var i=s(74848),o=s(28453);const l={},c=void 0,t={},a=[{value:"Event Loop Phases (In Order)",id:"event-loop-phases-in-order",level:2},{value:"Why Event Loop Understanding Is Critical for Performance",id:"why-event-loop-understanding-is-critical-for-performance",level:2},{value:"Key Performance Principles",id:"key-performance-principles",level:2},{value:"Never Block the Event Loop",id:"never-block-the-event-loop",level:3},{value:"Use Asynchronous APIs",id:"use-asynchronous-apis",level:3},{value:"Understand Microtasks vs Macrotasks",id:"understand-microtasks-vs-macrotasks",level:3},{value:"Warning: <code>process.nextTick()</code> Can Break Performance",id:"warning-processnexttick-can-break-performance",level:3},{value:"Example: Blocking vs Non-Blocking Server",id:"example-blocking-vs-non-blocking-server",level:2},{value:"Example: Using <code>setImmediate()</code> vs <code>setTimeout()</code>",id:"example-using-setimmediate-vs-settimeout",level:2},{value:"Example: Preventing Event Loop Blocking with Worker Threads",id:"example-preventing-event-loop-blocking-with-worker-threads",level:2},{value:"Measuring Event Loop Lag",id:"measuring-event-loop-lag",level:2},{value:"Best Practices Summary",id:"best-practices-summary",level:2}];function d(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Node.js uses a single-threaded, non-blocking, asynchronous architecture built on top of libuv.\r\nThe Event Loop is the mechanism that:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Receives tasks (callbacks, promises, I/O)"}),"\n",(0,i.jsx)(n.li,{children:"Queues them"}),"\n",(0,i.jsx)(n.li,{children:"Executes them in specific phases"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This allows Node.js to handle thousands of concurrent connections efficiently without spawning new threads for each request."}),"\n",(0,i.jsx)(n.h2,{id:"event-loop-phases-in-order",children:"Event Loop Phases (In Order)"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Timers \u2013 Executes callbacks from ",(0,i.jsx)(n.code,{children:"setTimeout()"})," and ",(0,i.jsx)(n.code,{children:"setInterval()"})]}),"\n",(0,i.jsx)(n.li,{children:"I/O callbacks \u2013 Executes I/O-related callbacks"}),"\n",(0,i.jsx)(n.li,{children:"Idle, prepare \u2013 Internal use"}),"\n",(0,i.jsx)(n.li,{children:"Poll \u2013 Retrieves new I/O events, executes I/O callbacks"}),"\n",(0,i.jsxs)(n.li,{children:["Check \u2013 Executes ",(0,i.jsx)(n.code,{children:"setImmediate()"})," callbacks"]}),"\n",(0,i.jsxs)(n.li,{children:["Close callbacks \u2013 Cleanup callbacks (e.g., ",(0,i.jsx)(n.code,{children:"socket.on('close')"}),")"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Additionally:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Microtasks queue runs after every phase:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"process.nextTick()"})}),"\n",(0,i.jsxs)(n.li,{children:["Promise callbacks (",(0,i.jsx)(n.code,{children:".then()"})," / ",(0,i.jsx)(n.code,{children:"await"}),")"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"why-event-loop-understanding-is-critical-for-performance",children:"Why Event Loop Understanding Is Critical for Performance"}),"\n",(0,i.jsx)(n.p,{children:"Poor usage can cause:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Event loop blocking"}),"\n",(0,i.jsx)(n.li,{children:"High latency"}),"\n",(0,i.jsx)(n.li,{children:"Low throughput"}),"\n",(0,i.jsx)(n.li,{children:"Unresponsive servers"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Proper usage ensures:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Fast I/O"}),"\n",(0,i.jsx)(n.li,{children:"High concurrency"}),"\n",(0,i.jsx)(n.li,{children:"Smooth handling of large workloads"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"key-performance-principles",children:"Key Performance Principles"}),"\n",(0,i.jsx)(n.h3,{id:"never-block-the-event-loop",children:"Never Block the Event Loop"}),"\n",(0,i.jsx)(n.p,{children:"Bad:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"while (true) {}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Bad:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"for (let i = 0; i < 1e9; i++) {}\n"})}),"\n",(0,i.jsx)(n.p,{children:"Good:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Break work into chunks"}),"\n",(0,i.jsx)(n.li,{children:"Use async I/O"}),"\n",(0,i.jsx)(n.li,{children:"Offload heavy tasks"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"use-asynchronous-apis",children:"Use Asynchronous APIs"}),"\n",(0,i.jsx)(n.p,{children:"Bad:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'const data = fs.readFileSync("file.txt");\n'})}),"\n",(0,i.jsx)(n.p,{children:"Good:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'fs.readFile("file.txt", (err, data) => {\r\n  console.log(data.toString());\r\n});\n'})}),"\n",(0,i.jsx)(n.p,{children:"Or modern:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'const data = await fs.promises.readFile("file.txt");\n'})}),"\n",(0,i.jsx)(n.h3,{id:"understand-microtasks-vs-macrotasks",children:"Understand Microtasks vs Macrotasks"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'console.log("Start");\r\n\r\nsetTimeout(() => console.log("Timeout"), 0);\r\nsetImmediate(() => console.log("Immediate"));\r\n\r\nPromise.resolve().then(() => console.log("Promise"));\r\nprocess.nextTick(() => console.log("NextTick"));\r\n\r\nconsole.log("End");\n'})}),"\n",(0,i.jsx)(n.p,{children:"Output order:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Start\r\nEnd\r\nNextTick\r\nPromise\r\nTimeout\r\nImmediate\n"})}),"\n",(0,i.jsx)(n.p,{children:"Why?"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"process.nextTick()"})," runs before promises."]}),"\n",(0,i.jsx)(n.li,{children:"Promises run before timers."}),"\n",(0,i.jsx)(n.li,{children:"Timers usually run before setImmediate()."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Misusing ",(0,i.jsx)(n.code,{children:"process.nextTick()"})," can starve the event loop."]}),"\n",(0,i.jsxs)(n.h3,{id:"warning-processnexttick-can-break-performance",children:["Warning: ",(0,i.jsx)(n.code,{children:"process.nextTick()"})," Can Break Performance"]}),"\n",(0,i.jsx)(n.p,{children:"Bad:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"function recurse() {\r\n  process.nextTick(recurse);\r\n}\r\nrecurse();\n"})}),"\n",(0,i.jsx)(n.p,{children:"This causes event loop starvation \u2014 no I/O or timers can run."}),"\n",(0,i.jsx)(n.h2,{id:"example-blocking-vs-non-blocking-server",children:"Example: Blocking vs Non-Blocking Server"}),"\n",(0,i.jsx)(n.p,{children:"Blocking Version (Bad Performance)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'const http = require("http");\r\n\r\nhttp\r\n  .createServer((req, res) => {\r\n    // Simulate heavy computation\r\n    let sum = 0;\r\n    for (let i = 0; i < 1e9; i++) sum += i;\r\n\r\n    res.end("Done\\n");\r\n  })\r\n  .listen(3000);\n'})}),"\n",(0,i.jsx)(n.p,{children:"One request blocks all others."}),"\n",(0,i.jsx)(n.p,{children:"Non-Blocking Version (Better Performance)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'const http = require("http");\r\n\r\nfunction heavyTaskAsync(callback) {\r\n  let sum = 0;\r\n  let i = 0;\r\n\r\n  function chunk() {\r\n    const start = Date.now();\r\n    while (i < 1e9 && Date.now() - start < 10) {\r\n      sum += i++;\r\n    }\r\n\r\n    if (i < 1e9) {\r\n      setImmediate(chunk); // Yield to event loop\r\n    } else {\r\n      callback(sum);\r\n    }\r\n  }\r\n\r\n  chunk();\r\n}\r\n\r\nhttp\r\n  .createServer((req, res) => {\r\n    heavyTaskAsync((result) => {\r\n      res.end("Done\\n");\r\n    });\r\n  })\r\n  .listen(3000);\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u2714\ufe0f Work is broken into chunks, allowing I/O to continue."}),"\n",(0,i.jsxs)(n.h2,{id:"example-using-setimmediate-vs-settimeout",children:["Example: Using ",(0,i.jsx)(n.code,{children:"setImmediate()"})," vs ",(0,i.jsx)(n.code,{children:"setTimeout()"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'setTimeout(() => console.log("timeout"), 0);\r\nsetImmediate(() => console.log("immediate"));\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Inside an I/O callback, ",(0,i.jsx)(n.code,{children:"setImmediate()"})," runs before ",(0,i.jsx)(n.code,{children:"setTimeout(0)"}),", making it better for deferring execution after I/O:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:'fs.readFile("file.txt", () => {\r\n  setImmediate(() => console.log("Immediate after I/O"));\r\n  setTimeout(() => console.log("Timeout after I/O"), 0);\r\n});\n'})}),"\n",(0,i.jsx)(n.p,{children:"Output:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Immediate after I/O\r\nTimeout after I/O\n"})}),"\n",(0,i.jsx)(n.h2,{id:"example-preventing-event-loop-blocking-with-worker-threads",children:"Example: Preventing Event Loop Blocking with Worker Threads"}),"\n",(0,i.jsx)(n.p,{children:"For heavy CPU work:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"const { Worker } = require('worker_threads');\r\n\r\nfunction runHeavyTask() {\r\n  return new Promise((resolve, reject) => {\r\n    const worker = new Worker('./worker.js');\r\n    worker.on('message', resolve);\r\n    worker.on('error', reject);\r\n  });\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"This offloads CPU work, keeping the event loop responsive."}),"\n",(0,i.jsx)(n.h2,{id:"measuring-event-loop-lag",children:"Measuring Event Loop Lag"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-js",children:"setInterval(() => {\r\n  const start = Date.now();\r\n  setImmediate(() => {\r\n    const lag = Date.now() - start;\r\n    console.log(`Event loop lag: ${lag}ms`);\r\n  });\r\n}, 1000);\n"})}),"\n",(0,i.jsx)(n.p,{children:"High lag indicates blocking code."}),"\n",(0,i.jsx)(n.h2,{id:"best-practices-summary",children:"Best Practices Summary"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Practice"}),(0,i.jsx)(n.th,{children:"Why It Helps"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Avoid sync APIs"}),(0,i.jsx)(n.td,{children:"Prevents blocking"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Chunk heavy work"}),(0,i.jsx)(n.td,{children:"Keeps loop responsive"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Use promises/async"}),(0,i.jsx)(n.td,{children:"Improves I/O throughput"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsxs)(n.td,{children:["Avoid excessive ",(0,i.jsx)(n.code,{children:"nextTick()"})]}),(0,i.jsx)(n.td,{children:"Prevents starvation"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Use workers for CPU tasks"}),(0,i.jsx)(n.td,{children:"Maintains responsiveness"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Monitor event loop lag"}),(0,i.jsx)(n.td,{children:"Detects performance issues"})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453(e,n,s){s.d(n,{R:()=>l,x:()=>c});var r=s(96540);const i={},o=r.createContext(i);function l(e){const n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);