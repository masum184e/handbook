"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[20745],{28453(n,e,i){i.d(e,{R:()=>c,x:()=>o});var t=i(96540);const r={},s=t.createContext(r);function c(n){const e=t.useContext(s);return t.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:c(n.components),t.createElement(s.Provider,{value:e},n.children)}},51785(n,e,i){i.r(e),i.d(e,{assets:()=>l,contentTitle:()=>o,default:()=>a,frontMatter:()=>c,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"nginx/Connection Limiting","title":"Connection Limiting","description":"Connection limiting restricts the number of simultaneous (concurrent) connections a client can open to your NGINX server.","source":"@site/docs/nginx/19. Connection Limiting.md","sourceDirName":"nginx","slug":"/nginx/Connection Limiting","permalink":"/handbook/docs/nginx/Connection Limiting","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":19,"frontMatter":{},"sidebar":"nginxApiSidebar","previous":{"title":"Rate Limiting","permalink":"/handbook/docs/nginx/Rate Limiting"},"next":{"title":"Restricting Access","permalink":"/handbook/docs/nginx/Restricting Access"}}');var r=i(74848),s=i(28453);const c={},o=void 0,l={},d=[{value:"How limit_conn Works (Internals)",id:"how-limit_conn-works-internals",level:2},{value:"Core Directives of limit_conn",id:"core-directives-of-limit_conn",level:2},{value:"<code>limit_conn_zone</code> (Define the Connection Zone)",id:"limit_conn_zone-define-the-connection-zone",level:3},{value:"<code>limit_conn</code> (Apply the Limit)",id:"limit_conn-apply-the-limit",level:3},{value:"<code>limit_conn_status</code> (Custom Status Code)",id:"limit_conn_status-custom-status-code",level:3},{value:"Basic Example: Limit Connections Per IP",id:"basic-example-limit-connections-per-ip",level:2},{value:"Protecting Against Slowloris Attacks",id:"protecting-against-slowloris-attacks",level:2},{value:"Limiting Connections Per Server (Global Cap)",id:"limiting-connections-per-server-global-cap",level:2},{value:"API / WebSocket Connection Limiting",id:"api--websocket-connection-limiting",level:2},{value:"Combining <code>limit_conn</code> with <code>limit_req</code>",id:"combining-limit_conn-with-limit_req",level:2},{value:"Limiting Connections Behind a Load Balancer",id:"limiting-connections-behind-a-load-balancer",level:2},{value:"Common Security Mistakes",id:"common-security-mistakes",level:2},{value:"Testing Connection Limits",id:"testing-connection-limits",level:2},{value:"<code>limit_conn</code> vs <code>limit_req</code>",id:"limit_conn-vs-limit_req",level:2},{value:"Recommended Secure Defaults",id:"recommended-secure-defaults",level:2}];function h(n){const e={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.p,{children:"Connection limiting restricts the number of simultaneous (concurrent) connections a client can open to your NGINX server."}),"\n",(0,r.jsxs)(e.p,{children:["It is implemented using the ",(0,r.jsx)(e.code,{children:"limit_conn"})," module and protects against:"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Slowloris attacks"}),"\n",(0,r.jsx)(e.li,{children:"Connection-flood DDoS attacks"}),"\n",(0,r.jsx)(e.li,{children:"Resource exhaustion (worker connections, memory)"}),"\n",(0,r.jsx)(e.li,{children:"Abuse from bots and crawlers"}),"\n",(0,r.jsx)(e.li,{children:"Misbehaving clients holding connections open"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Key difference from rate limiting:"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"limit_conn"})," limits how many connections are open at the same time, not how many requests are sent per second."]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"how-limit_conn-works-internals",children:"How limit_conn Works (Internals)"}),"\n",(0,r.jsx)(e.p,{children:"NGINX maintains a shared memory counter:"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:"Each new connection increments a counter"}),"\n",(0,r.jsxs)(e.li,{children:["Counter is keyed by:","\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"IP address"}),"\n",(0,r.jsx)(e.li,{children:"Server"}),"\n",(0,r.jsx)(e.li,{children:"Custom variable"}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(e.li,{children:["When the limit is exceeded:","\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Connection is rejected immediately"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.li,{children:"Counter is decremented when the connection closes"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"This is a hard limit (no queuing, no delays)."}),"\n",(0,r.jsx)(e.h2,{id:"core-directives-of-limit_conn",children:"Core Directives of limit_conn"}),"\n",(0,r.jsxs)(e.h3,{id:"limit_conn_zone-define-the-connection-zone",children:[(0,r.jsx)(e.code,{children:"limit_conn_zone"})," (Define the Connection Zone)"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"limit_conn_zone $binary_remote_addr zone=conn_limit:10m;\n"})}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"Component"}),(0,r.jsx)(e.th,{children:"Meaning"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"$binary_remote_addr"})}),(0,r.jsx)(e.td,{children:"Client identifier (IP)"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"zone=conn_limit:10m"})}),(0,r.jsx)(e.td,{children:"Shared memory zone"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"10m"})}),(0,r.jsx)(e.td,{children:"Stores ~160,000 unique keys"})]})]})]}),"\n",(0,r.jsx)(e.p,{children:"Uses binary format \u2192 more memory-efficient"}),"\n",(0,r.jsxs)(e.h3,{id:"limit_conn-apply-the-limit",children:[(0,r.jsx)(e.code,{children:"limit_conn"})," (Apply the Limit)"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"limit_conn conn_limit 10;\n"})}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"Part"}),(0,r.jsx)(e.th,{children:"Meaning"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"conn_limit"})}),(0,r.jsx)(e.td,{children:"Zone name"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"10"})}),(0,r.jsx)(e.td,{children:"Max concurrent connections"})]})]})]}),"\n",(0,r.jsxs)(e.h3,{id:"limit_conn_status-custom-status-code",children:[(0,r.jsx)(e.code,{children:"limit_conn_status"})," (Custom Status Code)"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"limit_conn_status 429;\n"})}),"\n",(0,r.jsx)(e.p,{children:"Default is 503 Service Unavailable"}),"\n",(0,r.jsx)(e.h2,{id:"basic-example-limit-connections-per-ip",children:"Basic Example: Limit Connections Per IP"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"http {\r\n    limit_conn_zone $binary_remote_addr zone=per_ip:10m;\r\n\r\n    server {\r\n        listen 80;\r\n\r\n        location / {\r\n            limit_conn per_ip 10;\r\n        }\r\n    }\r\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Each IP can open 10 concurrent connections"}),"\n",(0,r.jsx)(e.li,{children:"11th connection is rejected"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"protecting-against-slowloris-attacks",children:"Protecting Against Slowloris Attacks"}),"\n",(0,r.jsx)(e.p,{children:"Slowloris holds many connections open with slow headers."}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"limit_conn_zone $binary_remote_addr zone=slowloris:10m;\r\n\r\nserver {\r\n    listen 443 ssl;\r\n\r\n    limit_conn slowloris 5;\r\n\r\n    client_header_timeout 10s;\r\n    client_body_timeout 10s;\r\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Max 5 open connections per IP"}),"\n",(0,r.jsx)(e.li,{children:"Timeouts close slow connections"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"limiting-connections-per-server-global-cap",children:"Limiting Connections Per Server (Global Cap)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"limit_conn_zone $server_name zone=per_server:10m;\r\n\r\nserver {\r\n    listen 80;\r\n    limit_conn per_server 1000;\r\n}\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Backend has limited capacity"}),"\n",(0,r.jsx)(e.li,{children:"You want a hard cap per virtual host"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"api--websocket-connection-limiting",children:"API / WebSocket Connection Limiting"}),"\n",(0,r.jsx)(e.p,{children:"WebSockets keep connections open for a long time."}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"limit_conn_zone $binary_remote_addr zone=ws:10m;\r\n\r\nlocation /ws/ {\r\n    limit_conn ws 2;\r\n    proxy_pass http://ws_backend;\r\n}\n"})}),"\n",(0,r.jsxs)(e.h2,{id:"combining-limit_conn-with-limit_req",children:["Combining ",(0,r.jsx)(e.code,{children:"limit_conn"})," with ",(0,r.jsx)(e.code,{children:"limit_req"})]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"limit_req_zone  $binary_remote_addr zone=req:10m rate=10r/s;\r\nlimit_conn_zone $binary_remote_addr zone=conn:10m;\r\n\r\nserver {\r\n    listen 443 ssl;\r\n\r\n    location /api/ {\r\n        limit_req  zone=req  burst=20 nodelay;\r\n        limit_conn conn 10;\r\n        proxy_pass http://api_backend;\r\n    }\r\n}\n"})}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"Threat"}),(0,r.jsx)(e.th,{children:"Protection"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"HTTP flood"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"limit_req"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Slow clients"}),(0,r.jsx)(e.td,{children:(0,r.jsx)(e.code,{children:"limit_conn"})})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Resource exhaustion"}),(0,r.jsx)(e.td,{children:"Both"})]})]})]}),"\n",(0,r.jsx)(e.h2,{id:"limiting-connections-behind-a-load-balancer",children:"Limiting Connections Behind a Load Balancer"}),"\n",(0,r.jsx)(e.p,{children:"Fix Real Client IP"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"set_real_ip_from 10.0.0.0/8;\r\nreal_ip_header X-Forwarded-For;\n"})}),"\n",(0,r.jsx)(e.p,{children:"Then:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"limit_conn_zone $binary_remote_addr zone=realip:10m;\r\nlimit_conn realip 20;\n"})}),"\n",(0,r.jsx)(e.p,{children:"\ud83d\udccc Without this:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"All users appear as one IP"}),"\n",(0,r.jsx)(e.li,{children:"Limits become useless"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"common-security-mistakes",children:"Common Security Mistakes"}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"Mistake"}),(0,r.jsx)(e.th,{children:"Risk"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Too high connection limit"}),(0,r.jsx)(e.td,{children:"Ineffective protection"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Too low limit"}),(0,r.jsx)(e.td,{children:"Legit users blocked"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Not setting timeouts"}),(0,r.jsx)(e.td,{children:"Slowloris still possible"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"No real IP handling"}),(0,r.jsx)(e.td,{children:"All users share same bucket"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsxs)(e.td,{children:["Only using ",(0,r.jsx)(e.code,{children:"limit_conn"})]}),(0,r.jsx)(e.td,{children:"HTTP floods still succeed"})]})]})]}),"\n",(0,r.jsx)(e.h2,{id:"testing-connection-limits",children:"Testing Connection Limits"}),"\n",(0,r.jsx)(e.p,{children:"Open Multiple Connections"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"ab -n 1000 -c 50 http://example.com/\n"})}),"\n",(0,r.jsx)(e.p,{children:"Expected: Some requests fail with 429 or 503"}),"\n",(0,r.jsx)(e.p,{children:"Check logs"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"error_log /var/log/nginx/error.log notice;\n"})}),"\n",(0,r.jsxs)(e.h2,{id:"limit_conn-vs-limit_req",children:[(0,r.jsx)(e.code,{children:"limit_conn"})," vs ",(0,r.jsx)(e.code,{children:"limit_req"})]}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"Feature"}),(0,r.jsx)(e.th,{children:"limit_conn"}),(0,r.jsx)(e.th,{children:"limit_req"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Limits"}),(0,r.jsx)(e.td,{children:"Concurrent connections"}),(0,r.jsx)(e.td,{children:"Requests per second"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Queueing"}),(0,r.jsx)(e.td,{children:"\u274c No"}),(0,r.jsx)(e.td,{children:"\u2714 Yes"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Best for"}),(0,r.jsx)(e.td,{children:"Slowloris, WebSockets"}),(0,r.jsx)(e.td,{children:"APIs, login endpoints"})]})]})]}),"\n",(0,r.jsx)(e.h2,{id:"recommended-secure-defaults",children:"Recommended Secure Defaults"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"limit_conn_zone $binary_remote_addr zone=conn:10m;\r\nlimit_conn_status 429;\r\n\r\nserver {\r\n    limit_conn conn 10;\r\n    client_header_timeout 10s;\r\n    client_body_timeout 10s;\r\n}\n"})})]})}function a(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(h,{...n})}):h(n)}}}]);