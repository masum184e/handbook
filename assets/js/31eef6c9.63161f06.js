"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[9577],{20288(e,n,i){i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>x,frontMatter:()=>c,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"nginx/Regex","title":"Regex","description":"Regex location matching lets NGINX choose a location block using a regular expression applied to the request URI.","source":"@site/docs/nginx/27. Regex.md","sourceDirName":"nginx","slug":"/nginx/Regex","permalink":"/handbook/docs/nginx/Regex","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":27,"frontMatter":{},"sidebar":"nginxApiSidebar","previous":{"title":"Exact Match","permalink":"/handbook/docs/nginx/Exact Match"},"next":{"title":"Priority Rules","permalink":"/handbook/docs/nginx/Priority Rules"}}');var s=i(74848),l=i(28453);const c={},t=void 0,d={},o=[{value:"Regex Location Modifiers",id:"regex-location-modifiers",level:2},{value:"Case-Sensitive Regex (<code>~</code>)",id:"case-sensitive-regex-",level:2},{value:"Case-Insensitive Regex (~*)",id:"case-insensitive-regex-",level:2},{value:"Location Matching Order (Critical!)",id:"location-matching-order-critical",level:2},{value:"Prefix vs Regex (Who Wins?)",id:"prefix-vs-regex-who-wins",level:2},{value:"Prevent Regex Override with <code>^~</code>",id:"prevent-regex-override-with-",level:2},{value:"Regex Order Matters (First Match Wins)",id:"regex-order-matters-first-match-wins",level:2},{value:"Using Capture Groups in Regex Locations",id:"using-capture-groups-in-regex-locations",level:2},{value:"Regex with rewrite",id:"regex-with-rewrite",level:2},{value:"Common Use Cases",id:"common-use-cases",level:2},{value:"Regex Matching Details You Must Know",id:"regex-matching-details-you-must-know",level:2}];function h(e){const n={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["Regex location matching lets NGINX choose a ",(0,s.jsx)(n.code,{children:"location"})," block using a regular expression applied to the request URI."]}),"\n",(0,s.jsx)(n.p,{children:"It is used when:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Paths follow patterns (file extensions, versions, IDs)"}),"\n",(0,s.jsx)(n.li,{children:"You need case-insensitive matching"}),"\n",(0,s.jsx)(n.li,{children:"Prefix matching is not flexible enough"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"regex-location-modifiers",children:"Regex Location Modifiers"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Modifier"}),(0,s.jsx)(n.th,{children:"Meaning"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"~"})}),(0,s.jsx)(n.td,{children:"Case-sensitive regex match"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"~*"})}),(0,s.jsx)(n.td,{children:"Case-insensitive regex match"})]})]})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ~ pattern {\r\n    ...\r\n}\r\n\r\nlocation ~* pattern {\r\n    ...\r\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pattern"})," is a PCRE regular expression"]}),"\n",(0,s.jsx)(n.li,{children:"Applied to the URI only (query string ignored)"}),"\n",(0,s.jsx)(n.li,{children:"No quotes required"}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"case-sensitive-regex-",children:["Case-Sensitive Regex (",(0,s.jsx)(n.code,{children:"~"}),")"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ~ \\.php$ {\r\n    fastcgi_pass unix:/run/php/php-fpm.sock;\r\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"What it matches"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"URI"}),(0,s.jsx)(n.th,{children:"Match?"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/index.php"})}),(0,s.jsx)(n.td,{children:"Yes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/test.php"})}),(0,s.jsx)(n.td,{children:"Yes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/TEST.PHP"})}),(0,s.jsx)(n.td,{children:"No"})]})]})]}),"\n",(0,s.jsx)(n.p,{children:"Because matching is case-sensitive."}),"\n",(0,s.jsx)(n.h2,{id:"case-insensitive-regex-",children:"Case-Insensitive Regex (~*)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ~* \\.(jpg|jpeg|png|gif)$ {\r\n    expires 30d;\r\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:"What it matches"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"URI"}),(0,s.jsx)(n.th,{children:"Match?"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/img/a.jpg"})}),(0,s.jsx)(n.td,{children:"Yes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/img/A.JPG"})}),(0,s.jsx)(n.td,{children:"Yes"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"/img/b.PnG"})}),(0,s.jsx)(n.td,{children:"Yes"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"location-matching-order-critical",children:"Location Matching Order (Critical!)"}),"\n",(0,s.jsx)(n.p,{children:"NGINX evaluates locations in this order:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Exact match (",(0,s.jsx)(n.code,{children:"location ="}),")"]}),"\n",(0,s.jsx)(n.li,{children:"Prefix match (longest match wins)"}),"\n",(0,s.jsx)(n.li,{children:"Regex match (first match wins)"}),"\n",(0,s.jsxs)(n.li,{children:["Default (",(0,s.jsx)(n.code,{children:"location /"}),")"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Regex locations are evaluated in the order they appear in the config."}),"\n",(0,s.jsx)(n.h2,{id:"prefix-vs-regex-who-wins",children:"Prefix vs Regex (Who Wins?)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location /images/ {\r\n    root /var/www/images;\r\n}\r\n\r\nlocation ~ \\.jpg$ {\r\n    root /var/www/jpg;\r\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Request: ",(0,s.jsx)(n.code,{children:"/images/photo.jpg"})]}),"\n",(0,s.jsxs)(n.li,{children:["Result:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Prefix ",(0,s.jsx)(n.code,{children:"/images/"})," matches"]}),"\n",(0,s.jsxs)(n.li,{children:["Regex ",(0,s.jsx)(n.code,{children:"\\.jpg$"})," also matches"]}),"\n",(0,s.jsx)(n.li,{children:"Regex wins, because it\u2019s checked after prefix"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"prevent-regex-override-with-",children:["Prevent Regex Override with ",(0,s.jsx)(n.code,{children:"^~"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ^~ /images/ {\r\n    root /var/www/images;\r\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Prefix match is selected"}),"\n",(0,s.jsx)(n.li,{children:"Regex is skipped entirely"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"regex-order-matters-first-match-wins",children:"Regex Order Matters (First Match Wins)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'location ~ \\.php$ {\r\n    return 200 "Generic PHP";\r\n}\r\n\r\nlocation ~ /admin/.*\\.php$ {\r\n    return 403;\r\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Request: ",(0,s.jsx)(n.code,{children:"/admin/test.php"})]}),"\n",(0,s.jsxs)(n.li,{children:["Result:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"First regex matches"}),"\n",(0,s.jsx)(n.li,{children:"Access is allowed unintentionally"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Correct order"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'location ~ /admin/.*\\.php$ {\r\n    return 403;\r\n}\r\n\r\nlocation ~ \\.php$ {\r\n    return 200 "Generic PHP";\r\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"using-capture-groups-in-regex-locations",children:"Using Capture Groups in Regex Locations"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ~ ^/api/v(\\d+)/ {\r\n    proxy_pass http://api_v$1_backend;\r\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Request: ",(0,s.jsx)(n.code,{children:"/api/v2/users"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"$1 = 2"})}),"\n",(0,s.jsxs)(n.li,{children:["Proxied to ",(0,s.jsx)(n.code,{children:"api_v2_backend"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"regex-with-rewrite",children:"Regex with rewrite"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ~ ^/old/(.*)$ {\r\n    rewrite ^/old/(.*)$ /new/$1 permanent;\r\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"common-use-cases",children:"Common Use Cases"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"File extension handling"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ~* \\.(css|js)$ {\r\n    expires 7d;\r\n}\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsx)(n.li,{children:"Blocking sensitive files"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ~* \\.(env|log|bak)$ {\r\n    deny all;\r\n}\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"3",children:["\n",(0,s.jsx)(n.li,{children:"Language or version routing"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ~ ^/(en|fr|de)/ {\r\n    root /var/www/lang;\r\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"regex-matching-details-you-must-know",children:"Regex Matching Details You Must Know"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Regex applies to normalized URI"}),"\n",(0,s.jsxs)(n.li,{children:["Query string (",(0,s.jsx)(n.code,{children:"?x=1"}),") is ignored"]}),"\n",(0,s.jsxs)(n.li,{children:["Use ",(0,s.jsx)(n.code,{children:"^"})," and ",(0,s.jsx)(n.code,{children:"$"})," for precision"]}),"\n",(0,s.jsx)(n.li,{children:"Avoid overly complex patterns (performance)"}),"\n"]})]})}function x(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},28453(e,n,i){i.d(n,{R:()=>c,x:()=>t});var r=i(96540);const s={},l=r.createContext(s);function c(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);