"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[4085],{28453(e,n,r){r.d(n,{R:()=>d,x:()=>t});var s=r(96540);const i={},l=s.createContext(i);function d(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),s.createElement(l.Provider,{value:n},e.children)}},80128(e,n,r){r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"nginx/Load Balancing","title":"Load Balancing","description":"When NGINX acts as a reverse proxy, it can distribute incoming requests across multiple backend servers to achieve:","source":"@site/docs/nginx/9. Load Balancing.md","sourceDirName":"nginx","slug":"/nginx/Load Balancing","permalink":"/handbook/docs/nginx/Load Balancing","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":9,"frontMatter":{},"sidebar":"nginxApiSidebar","previous":{"title":"Proxy Headers","permalink":"/handbook/docs/nginx/Reverse Proxy/Proxy Headers"},"next":{"title":"Health Checks","permalink":"/handbook/docs/nginx/Health Checks"}}');var i=r(74848),l=r(28453);const d={},t=void 0,c={},o=[{value:"Round-Robin Load Balancing (Default)",id:"round-robin-load-balancing-default",level:2},{value:"Weighted Round-Robin",id:"weighted-round-robin",level:2},{value:"Least Connections (<code>least_conn</code>)",id:"least-connections-least_conn",level:2},{value:"Weighted Least Connections",id:"weighted-least-connections",level:2},{value:"IP Hash (<code>ip_hash</code>)",id:"ip-hash-ip_hash",level:2},{value:"Choosing the Right Method",id:"choosing-the-right-method",level:2},{value:"Real-World Production Example",id:"real-world-production-example",level:2},{value:"Health &amp; Failover Behavior",id:"health--failover-behavior",level:2}];function a(e){const n={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"When NGINX acts as a reverse proxy, it can distribute incoming requests across multiple backend servers to achieve:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"High availability"}),"\n",(0,i.jsx)(n.li,{children:"Better performance"}),"\n",(0,i.jsx)(n.li,{children:"Scalability"}),"\n",(0,i.jsx)(n.li,{children:"Fault tolerance"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["This is done using an ",(0,i.jsx)(n.code,{children:"upstream"})," block."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Basic Upstream Configuration"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"upstream app_backend {\r\n    server 10.0.0.11:8080;\r\n    server 10.0.0.12:8080;\r\n    server 10.0.0.13:8080;\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"By default, NGINX uses round-robin."}),"\n",(0,i.jsx)(n.h2,{id:"round-robin-load-balancing-default",children:"Round-Robin Load Balancing (Default)"}),"\n",(0,i.jsx)(n.p,{children:"Requests are distributed sequentially across backend servers:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Request 1 \u2192 Server A\r\nRequest 2 \u2192 Server B\r\nRequest 3 \u2192 Server C\r\nRequest 4 \u2192 Server A\n"})}),"\n",(0,i.jsx)(n.p,{children:"Each request goes to the next server in order."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Example Configuration"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"upstream app_backend {\r\n    server 10.0.0.11:8080;\r\n    server 10.0.0.12:8080;\r\n}\r\n\r\nserver {\r\n    listen 80;\r\n\r\n    location / {\r\n        proxy_pass http://app_backend;\r\n    }\r\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["First request \u2192 ",(0,i.jsx)(n.code,{children:"10.0.0.11"})]}),"\n",(0,i.jsxs)(n.li,{children:["Second request \u2192 ",(0,i.jsx)(n.code,{children:"10.0.0.12"})]}),"\n",(0,i.jsxs)(n.li,{children:["Third request \u2192 ",(0,i.jsx)(n.code,{children:"10.0.0.11"})]}),"\n",(0,i.jsx)(n.li,{children:"Even distribution over time"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"weighted-round-robin",children:"Weighted Round-Robin"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"upstream app_backend {\r\n    server 10.0.0.11 weight=3;\r\n    server 10.0.0.12 weight=1;\r\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Server ",(0,i.jsx)(n.code,{children:"10.0.0.11"})," receives 75% of traffic"]}),"\n",(0,i.jsxs)(n.li,{children:["Server ",(0,i.jsx)(n.code,{children:"10.0.0.12"})," receives 25%"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Pros"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Simple"}),"\n",(0,i.jsx)(n.li,{children:"Efficient for similar backends"}),"\n",(0,i.jsx)(n.li,{children:"Default behavior"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Cons"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Does not consider current load"}),"\n",(0,i.jsx)(n.li,{children:"Not ideal for long-running requests"}),"\n"]}),"\n",(0,i.jsxs)(n.h2,{id:"least-connections-least_conn",children:["Least Connections (",(0,i.jsx)(n.code,{children:"least_conn"}),")"]}),"\n",(0,i.jsx)(n.p,{children:"Each new request is sent to the backend with the fewest active connections."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Server A \u2192 10 active connections\r\nServer B \u2192 3 active connections\r\n\u2192 New request goes to Server B\n"})}),"\n",(0,i.jsx)(n.p,{children:"Example Configuration"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"upstream app_backend {\r\n    least_conn;\r\n\r\n    server 10.0.0.11:8080;\r\n    server 10.0.0.12:8080;\r\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"NGINX tracks active connections"}),"\n",(0,i.jsx)(n.li,{children:"New requests go to least busy server"}),"\n",(0,i.jsx)(n.li,{children:"Excellent for uneven or long-lived requests"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"weighted-least-connections",children:"Weighted Least Connections"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"upstream app_backend {\r\n    least_conn;\r\n\r\n    server 10.0.0.11 weight=2;\r\n    server 10.0.0.12 weight=1;\r\n}\n"})}),"\n",(0,i.jsx)(n.p,{children:"NGINX factors weight into decision-making."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Pros"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Adapts to load"}),"\n",(0,i.jsx)(n.li,{children:"Ideal for slow APIs or streaming"}),"\n",(0,i.jsx)(n.li,{children:"Reduces overload"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Cons"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Slightly more overhead"}),"\n",(0,i.jsx)(n.li,{children:"Doesn\u2019t track CPU or memory usage"}),"\n"]}),"\n",(0,i.jsxs)(n.h2,{id:"ip-hash-ip_hash",children:["IP Hash (",(0,i.jsx)(n.code,{children:"ip_hash"}),")"]}),"\n",(0,i.jsx)(n.p,{children:"Client IP address is hashed to select a backend server."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Client IP \u2192 Hash \u2192 Server\n"})}),"\n",(0,i.jsx)(n.p,{children:"Same client IP always maps to the same server (as long as it\u2019s available)."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"upstream app_backend {\r\n    ip_hash;\r\n\r\n    server 10.0.0.11:8080;\r\n    server 10.0.0.12:8080;\r\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Client ",(0,i.jsx)(n.code,{children:"203.0.113.10"})," \u2192 Server A"]}),"\n",(0,i.jsxs)(n.li,{children:["Client ",(0,i.jsx)(n.code,{children:"203.0.113.10"})," \u2192 Server A again"]}),"\n",(0,i.jsx)(n.li,{children:"Enables session persistence (sticky sessions)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Use Case"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Applications that store sessions in memory"}),"\n",(0,i.jsx)(n.li,{children:"Legacy systems without shared session storage"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Limitations"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Uneven distribution with NAT users"}),"\n",(0,i.jsx)(n.li,{children:"Not compatible with weights (fully)"}),"\n",(0,i.jsx)(n.li,{children:"Scaling changes may remap clients"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Pros"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Simple session persistence"}),"\n",(0,i.jsx)(n.li,{children:"No cookies required"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Cons"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Poor distribution with many clients behind NAT"}),"\n",(0,i.jsx)(n.li,{children:"Scaling issues"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"choosing-the-right-method",children:"Choosing the Right Method"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Scenario"}),(0,i.jsx)(n.th,{children:"Best Method"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Identical backends"}),(0,i.jsx)(n.td,{children:"Round-robin"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Long-running requests"}),(0,i.jsx)(n.td,{children:"Least connections"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"In-memory sessions"}),(0,i.jsx)(n.td,{children:"IP hash"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"Modern apps"}),(0,i.jsx)(n.td,{children:"Least_conn + shared sessions"})]})]})]}),"\n",(0,i.jsx)(n.h2,{id:"real-world-production-example",children:"Real-World Production Example"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"upstream web_backend {\r\n    least_conn;\r\n\r\n    server 10.0.0.11:8080 max_fails=3 fail_timeout=30s;\r\n    server 10.0.0.12:8080 max_fails=3 fail_timeout=30s;\r\n}\r\n\r\nserver {\r\n    listen 80;\r\n\r\n    location / {\r\n        proxy_pass http://web_backend;\r\n\r\n        proxy_set_header Host $host;\r\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\r\n    }\r\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Least-loaded server gets traffic"}),"\n",(0,i.jsx)(n.li,{children:"Failed servers temporarily removed"}),"\n",(0,i.jsx)(n.li,{children:"Headers preserve client identity"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"health--failover-behavior",children:"Health & Failover Behavior"}),"\n",(0,i.jsx)(n.p,{children:"NGINX:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Marks server as failed after ",(0,i.jsx)(n.code,{children:"max_fails"})]}),"\n",(0,i.jsxs)(n.li,{children:["Skips it during ",(0,i.jsx)(n.code,{children:"fail_timeout"})]}),"\n",(0,i.jsx)(n.li,{children:"Automatically retries healthy servers"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);