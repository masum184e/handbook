"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[25532],{28453(e,n,s){s.d(n,{R:()=>d,x:()=>c});var r=s(96540);const i={},l=r.createContext(i);function d(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),r.createElement(l.Provider,{value:n},e.children)}},77923(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>h,frontMatter:()=>d,metadata:()=>r,toc:()=>t});const r=JSON.parse('{"id":"expressjs/Middleware","title":"Middleware","description":"In Express.js, middleware are functions that run during the request-response lifecycle.","source":"@site/docs/expressjs/4. Middleware.md","sourceDirName":"expressjs","slug":"/expressjs/Middleware","permalink":"/handbook/docs/expressjs/Middleware","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"title":"Middleware","sidebar_position":4},"sidebar":"expressSidebar","previous":{"title":"Routing","permalink":"/handbook/docs/expressjs/Routing"},"next":{"title":"Response","permalink":"/handbook/docs/expressjs/Response"}}');var i=s(74848),l=s(28453);const d={title:"Middleware",sidebar_position:4},c=void 0,o={},t=[{value:"Key Features",id:"key-features",level:2},{value:"Types of Middleware in Express",id:"types-of-middleware-in-express",level:2},{value:"1. Application-level middleware",id:"1-application-level-middleware",level:3},{value:"2. Built-in middleware",id:"2-built-in-middleware",level:3},{value:"3. Router-level middleware",id:"3-router-level-middleware",level:3},{value:"4. Third-party middleware",id:"4-third-party-middleware",level:3},{value:"5. Error-handling middleware",id:"5-error-handling-middleware",level:3},{value:"Middleware Flow",id:"middleware-flow",level:3},{value:"How Middleware Works",id:"how-middleware-works",level:2},{value:"Built-In Middleware",id:"built-in-middleware",level:2},{value:"Third-Party Middleware",id:"third-party-middleware",level:2},{value:"Morgan (HTTP request logger)",id:"morgan-http-request-logger",level:3},{value:"CORS (Cross-Origin Resource Sharing)",id:"cors-cross-origin-resource-sharing",level:3},{value:"Helmet (Security)",id:"helmet-security",level:3},{value:"Middleware Execution Order",id:"middleware-execution-order",level:2}];function a(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"In Express.js, middleware are functions that run during the request-response lifecycle."}),"\n",(0,i.jsx)(n.p,{children:"These functions can:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Modify the ",(0,i.jsx)(n.code,{children:"request"})," and resp`onse objects"]}),"\n",(0,i.jsx)(n.li,{children:"Execute code or perform operations"}),"\n",(0,i.jsx)(n.li,{children:"End the request-response cycle"}),"\n",(0,i.jsx)(n.li,{children:"Pass control to the next middleware function in the stack"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"In short, middleware process incoming requests before they reach your route handlers, allowing you to handle tasks like logging, authentication, or data parsing in a centralized way."}),"\n",(0,i.jsx)(n.h2,{id:"key-features",children:"Key Features"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Function Signature:"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"function middleware(req, res, next) {\r\n  // Your custom logic here\r\n  next(); // Call the next middleware in the stack\r\n}\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"req"}),": The request object."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"res"}),": The response object."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"next()"})," \u2192 A function that calls the next middleware.","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If you don\u2019t call ",(0,i.jsx)(n.code,{children:"next()"}),", the request will hang (no response)."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Stacking:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Middleware functions are stacked and executed in the order they are defined in the application."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Tasks Middleware Can Perform:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Execute any code."}),"\n",(0,i.jsxs)(n.li,{children:["Modify the request (",(0,i.jsx)(n.code,{children:"req"}),") or response (",(0,i.jsx)(n.code,{children:"res"}),") objects."]}),"\n",(0,i.jsx)(n.li,{children:"End the request-response cycle (e.g., sending a response)."}),"\n",(0,i.jsxs)(n.li,{children:["Call the ",(0,i.jsx)(n.code,{children:"next()"})," function to pass control to the next middleware."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"types-of-middleware-in-express",children:"Types of Middleware in Express"}),"\n",(0,i.jsx)(n.p,{children:"Middleware functions are executed in the order they are defined. They can run for every request, specific routes, or handle errors."}),"\n",(0,i.jsx)(n.h3,{id:"1-application-level-middleware",children:"1. Application-level middleware"}),"\n",(0,i.jsxs)(n.p,{children:["Defined globally with ",(0,i.jsx)(n.code,{children:"app.use()"}),", runs for every request."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'import express, { Request, Response, NextFunction } from "express";\r\nconst app = express();\r\n\r\napp.use((req: Request, res: Response, next: NextFunction) => {\r\n  console.log(`${req.method} request \u2192 ${req.url}`);\r\n  next(); // Continue to the next middleware or route handler\r\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"2-built-in-middleware",children:"2. Built-in middleware"}),"\n",(0,i.jsxs)(n.p,{children:["Express provides ready-to-use middleware like ",(0,i.jsx)(n.code,{children:"express.json()"})," and ",(0,i.jsx)(n.code,{children:"express.static()"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"// Parses incoming JSON request bodies\r\napp.use(express.json());\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-router-level-middleware",children:"3. Router-level middleware"}),"\n",(0,i.jsx)(n.p,{children:"Runs only on specific routes or routers."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'app.get(\r\n  "/about",\r\n  (req: Request, res: Response, next: NextFunction) => {\r\n    console.log("Middleware specific to /about");\r\n    next();\r\n  },\r\n  (req: Request, res: Response) => {\r\n    res.send("About Page");\r\n  }\r\n);\n'})}),"\n",(0,i.jsx)(n.h3,{id:"4-third-party-middleware",children:"4. Third-party middleware"}),"\n",(0,i.jsxs)(n.p,{children:["Installed via npm, e.g., ",(0,i.jsx)(n.code,{children:"cookie-parser"}),", ",(0,i.jsx)(n.code,{children:"morgan"}),", ",(0,i.jsx)(n.code,{children:"cors"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'import morgan from "morgan";\r\napp.use(morgan("dev")); // Logs HTTP requests\n'})}),"\n",(0,i.jsx)(n.h3,{id:"5-error-handling-middleware",children:"5. Error-handling middleware"}),"\n",(0,i.jsx)(n.p,{children:"Special middleware with 4 parameters. Must be placed after all routes."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'app.use((err: Error, req: Request, res: Response, next: NextFunction) => {\r\n  console.error("Error:", err.message);\r\n  res.status(500).send("Something went wrong!");\r\n});\n'})}),"\n",(0,i.jsx)(n.h3,{id:"middleware-flow",children:"Middleware Flow"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Incoming request \u2192 application-level middleware"}),"\n",(0,i.jsx)(n.li,{children:"Passes through built-in/third-party middleware"}),"\n",(0,i.jsx)(n.li,{children:"Runs router-level middleware (if any)"}),"\n",(0,i.jsx)(n.li,{children:"Executes route handler"}),"\n",(0,i.jsx)(n.li,{children:"If errors occur \u2192 handled by error-handling middleware"}),"\n",(0,i.jsx)(n.li,{children:"Sends response back to client"}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"how-middleware-works",children:"How Middleware Works"}),"\n",(0,i.jsxs)(n.p,{children:["When a request is sent to the server, Express processes it through the middleware stack. Middleware functions are executed sequentially in the order they are defined. If a middleware function calls ",(0,i.jsx)(n.code,{children:"next()"}),", the next function in the stack is executed. If a middleware function doesn\u2019t call ",(0,i.jsx)(n.code,{children:"next()"}),", the request-response cycle is terminated."]}),"\n",(0,i.jsx)(n.h2,{id:"built-in-middleware",children:"Built-In Middleware"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"express.json()"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Parses incoming JSON payloads and makes the data available in ",(0,i.jsx)(n.code,{children:"req.body"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"app.use(express.json());\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"express.urlencoded()"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Parses incoming requests with URL-encoded payloads (",(0,i.jsx)(n.code,{children:"Content-Type: application/x-www-form-urlencoded"}),") (like form submissions) and makes the data available in req.body."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"app.use(express.urlencoded({ extended: true })); // Parse URL-encoded form data\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Takes an option:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"{ extended: true }"})," \u2192 allows nested objects using ",(0,i.jsx)(n.code,{children:"qs"})," library."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"{ extended: false }"})," \u2192 only supports simple key-value pairs."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"express.static()"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Serves static files like images, CSS, and JavaScript."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'app.use(express.static(path.join(__dirname, "public")));\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"express.text()"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Parses incoming requests with text payloads and makes the text available in ",(0,i.jsx)(n.code,{children:"req.body"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"app.use(express.text());\n"})}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"express.raw()"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Parses incoming requests with binary payloads and makes the raw buffer available in ",(0,i.jsx)(n.code,{children:"req.body"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'app.use(express.raw({ type: "application/octet-stream" }));\n'})}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"third-party-middleware",children:"Third-Party Middleware"}),"\n",(0,i.jsx)(n.h3,{id:"morgan-http-request-logger",children:"Morgan (HTTP request logger)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Logs HTTP requests in the console (or a file)."}),"\n",(0,i.jsx)(n.li,{children:"Useful for debugging and monitoring."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'app.use(morgan("dev"));\n'})}),"\n",(0,i.jsx)(n.p,{children:"Logs incoming HTTP requests in a short colored format."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"GET /users 200 12ms\r\nPOST /login 201 25ms\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Format options"})}),"\n",(0,i.jsxs)(n.p,{children:["When you call ",(0,i.jsx)(n.code,{children:"morgan()"}),", you must provide a format argument.\r\nThis defines how logs are displayed."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Built-in strings:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:'"combined"'})," \u2192 Apache-style logs (with referrer & user-agent)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:'"common"'})," \u2192 Shorter Apache-style logs"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:'"dev"'})," \u2192 Color-coded concise logs"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:'"short"'})," \u2192 Shorter than common"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:'"tiny"'})," \u2192 Minimal output"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Or, you can pass a formatting function: ",(0,i.jsx)(n.code,{children:"(tokens, req, res) => string"})]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"cors-cross-origin-resource-sharing",children:"CORS (Cross-Origin Resource Sharing)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Controls which domains can access your API."}),"\n",(0,i.jsx)(n.li,{children:"By default, browsers block requests from different origins."}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"cors()"})," middleware allows you to enable or restrict access."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'app.use(cors()); // Allow all origins\r\napp.use(cors({ origin: "https://example.com" })); // Restrict to specific domain\n'})}),"\n",(0,i.jsx)(n.h3,{id:"helmet-security",children:"Helmet (Security)"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Sets HTTP headers to secure your app from common attacks."}),"\n",(0,i.jsxs)(n.li,{children:["Examples of headers it sets:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"X-DNS-Prefetch-Control"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"X-Frame-Options"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"Strict-Transport-Security"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Simple way to improve security best practices."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:"app.use(helmet());\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Adds multiple security-related HTTP headers automatically."}),"\n",(0,i.jsx)(n.li,{children:"Helps prevent common attacks like clickjacking, XSS, and MIME-sniffing."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"middleware-execution-order",children:"Middleware Execution Order"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Middleware functions in Express execute in the order they are added in your code."}),"\n",(0,i.jsxs)(n.li,{children:["The request flows top to bottom until:","\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["A response is sent (",(0,i.jsx)(n.code,{children:"res.send"}),", ",(0,i.jsx)(n.code,{children:"res.json"}),", etc.), or"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"next()"})," is called to pass control to the next middleware."]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);