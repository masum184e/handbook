"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[70743],{26541(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"nginx/Logging/Log Rotation","title":"Log Rotation","description":"Access log rotation is the process of:","source":"@site/docs/nginx/22. Logging/3. Log Rotation.md","sourceDirName":"nginx/22. Logging","slug":"/nginx/Logging/Log Rotation","permalink":"/handbook/docs/nginx/Logging/Log Rotation","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"nginxApiSidebar","previous":{"title":"Error Logs","permalink":"/handbook/docs/nginx/Logging/Error Logs"},"next":{"title":"Stub Status","permalink":"/handbook/docs/nginx/Logging/Stub Status"}}');var r=s(74848),o=s(28453);const t={},l=void 0,d={},c=[{value:"Why Log Rotation Is Critical (Security &amp; Monitoring)",id:"why-log-rotation-is-critical-security--monitoring",level:2},{value:"How NGINX Handles Access Logs Internally",id:"how-nginx-handles-access-logs-internally",level:2},{value:"Recommended Tool: <code>logrotate</code>",id:"recommended-tool-logrotate",level:2},{value:"Basic Access Log Rotation Configuration",id:"basic-access-log-rotation-configuration",level:2},{value:"Example: Rotate NGINX Access Logs Daily",id:"example-rotate-nginx-access-logs-daily",level:3},{value:"Explanation of Each Directive",id:"explanation-of-each-directive",level:2},{value:"How Rotation Actually Works (Step-by-Step)",id:"how-rotation-actually-works-step-by-step",level:2},{value:"Rotating Multiple Access Logs",id:"rotating-multiple-access-logs",level:2},{value:"Rotation with Custom Access Log Formats",id:"rotation-with-custom-access-log-formats",level:2},{value:"Using USR1 Signal Instead of Reload (Advanced)",id:"using-usr1-signal-instead-of-reload-advanced",level:2},{value:"Log Rotation in Containers (Docker / Kubernetes)",id:"log-rotation-in-containers-docker--kubernetes",level:2},{value:"Security Considerations for Log Rotation",id:"security-considerations-for-log-rotation",level:2},{value:"Common Log Rotation Mistakes",id:"common-log-rotation-mistakes",level:2}];function a(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"Access log rotation is the process of:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Periodically archiving current access logs"}),"\n",(0,r.jsx)(n.li,{children:"Creating new log files"}),"\n",(0,r.jsx)(n.li,{children:"Optionally compressing or deleting old logs"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This prevents:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Disk space exhaustion"}),"\n",(0,r.jsx)(n.li,{children:"Performance degradation"}),"\n",(0,r.jsx)(n.li,{children:"Unmanageable log files"}),"\n",(0,r.jsx)(n.li,{children:"Compliance violations"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"NGINX does NOT rotate logs automatically \u2014 rotation must be handled externally."}),"\n",(0,r.jsx)(n.h2,{id:"why-log-rotation-is-critical-security--monitoring",children:"Why Log Rotation Is Critical (Security & Monitoring)"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Risk Without Rotation"}),(0,r.jsx)(n.th,{children:"Impact"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Disk fills up"}),(0,r.jsx)(n.td,{children:"NGINX crashes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Huge log files"}),(0,r.jsx)(n.td,{children:"Slow analysis"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"No retention"}),(0,r.jsx)(n.td,{children:"Compliance issues"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"No compression"}),(0,r.jsx)(n.td,{children:"Wasted storage"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"how-nginx-handles-access-logs-internally",children:"How NGINX Handles Access Logs Internally"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"NGINX keeps file descriptors open"}),"\n",(0,r.jsx)(n.li,{children:"Renaming a log file does not stop logging"}),"\n",(0,r.jsx)(n.li,{children:"NGINX must be reloaded or signaled to reopen logs"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This is why rotation requires reload or USR1 signal."}),"\n",(0,r.jsxs)(n.h2,{id:"recommended-tool-logrotate",children:["Recommended Tool: ",(0,r.jsx)(n.code,{children:"logrotate"})]}),"\n",(0,r.jsx)(n.p,{children:"On most Linux systems, logrotate is the standard and safest solution."}),"\n",(0,r.jsx)(n.h2,{id:"basic-access-log-rotation-configuration",children:"Basic Access Log Rotation Configuration"}),"\n",(0,r.jsx)(n.h3,{id:"example-rotate-nginx-access-logs-daily",children:"Example: Rotate NGINX Access Logs Daily"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"/var/log/nginx/access.log {\r\n    daily\r\n    rotate 14\r\n    compress\r\n    delaycompress\r\n    missingok\r\n    notifempty\r\n    create 0640 nginx adm\r\n    sharedscripts\r\n    postrotate\r\n        systemctl reload nginx > /dev/null 2>&1\r\n    endscript\r\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"explanation-of-each-directive",children:"Explanation of Each Directive"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Directive"}),(0,r.jsx)(n.th,{children:"Meaning"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"daily"})}),(0,r.jsx)(n.td,{children:"Rotate every day"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"rotate 14"})}),(0,r.jsx)(n.td,{children:"Keep 14 old logs"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"compress"})}),(0,r.jsx)(n.td,{children:"Gzip old logs"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"delaycompress"})}),(0,r.jsx)(n.td,{children:"Compress from 2nd rotation"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"missingok"})}),(0,r.jsx)(n.td,{children:"Don\u2019t error if log missing"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"notifempty"})}),(0,r.jsx)(n.td,{children:"Skip empty logs"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"create"})}),(0,r.jsx)(n.td,{children:"Create new file with permissions"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"sharedscripts"})}),(0,r.jsx)(n.td,{children:"Run postrotate once"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:(0,r.jsx)(n.code,{children:"postrotate"})}),(0,r.jsx)(n.td,{children:"Reload NGINX to reopen logs"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"how-rotation-actually-works-step-by-step",children:"How Rotation Actually Works (Step-by-Step)"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"access.log"})," \u2192 renamed to ",(0,r.jsx)(n.code,{children:"access.log.1"})]}),"\n",(0,r.jsxs)(n.li,{children:["Older logs shift: ",(0,r.jsx)(n.code,{children:".2"}),", ",(0,r.jsx)(n.code,{children:".3"}),", etc."]}),"\n",(0,r.jsxs)(n.li,{children:["New empty ",(0,r.jsx)(n.code,{children:"access.log"})," is created"]}),"\n",(0,r.jsx)(n.li,{children:"NGINX reloads and writes to new file"}),"\n",(0,r.jsx)(n.li,{children:"Old logs optionally compressed"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"rotating-multiple-access-logs",children:"Rotating Multiple Access Logs"}),"\n",(0,r.jsx)(n.p,{children:"If you use per-site access logs:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"/var/log/nginx/\\*access.log {\r\ndaily\r\nrotate 7\r\ncompress\r\nmissingok\r\nnotifempty\r\nsharedscripts\r\npostrotate\r\nsystemctl reload nginx > /dev/null 2>&1\r\nendscript\r\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"rotation-with-custom-access-log-formats",children:"Rotation with Custom Access Log Formats"}),"\n",(0,r.jsx)(n.p,{children:"Example NGINX config:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"log_format security '$remote_addr [$time_iso8601] \"$request\" $status';\r\naccess_log /var/log/nginx/security_access.log security;\n"})}),"\n",(0,r.jsx)(n.p,{children:"Logrotate:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"/var/log/nginx/security_access.log {\r\ndaily\r\nrotate 30\r\ncompress\r\ncreate 0640 nginx adm\r\npostrotate\r\nsystemctl reload nginx\r\nendscript\r\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Log rotation is independent of log format."}),"\n",(0,r.jsx)(n.h2,{id:"using-usr1-signal-instead-of-reload-advanced",children:"Using USR1 Signal Instead of Reload (Advanced)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"    postrotate\r\n    kill -USR1 `cat /run/nginx.pid`\r\n    endscript\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Faster than reload"}),"\n",(0,r.jsx)(n.li,{children:"No config revalidation"}),"\n",(0,r.jsx)(n.li,{children:"Preferred for high-traffic systems"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"log-rotation-in-containers-docker--kubernetes",children:"Log Rotation in Containers (Docker / Kubernetes)"}),"\n",(0,r.jsx)(n.p,{children:"Best Practice"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"    access_log /dev/stdout;\r\n    error_log /dev/stderr;\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Let container runtime handle rotation"}),"\n",(0,r.jsx)(n.li,{children:"Avoids file-based logs"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"security-considerations-for-log-rotation",children:"Security Considerations for Log Rotation"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Practice"}),(0,r.jsx)(n.th,{children:"Benefit"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Limited permissions"}),(0,r.jsx)(n.td,{children:"Prevent log tampering"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Compression"}),(0,r.jsx)(n.td,{children:"Protects storage"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Retention policy"}),(0,r.jsx)(n.td,{children:"Compliance"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Central shipping"}),(0,r.jsx)(n.td,{children:"Incident response"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Immutable storage"}),(0,r.jsx)(n.td,{children:"Forensics"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"common-log-rotation-mistakes",children:"Common Log Rotation Mistakes"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Mistake"}),(0,r.jsx)(n.th,{children:"Impact"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"No reload/USR1"}),(0,r.jsx)(n.td,{children:"Logs continue writing to old file"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"No compression"}),(0,r.jsx)(n.td,{children:"Disk usage spikes"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Too long retention"}),(0,r.jsx)(n.td,{children:"Storage waste"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Too short retention"}),(0,r.jsx)(n.td,{children:"Loss of evidence"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"World-readable logs"}),(0,r.jsx)(n.td,{children:"Information leak"})]})]})]}),"\n",(0,r.jsxs)(n.ol,{start:"14",children:["\n",(0,r.jsx)(n.li,{children:"Recommended Production Setup\r\nNGINX"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"access_log /var/log/nginx/access.log main;\n"})}),"\n",(0,r.jsx)(n.p,{children:"Logrotate"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"/var/log/nginx/access.log {\r\n    daily\r\n    rotate 14\r\n    compress\r\n    delaycompress\r\n    create 0640 nginx adm\r\n    postrotate\r\n    kill -USR1 `cat /run/nginx.pid`\r\n    endscript\r\n}\n"})})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},28453(e,n,s){s.d(n,{R:()=>t,x:()=>l});var i=s(96540);const r={},o=i.createContext(r);function t(e){const n=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);