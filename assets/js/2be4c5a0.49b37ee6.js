"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[63987],{28453(e,r,d){d.d(r,{R:()=>o,x:()=>l});var n=d(96540);const s={},i=n.createContext(s);function o(e){const r=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function l(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),n.createElement(i.Provider,{value:r},e.children)}},44553(e,r,d){d.r(r),d.d(r,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>t});const n=JSON.parse('{"id":"nginx/Reverse Proxy/Proxy Headers","title":"Proxy Headers","description":"When NGINX works as a reverse proxy, it sits between the client and the backend server.","source":"@site/docs/nginx/8. Reverse Proxy/2. Proxy Headers.md","sourceDirName":"nginx/8. Reverse Proxy","slug":"/nginx/Reverse Proxy/Proxy Headers","permalink":"/handbook/docs/nginx/Reverse Proxy/Proxy Headers","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{},"sidebar":"nginxApiSidebar","previous":{"title":"proxay_pass","permalink":"/handbook/docs/nginx/Reverse Proxy/proxay_pass"},"next":{"title":"Load Balancing","permalink":"/handbook/docs/nginx/Load Balancing"}}');var s=d(74848),i=d(28453);const o={},l=void 0,c={},t=[{value:"Why Proxy Headers Are Needed",id:"why-proxy-headers-are-needed",level:2},{value:"Core <code>X-Forwarded-*</code> Headers",id:"core-x-forwarded--headers",level:2},{value:"<code>X-Forwarded-For</code>",id:"x-forwarded-for",level:3},{value:"<code>X-Real-IP</code>",id:"x-real-ip",level:3},{value:"<code>X-Forwarded-Proto</code>",id:"x-forwarded-proto",level:3},{value:"<code>X-Forwarded-Host</code>",id:"x-forwarded-host",level:3},{value:"<code>X-Forwarded-Port</code>",id:"x-forwarded-port",level:3},{value:"The <code>Host</code> Header (Important!)",id:"the-host-header-important",level:3},{value:"Recommended Standard Proxy Header Set",id:"recommended-standard-proxy-header-set",level:2},{value:"End-to-End Request Example",id:"end-to-end-request-example",level:2},{value:"Application-Level Usage",id:"application-level-usage",level:2},{value:"Security Considerations",id:"security-considerations",level:2},{value:"X<code>-Forwarded-\\*</code> vs <code>Forwarded</code> (RFC 7239)",id:"x-forwarded--vs-forwarded-rfc-7239",level:2},{value:"Common Mistakes",id:"common-mistakes",level:2},{value:"Real-World SSL Termination Example",id:"real-world-ssl-termination-example",level:2}];function a(e){const r={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.p,{children:"When NGINX works as a reverse proxy, it sits between the client and the backend server."}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"Client \u2500\u2500\u25ba NGINX (proxy) \u2500\u2500\u25ba Backend\n"})}),"\n",(0,s.jsx)(r.p,{children:"Without proxy headers, the backend only sees:"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"NGINX\u2019s IP address"}),"\n",(0,s.jsx)(r.li,{children:"NGINX\u2019s protocol (http/https)"}),"\n",(0,s.jsx)(r.li,{children:"NGINX as the direct client"}),"\n"]}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.code,{children:"X-Forwarded-*"})," headers preserve original client information."]}),"\n",(0,s.jsx)(r.h2,{id:"why-proxy-headers-are-needed",children:"Why Proxy Headers Are Needed"}),"\n",(0,s.jsx)(r.p,{children:"They allow backend applications to know:"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Real client IP address"}),"\n",(0,s.jsx)(r.li,{children:"Original host/domain requested"}),"\n",(0,s.jsx)(r.li,{children:"Original protocol (HTTP or HTTPS)"}),"\n",(0,s.jsx)(r.li,{children:"Proxy chain (multiple proxies)"}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"Used for:"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Logging"}),"\n",(0,s.jsx)(r.li,{children:"Security rules"}),"\n",(0,s.jsx)(r.li,{children:"Authentication"}),"\n",(0,s.jsx)(r.li,{children:"Redirects"}),"\n",(0,s.jsx)(r.li,{children:"Geo/IP detection"}),"\n",(0,s.jsx)(r.li,{children:"Rate limiting"}),"\n"]}),"\n",(0,s.jsxs)(r.h2,{id:"core-x-forwarded--headers",children:["Core ",(0,s.jsx)(r.code,{children:"X-Forwarded-*"})," Headers"]}),"\n",(0,s.jsx)(r.h3,{id:"x-forwarded-for",children:(0,s.jsx)(r.code,{children:"X-Forwarded-For"})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Purpose: Identifies the original client IP address."}),"\n",(0,s.jsxs)(r.li,{children:["Format ",(0,s.jsx)(r.code,{children:"X-Forwarded-For: client_ip, proxy1_ip, proxy2_ip"})]}),"\n",(0,s.jsxs)(r.li,{children:["NGINX Directive: ",(0,s.jsx)(r.code,{children:"proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;"})]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Example Flow"})}),"\n",(0,s.jsxs)(r.p,{children:["Client IP: ",(0,s.jsx)(r.code,{children:"203.0.113.10"})]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"X-Forwarded-For: 203.0.113.10\n"})}),"\n",(0,s.jsx)(r.p,{children:"With multiple proxies:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"X-Forwarded-For: 203.0.113.10, 192.168.1.1\n"})}),"\n",(0,s.jsx)(r.p,{children:"Backend Use"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Detect real client IP"}),"\n",(0,s.jsx)(r.li,{children:"Prevent abuse"}),"\n",(0,s.jsx)(r.li,{children:"Accurate logging"}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"x-real-ip",children:(0,s.jsx)(r.code,{children:"X-Real-IP"})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["Purpose: Provides a single client IP address (simpler than ",(0,s.jsx)(r.code,{children:"X-Forwarded-For"}),")."]}),"\n",(0,s.jsxs)(r.li,{children:["NGINX Directive: ",(0,s.jsx)(r.code,{children:"proxy_set_header X-Real-IP $remote_addr;"})]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"Example"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"X-Real-IP: 203.0.113.10\n"})}),"\n",(0,s.jsxs)(r.p,{children:["Difference from ",(0,s.jsx)(r.code,{children:"X-Forwarded-For"})]}),"\n",(0,s.jsxs)(r.table,{children:[(0,s.jsx)(r.thead,{children:(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.th,{children:"Header"}),(0,s.jsx)(r.th,{children:"Use"})]})}),(0,s.jsxs)(r.tbody,{children:[(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"X-Real-IP"})}),(0,s.jsx)(r.td,{children:"Simple, one IP"})]}),(0,s.jsxs)(r.tr,{children:[(0,s.jsx)(r.td,{children:(0,s.jsx)(r.code,{children:"X-Forwarded-For"})}),(0,s.jsx)(r.td,{children:"Full proxy chain"})]})]})]}),"\n",(0,s.jsx)(r.h3,{id:"x-forwarded-proto",children:(0,s.jsx)(r.code,{children:"X-Forwarded-Proto"})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Purpose: Tells the backend the original protocol used by the client."}),"\n",(0,s.jsxs)(r.li,{children:["Values: ",(0,s.jsx)(r.code,{children:"http"}),", ",(0,s.jsx)(r.code,{children:"https"})]}),"\n",(0,s.jsxs)(r.li,{children:["NGINX Directive: ",(0,s.jsx)(r.code,{children:"proxy_set_header X-Forwarded-Proto $scheme;"})]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Example"})}),"\n",(0,s.jsx)(r.p,{children:"Client accesses:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"https://example.com\n"})}),"\n",(0,s.jsx)(r.p,{children:"Backend receives:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"X-Forwarded-Proto: https\n"})}),"\n",(0,s.jsx)(r.p,{children:"Why It Matters"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Correct redirects"}),"\n",(0,s.jsx)(r.li,{children:"OAuth callbacks"}),"\n",(0,s.jsx)(r.li,{children:"Secure cookies"}),"\n",(0,s.jsx)(r.li,{children:"HTTPS enforcement"}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"x-forwarded-host",children:(0,s.jsx)(r.code,{children:"X-Forwarded-Host"})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Purpose: Contains the original Host header requested by the client."}),"\n",(0,s.jsxs)(r.li,{children:["NGINX Directive: ",(0,s.jsx)(r.code,{children:"proxy_set_header X-Forwarded-Host $host;"})]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Example"})}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"X-Forwarded-Host: example.com\n"})}),"\n",(0,s.jsx)(r.h3,{id:"x-forwarded-port",children:(0,s.jsx)(r.code,{children:"X-Forwarded-Port"})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Purpose: Indicates the original port used by the client."}),"\n",(0,s.jsxs)(r.li,{children:["NGINX Directive: ",(0,s.jsx)(r.code,{children:"proxy_set_header X-Forwarded-Port $server_port;"})]}),"\n"]}),"\n",(0,s.jsx)(r.p,{children:"Example"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"X-Forwarded-Port: 443\n"})}),"\n",(0,s.jsxs)(r.h3,{id:"the-host-header-important",children:["The ",(0,s.jsx)(r.code,{children:"Host"})," Header (Important!)"]}),"\n",(0,s.jsxs)(r.p,{children:["Although not ",(0,s.jsx)(r.code,{children:"X-Forwarded-\\*"}),", it is critical."]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"proxy_set_header Host $host;\n"})}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Preserves original domain name"}),"\n",(0,s.jsxs)(r.li,{children:["Required for:","\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Virtual hosting"}),"\n",(0,s.jsx)(r.li,{children:"TLS SNI"}),"\n",(0,s.jsx)(r.li,{children:"Correct routing"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"recommended-standard-proxy-header-set",children:"Recommended Standard Proxy Header Set"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"location / {\r\n    proxy_pass http://backend;\r\n\r\n        proxy_set_header Host $host;\r\n        proxy_set_header X-Real-IP $remote_addr;\r\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\r\n        proxy_set_header X-Forwarded-Proto $scheme;\r\n        proxy_set_header X-Forwarded-Host $host;\r\n        proxy_set_header X-Forwarded-Port $server_port;\r\n\r\n}\n"})}),"\n",(0,s.jsx)(r.p,{children:"This is considered best practice."}),"\n",(0,s.jsx)(r.h2,{id:"end-to-end-request-example",children:"End-to-End Request Example"}),"\n",(0,s.jsx)(r.p,{children:"Client Request"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"GET /login HTTP/1.1\r\nHost: example.com\n"})}),"\n",(0,s.jsx)(r.p,{children:"Headers Sent to Backend"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"Host: example.com\r\nX-Real-IP: 203.0.113.10\r\nX-Forwarded-For: 203.0.113.10\r\nX-Forwarded-Proto: https\r\nX-Forwarded-Host: example.com\r\nX-Forwarded-Port: 443\n"})}),"\n",(0,s.jsx)(r.h2,{id:"application-level-usage",children:"Application-Level Usage"}),"\n",(0,s.jsx)(r.p,{children:"Example: Backend Redirect Logic"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:'if request.headers["X-Forwarded-Proto"] == "https":\r\nsecure = True\n'})}),"\n",(0,s.jsx)(r.p,{children:"Example: Logging Real IP"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"$remote_addr \u2192 NGINX IP\r\nX-Forwarded-For \u2192 Client IP\n"})}),"\n",(0,s.jsx)(r.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,s.jsx)(r.p,{children:"These headers can be spoofed by clients."}),"\n",(0,s.jsx)(r.p,{children:"Best Practices"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Only trust headers from known proxies"}),"\n",(0,s.jsxs)(r.li,{children:["Use NGINX ",(0,s.jsx)(r.code,{children:"real_ip"})," module to sanitize"]}),"\n",(0,s.jsxs)(r.li,{children:["Strip incoming ",(0,s.jsx)(r.code,{children:"X-Forwarded-\\*"})," headers"]}),"\n"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n"})}),"\n",(0,s.jsx)(r.p,{children:"(Overwrites client-sent value)"}),"\n",(0,s.jsxs)(r.h2,{id:"x-forwarded--vs-forwarded-rfc-7239",children:["X",(0,s.jsx)(r.code,{children:"-Forwarded-\\*"})," vs ",(0,s.jsx)(r.code,{children:"Forwarded"})," (RFC 7239)"]}),"\n",(0,s.jsx)(r.p,{children:"Modern Alternative"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"Forwarded: for=203.0.113.10;proto=https;host=example.com\n"})}),"\n",(0,s.jsx)(r.p,{children:"NGINX supports it, but:"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"X-Forwarded-\\*"})," is still more widely used"]}),"\n",(0,s.jsxs)(r.li,{children:["Most frameworks expect ",(0,s.jsx)(r.code,{children:"X-Forwarded-\\*"})]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"common-mistakes",children:"Common Mistakes"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["Forgetting ",(0,s.jsx)(r.code,{children:"X-Forwarded-Proto"})," (causes redirect loops)"]}),"\n",(0,s.jsx)(r.li,{children:"Trusting client-provided headers"}),"\n",(0,s.jsxs)(r.li,{children:["Missing ",(0,s.jsx)(r.code,{children:"Host"})," header"]}),"\n",(0,s.jsxs)(r.li,{children:["Using ",(0,s.jsx)(r.code,{children:"$remote_addr"})," incorrectly"]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"real-world-ssl-termination-example",children:"Real-World SSL Termination Example"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{children:"server {\r\n    listen 443 ssl;\r\n\r\n        location / {\r\n            proxy_pass http://app_backend;\r\n\r\n            proxy_set_header Host $host;\r\n            proxy_set_header X-Forwarded-Proto https;\r\n            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\r\n        }\r\n\r\n    }\n"})}),"\n",(0,s.jsx)(r.p,{children:"Backend runs HTTP but behaves as HTTPS-aware."})]})}function h(e={}){const{wrapper:r}={...(0,i.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}}}]);