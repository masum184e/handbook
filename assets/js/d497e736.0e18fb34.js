"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[4584],{6382(e,n,r){r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>t,toc:()=>a});const t=JSON.parse('{"id":"nextjs/Authentication","title":"Authentication","description":"next-auth","source":"@site/docs/nextjs/11. Authentication.md","sourceDirName":"nextjs","slug":"/nextjs/Authentication","permalink":"/handbook/docs/nextjs/Authentication","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":13,"frontMatter":{"title":"Authentication","sidebar_position":13},"sidebar":"nextjsSidebar","previous":{"title":"Styled Components","permalink":"/handbook/docs/nextjs/Styled Components"},"next":{"title":"Middleware","permalink":"/handbook/docs/nextjs/Middleware"}}');var s=r(4848),i=r(8453);const o={title:"Authentication",sidebar_position:13},l=void 0,c={},a=[{value:"<code>next-auth</code>",id:"next-auth",level:2},{value:"Install NextAuth",id:"install-nextauth",level:3},{value:"Configure Environment Variables",id:"configure-environment-variables",level:3},{value:"Configure API Route",id:"configure-api-route",level:3},{value:"Sign In with Credentials",id:"sign-in-with-credentials",level:3},{value:"Sign Up",id:"sign-up",level:3},{value:"Protect Client Components",id:"protect-client-components",level:3},{value:"Protect Server-Side Routes",id:"protect-server-side-routes",level:3},{value:"JWT Authentication",id:"jwt-authentication",level:2},{value:"How JWT Authentication Works",id:"how-jwt-authentication-works",level:3},{value:"Protecting Server-Side Routes",id:"protecting-server-side-routes",level:3},{value:"Role-Based Access Control",id:"role-based-access-control",level:2},{value:"Adding Roles to JWT and Session",id:"adding-roles-to-jwt-and-session",level:3},{value:"Protecting Client-Side Components by Role",id:"protecting-client-side-components-by-role",level:3},{value:"Protecting Server-Side Routes by Role",id:"protecting-server-side-routes-by-role",level:3}];function d(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"next-auth",children:(0,s.jsx)(n.code,{children:"next-auth"})}),"\n",(0,s.jsx)(n.h3,{id:"install-nextauth",children:"Install NextAuth"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"npm install next-auth\n"})}),"\n",(0,s.jsx)(n.h3,{id:"configure-environment-variables",children:"Configure Environment Variables"}),"\n",(0,s.jsxs)(n.p,{children:["Create a ",(0,s.jsx)(n.code,{children:".env"})," file with the following values:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-env",children:"NEXT_PUBLIC_BASE_URL=http://localhost:3000\r\nNEXTAUTH_SECRET=strong_secret\r\nNEXTAUTH_URL=http://localhost:3000\r\nGITHUB_ID=your_github_client_id\r\nGITHUB_SECRET=your_github_client_secret\n"})}),"\n",(0,s.jsx)(n.h3,{id:"configure-api-route",children:"Configure API Route"}),"\n",(0,s.jsxs)(n.p,{children:["Create the NextAuth API route in ",(0,s.jsx)(n.code,{children:"app/api/auth/[...nextauth].ts"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import NextAuth from "next-auth";\r\nimport GithubProvider from "next-auth/providers/github";\r\nimport CredentialsProvider from "next-auth/providers/credentials";\r\nimport { verfiyUser } from "@/lib/auth"; // your custom verify function\r\n\r\nconst handler = NextAuth({\r\n  providers: [\r\n    GithubProvider({\r\n      clientId: process.env.GITHUB_ID || "",\r\n      clientSecret: process.env.GITHUB_SECRET || "",\r\n    }),\r\n    CredentialsProvider({\r\n      credentials: {\r\n        email: { label: "Email Address", type: "email" },\r\n        password: { label: "Password", type: "password" },\r\n      },\r\n      async authorize(credentials) {\r\n        try {\r\n          if (credentials?.email && credentials?.password) {\r\n            return await verfiyUser(credentials.email, credentials.password);\r\n          }\r\n        } catch (error) {\r\n          console.error(error);\r\n        }\r\n        return null;\r\n      },\r\n    }),\r\n  ],\r\n  pages: {\r\n    signIn: "/signin",\r\n  },\r\n});\r\n\r\nexport { handler as GET, handler as POST };\n'})}),"\n",(0,s.jsx)(n.h3,{id:"sign-in-with-credentials",children:"Sign In with Credentials"}),"\n",(0,s.jsxs)(n.p,{children:["Use the ",(0,s.jsx)(n.code,{children:"signIn"})," function from ",(0,s.jsx)(n.code,{children:"next-auth/react"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { signIn } from "next-auth/react";\r\n\r\nconst response = await signIn("credentials", { email, password });\n'})}),"\n",(0,s.jsx)(n.h3,{id:"sign-up",children:"Sign Up"}),"\n",(0,s.jsx)(n.p,{children:"Create a sign-up API route or call an existing endpoint:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'const response = await fetch("/api/auth/signup", {\r\n  method: "POST",\r\n  headers: { "Content-Type": "application/json" },\r\n  body: JSON.stringify({ name, email, password }),\r\n});\n'})}),"\n",(0,s.jsx)(n.h3,{id:"protect-client-components",children:"Protect Client Components"}),"\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"useSession"})," to check authentication:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { useSession, signIn, signOut } from "next-auth/react";\r\n\r\nexport default function Component() {\r\n  const { data: session } = useSession();\r\n\r\n  if (session) {\r\n    return (\r\n      <>\r\n        Signed in as {session.user?.email} <br />\r\n        <button onClick={() => signOut()}>Sign out</button>\r\n      </>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <>\r\n      Not signed in <br />\r\n      <button onClick={() => signIn()}>Sign in</button>\r\n    </>\r\n  );\r\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"protect-server-side-routes",children:"Protect Server-Side Routes"}),"\n",(0,s.jsxs)(n.p,{children:["Use ",(0,s.jsx)(n.code,{children:"getServerSession"})," in API routes:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { getServerSession } from "next-auth/next";\r\nimport { authOptions } from "./auth/[...nextauth]";\r\n\r\nexport default async (req, res) => {\r\n  const session = await getServerSession(req, res, authOptions);\r\n\r\n  if (session) {\r\n    res.send({\r\n      content:\r\n        "This is protected content. You can access it because you are signed in.",\r\n    });\r\n  } else {\r\n    res.send({\r\n      error: "You must be signed in to view this content.",\r\n    });\r\n  }\r\n};\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"getSession(context)"})," can also be used for server-rendered pages."]}),"\n",(0,s.jsx)(n.li,{children:"Redirect users to login if no session is found."}),"\n",(0,s.jsx)(n.li,{children:"Ensures server-side protection for pages and API routes."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"jwt-authentication",children:"JWT Authentication"}),"\n",(0,s.jsx)(n.h3,{id:"how-jwt-authentication-works",children:"How JWT Authentication Works"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Login"}),": User submits credentials via a POST request to your API."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Verify & Sign"}),": Server verifies credentials and issues a JWT."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Store Token"}),": Client stores the JWT (in an HttpOnly cookie or ",(0,s.jsx)(n.code,{children:"localStorage"}),")."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Authenticated Requests"}),": Client includes the JWT in headers or cookies when accessing protected routes."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Verify Token"}),": Server checks the JWT on each protected request."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"protecting-server-side-routes",children:"Protecting Server-Side Routes"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import jwt from "jsonwebtoken";\r\n\r\nexport default function Dashboard({ user }) {\r\n  return (\r\n    <h1>\r\n      Welcome {user.email}! Role: {user.role}\r\n    </h1>\r\n  );\r\n}\r\n\r\nexport async function getServerSideProps({ req }) {\r\n  // Extract token from cookies\r\n  const token = req.headers.cookie?.split("=")[1] || "";\r\n\r\n  try {\r\n    // Verify JWT\r\n    const user = jwt.verify(token, process.env.JWT_SECRET);\r\n    return { props: { user } };\r\n  } catch (err) {\r\n    // Redirect to login if verification fails\r\n    return {\r\n      redirect: { destination: "/login", permanent: false },\r\n    };\r\n  }\r\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Prefer HttpOnly cookies for storing JWTs to prevent XSS attacks."}),"\n",(0,s.jsx)(n.li,{children:"Always verify the JWT on every request to protected server-side pages."}),"\n",(0,s.jsx)(n.li,{children:"Customize payload to include user roles or permissions for fine-grained access control."}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"role-based-access-control",children:"Role-Based Access Control"}),"\n",(0,s.jsx)(n.h3,{id:"adding-roles-to-jwt-and-session",children:"Adding Roles to JWT and Session"}),"\n",(0,s.jsx)(n.p,{children:"Configure the callbacks in your NextAuth options to attach user roles:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"callbacks: {\r\n  async jwt({ token, user }) {\r\n    if (user) token.role = user.role; // attach role to JWT\r\n    return token;\r\n  },\r\n  async session({ session, token }) {\r\n    session.user.role = token.role; // make role available in session\r\n    return session;\r\n  },\r\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"protecting-client-side-components-by-role",children:"Protecting Client-Side Components by Role"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'"use client";\r\nimport { useSession } from "next-auth/react";\r\n\r\nexport default function AdminOnly({ children }) {\r\n  const { data: session } = useSession();\r\n\r\n  // Hide content if not logged in or not an admin\r\n  if (!session || session.user.role !== "admin") return null;\r\n\r\n  return <>{children}</>;\r\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Useful for rendering UI elements that only admins should see."}),"\n",(0,s.jsx)(n.li,{children:"Prevents accidental exposure of restricted content on the client."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"protecting-server-side-routes-by-role",children:"Protecting Server-Side Routes by Role"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:'import { getSession } from "next-auth/react";\r\n\r\nexport default function AdminDashboard() {\r\n  return <h1>Admin Dashboard - Only Admins Can See This</h1>;\r\n}\r\n\r\nexport async function getServerSideProps(context) {\r\n  const session = await getSession(context);\r\n\r\n  // Redirect if not logged in\r\n  if (!session) {\r\n    return { redirect: { destination: "/login", permanent: false } };\r\n  }\r\n\r\n  // Redirect if not an admin\r\n  if (session.user.role !== "admin") {\r\n    return { redirect: { destination: "/", permanent: false } };\r\n  }\r\n\r\n  return { props: {} };\r\n}\n'})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"First check ensures the user is authenticated."}),"\n",(0,s.jsxs)(n.li,{children:["Second check ensures the user has the required ",(0,s.jsx)(n.code,{children:"admin"})," role."]}),"\n",(0,s.jsx)(n.li,{children:"Unauthorized users are redirected accordingly."}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453(e,n,r){r.d(n,{R:()=>o,x:()=>l});var t=r(6540);const s={},i=t.createContext(s);function o(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);