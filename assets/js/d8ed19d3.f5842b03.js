"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[1309],{28453(e,n,r){r.d(n,{R:()=>d,x:()=>o});var s=r(96540);const i={},t=s.createContext(i);function d(e){const n=s.useContext(t);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),s.createElement(t.Provider,{value:n},e.children)}},57899(e,n,r){r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>d,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"nextjs/Middleware","title":"Middleware","description":"Middleware in Next.js is a powerful feature that lets you run code before a request is completed. It sits between the client request and the response, allowing you to modify requests, responses, or perform conditional routing.","source":"@site/docs/nextjs/12. Middleware.md","sourceDirName":"nextjs","slug":"/nextjs/Middleware","permalink":"/handbook/docs/nextjs/Middleware","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":14,"frontMatter":{"title":"Middleware","sidebar_position":14},"sidebar":"nextjsSidebar","previous":{"title":"Authentication","permalink":"/handbook/docs/nextjs/Authentication"},"next":{"title":"Deployment","permalink":"/handbook/docs/nextjs/Deployment"}}');var i=r(74848),t=r(28453);const d={title:"Middleware",sidebar_position:14},o=void 0,l={},c=[{value:"Features of Next.js Middleware",id:"features-of-nextjs-middleware",level:2},{value:"Custom Logic",id:"custom-logic",level:2},{value:"Steps for Writing Middleware",id:"steps-for-writing-middleware",level:3},{value:"Custom Header Validation",id:"custom-header-validation",level:3},{value:"Time-Based Access Control",id:"time-based-access-control",level:3},{value:"Understanding <code>next.config.js</code>",id:"understanding-nextconfigjs",level:2},{value:"Key Points",id:"key-points",level:3},{value:"Middleware with Inline Matcher",id:"middleware-with-inline-matcher",level:3},{value:"Centralized Routing",id:"centralized-routing",level:3},{value:"Localization",id:"localization",level:3},{value:"Headers + Middleware",id:"headers--middleware",level:3}];function a(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Middleware in Next.js is a powerful feature that lets you run code before a request is completed. It sits between the client request and the response, allowing you to modify requests, responses, or perform conditional routing."}),"\n",(0,i.jsx)(n.h2,{id:"features-of-nextjs-middleware",children:"Features of Next.js Middleware"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Execution"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Runs on the Edge Runtime (lighter, faster, no Node.js APIs)."}),"\n",(0,i.jsx)(n.li,{children:"Executes before rendering a page or running an API route."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Use Cases"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Authentication & authorization (redirect unauthorized users)."}),"\n",(0,i.jsx)(n.li,{children:"URL rewrites or redirects."}),"\n",(0,i.jsx)(n.li,{children:"Logging, analytics, A/B testing."}),"\n",(0,i.jsx)(n.li,{children:"Localization (redirecting users based on locale or region)."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"File Location"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Create a ",(0,i.jsx)(n.code,{children:"middleware.ts"})," or ",(0,i.jsx)(n.code,{children:"middleware.js"})," file at the root of your project (same level as ",(0,i.jsx)(n.code,{children:"pages/"})," or ",(0,i.jsx)(n.code,{children:"app/"}),")."]}),"\n",(0,i.jsx)(n.li,{children:"Or inside specific directories for scoped middleware."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Request Object"}),":","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Middleware receives a ",(0,i.jsx)(n.code,{children:"NextRequest"})," object."]}),"\n",(0,i.jsxs)(n.li,{children:["Returns a ",(0,i.jsx)(n.code,{children:"NextResponse"})," object to control what happens next."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"custom-logic",children:"Custom Logic"}),"\n",(0,i.jsx)(n.p,{children:"Middleware in Next.js isn\u2019t just for authentication or redirects\u2014you can also write custom logic that runs before your routes are processed. This allows you to intercept, modify, or enforce rules at the edge layer."}),"\n",(0,i.jsx)(n.h3,{id:"steps-for-writing-middleware",children:"Steps for Writing Middleware"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Create the middleware file"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Add a ",(0,i.jsx)(n.code,{children:"middleware.ts"})," or ",(0,i.jsx)(n.code,{children:"middleware.js"})," at the root of your project (next to ",(0,i.jsx)(n.code,{children:"pages/"})," or ",(0,i.jsx)(n.code,{children:"app/"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["You can also scope it to a directory (e.g., ",(0,i.jsx)(n.code,{children:"app/dashboard/middleware.ts"}),") if you want it to apply only to specific routes."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Define your middleware function"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The function receives a ",(0,i.jsx)(n.code,{children:"NextRequest"})," object."]}),"\n",(0,i.jsxs)(n.li,{children:["You return a ",(0,i.jsx)(n.code,{children:"NextResponse"})," that either:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Allows the request: ",(0,i.jsx)(n.code,{children:"NextResponse.next()"})]}),"\n",(0,i.jsxs)(n.li,{children:["Redirects: ",(0,i.jsx)(n.code,{children:"NextResponse.redirect()"})]}),"\n",(0,i.jsxs)(n.li,{children:["Rewrites: ",(0,i.jsx)(n.code,{children:"NextResponse.rewrite()"})]}),"\n",(0,i.jsx)(n.li,{children:"Or blocks / sends a custom response."}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"(Optional) Add configuration"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Use the ",(0,i.jsx)(n.code,{children:"config.matcher"})," property to decide which routes the middleware applies to."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"custom-header-validation",children:"Custom Header Validation"}),"\n",(0,i.jsxs)(n.p,{children:["Suppose you want all API requests to include a custom header ",(0,i.jsx)(n.code,{children:"x-api-key"}),". If it\u2019s missing or incorrect, reject the request."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'// middleware.ts\r\nimport { NextResponse } from "next/server";\r\nimport type { NextRequest } from "next/server";\r\n\r\nexport function middleware(request: NextRequest) {\r\n  // Only check API routes\r\n  if (request.nextUrl.pathname.startsWith("/api")) {\r\n    const apiKey = request.headers.get("x-api-key");\r\n\r\n    if (apiKey !== process.env.API_KEY) {\r\n      return new NextResponse(\r\n        JSON.stringify({ error: "Unauthorized request" }),\r\n        { status: 401, headers: { "Content-Type": "application/json" } }\r\n      );\r\n    }\r\n  }\r\n\r\n  // Otherwise allow the request\r\n  return NextResponse.next();\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["We check if the request URL starts with ",(0,i.jsx)(n.code,{children:"/api"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["If yes, validate the ",(0,i.jsx)(n.code,{children:"x-api-key"})," header."]}),"\n",(0,i.jsx)(n.li,{children:"If invalid, return a custom 401 Unauthorized JSON response."}),"\n",(0,i.jsxs)(n.li,{children:["If valid, continue with ",(0,i.jsx)(n.code,{children:"NextResponse.next()"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"time-based-access-control",children:"Time-Based Access Control"}),"\n",(0,i.jsxs)(n.p,{children:["Only allow access to ",(0,i.jsx)(n.code,{children:"/dashboard"})," during working hours (9 AM \u2013 6 PM). Outside this time, redirect to ",(0,i.jsx)(n.code,{children:"/closed"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'// middleware.ts\r\nimport { NextResponse } from "next/server";\r\nimport type { NextRequest } from "next/server";\r\n\r\nexport function middleware(request: NextRequest) {\r\n  const hour = new Date().getHours();\r\n\r\n  // Only allow during 9 AM - 6 PM\r\n  if (hour < 9 || hour >= 18) {\r\n    return NextResponse.redirect(new URL("/closed", request.url));\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\r\n\r\nexport const config = {\r\n  matcher: "/dashboard/:path*",\r\n};\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Uses ",(0,i.jsx)(n.code,{children:"Date().getHours()"})," to check the server\u2019s time."]}),"\n",(0,i.jsxs)(n.li,{children:["If the request is outside working hours, users are redirected to ",(0,i.jsx)(n.code,{children:"/closed"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Applies only on ",(0,i.jsx)(n.code,{children:"/dashboard/*"})," routes via ",(0,i.jsx)(n.code,{children:"matcher"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.h2,{id:"understanding-nextconfigjs",children:["Understanding ",(0,i.jsx)(n.code,{children:"next.config.js"})]}),"\n",(0,i.jsxs)(n.p,{children:["By default, middleware in Next.js is controlled using the ",(0,i.jsx)(n.code,{children:"config"})," export inside ",(0,i.jsx)(n.code,{children:"middleware.ts"})," (with the ",(0,i.jsx)(n.code,{children:"matcher"})," option)."]}),"\n",(0,i.jsxs)(n.p,{children:["But sometimes you need global project-level configuration that lives in ",(0,i.jsx)(n.code,{children:"next.config.js"}),". This file defines build-time and runtime configurations for your Next.js project, and it can also influence how middleware behaves."]}),"\n",(0,i.jsx)(n.h3,{id:"key-points",children:"Key Points"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"matcher"})," vs ",(0,i.jsx)(n.code,{children:"next.config.js"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Middleware itself can export a ",(0,i.jsx)(n.code,{children:"config"})," with ",(0,i.jsx)(n.code,{children:"matcher"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["But in some advanced cases, you may centralize route matching and rewrites in ",(0,i.jsx)(n.code,{children:"next.config.js"})," so that middleware and routing work consistently."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Where it fits","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"next.config.js"})," configures global behavior such as rewrites, redirects, and headers."]}),"\n",(0,i.jsx)(n.li,{children:"Middleware can then react to those rules."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["What you can configure in ",(0,i.jsx)(n.code,{children:"next.config.js"})," that affects middleware","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"async rewrites()"})," \u2013 rewrite incoming requests before middleware executes."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"async redirects()"})," \u2013 define static redirects."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"headers()"})," \u2013 add security or custom headers globally."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"experimental.middlewarePrefetch (older versions)"})," \u2013 controls prefetch behavior with middleware."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"middleware-with-inline-matcher",children:"Middleware with Inline Matcher"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'// middleware.ts\r\nexport const config = {\r\n  matcher: ["/dashboard/:path*", "/profile/:path*"],\r\n};\n'})}),"\n",(0,i.jsx)(n.h3,{id:"centralized-routing",children:"Centralized Routing"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'// next.config.js\r\nmodule.exports = {\r\n  async redirects() {\r\n    return [\r\n      {\r\n        source: "/old-dashboard/:path*",\r\n        destination: "/dashboard/:path*",\r\n        permanent: true,\r\n      },\r\n    ];\r\n  },\r\n};\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["If someone visits ",(0,i.jsx)(n.code,{children:"/old-dashboard/settings"}),", Next.js redirects to ",(0,i.jsx)(n.code,{children:"/dashboard/settings"})," before middleware runs."]}),"\n",(0,i.jsxs)(n.li,{children:["Then, middleware with ",(0,i.jsx)(n.code,{children:"/dashboard/:path*"})," matcher takes over for authentication, logging, etc."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"localization",children:"Localization"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'// next.config.js\r\nmodule.exports = {\r\n  async rewrites() {\r\n    return [\r\n      { source: "/fr/:path*", destination: "/:path*" },\r\n      { source: "/bd/:path*", destination: "/:path*" },\r\n    ];\r\n  },\r\n};\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'// middleware.ts\r\nimport { NextResponse } from "next/server";\r\nimport type { NextRequest } from "next/server";\r\n\r\nexport function middleware(request: NextRequest) {\r\n  const country = request.geo?.country || "US";\r\n\r\n  if (request.nextUrl.pathname === "/") {\r\n    if (country === "FR") {\r\n      return NextResponse.redirect(new URL("/fr", request.url));\r\n    }\r\n    if (country === "BD") {\r\n      return NextResponse.redirect(new URL("/bd", request.url));\r\n    }\r\n  }\r\n\r\n  return NextResponse.next();\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"next.config.js"})," ensures ",(0,i.jsx)(n.code,{children:"/fr/*"})," and ",(0,i.jsx)(n.code,{children:"/bd/*"})," map internally to the same routes (",(0,i.jsx)(n.code,{children:"/:path*"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["Middleware adds dynamic redirection so ",(0,i.jsx)(n.code,{children:"/"})," visitors get redirected to ",(0,i.jsx)(n.code,{children:"/fr"})," or ",(0,i.jsx)(n.code,{children:"/bd"})," based on location."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This combo makes localization powerful and consistent."}),"\n",(0,i.jsx)(n.h3,{id:"headers--middleware",children:"Headers + Middleware"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'// next.config.js\r\nmodule.exports = {\r\n  async headers() {\r\n    return [\r\n      {\r\n        source: "/:path*",\r\n        headers: [\r\n          { key: "X-Frame-Options", value: "DENY" },\r\n          { key: "X-Content-Type-Options", value: "nosniff" },\r\n        ],\r\n      },\r\n    ];\r\n  },\r\n};\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-ts",children:'// middleware.ts\r\nimport { NextResponse } from "next/server";\r\nimport type { NextRequest } from "next/server";\r\n\r\nexport function middleware(request: NextRequest) {\r\n  console.log(`Request to: ${request.nextUrl.pathname}`);\r\n  return NextResponse.next();\r\n}\n'})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"next.config.js"})," ensures every route gets security headers automatically."]}),"\n",(0,i.jsx)(n.li,{children:"Middleware focuses only on custom logic (logging, authentication, etc.)."}),"\n",(0,i.jsx)(n.li,{children:"This separation of concerns keeps middleware lightweight."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}}}]);