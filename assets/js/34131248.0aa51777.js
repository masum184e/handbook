"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[51819],{28453(n,e,o){o.d(e,{R:()=>l,x:()=>t});var i=o(96540);const s={},r=i.createContext(s);function l(n){const e=i.useContext(r);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:l(n.components),i.createElement(r.Provider,{value:e},n.children)}},95721(n,e,o){o.r(e),o.d(e,{assets:()=>c,contentTitle:()=>t,default:()=>p,frontMatter:()=>l,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"prisma/Connection Pooling","title":"Connection Pooling","description":"A database connection is a link between your application and the database.","source":"@site/docs/prisma/9. Connection Pooling.md","sourceDirName":"prisma","slug":"/prisma/Connection Pooling","permalink":"/handbook/docs/prisma/Connection Pooling","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":9,"frontMatter":{"sidebar_position":9},"sidebar":"prismaApiSidebar","previous":{"title":"Transaction","permalink":"/handbook/docs/prisma/Transaction"},"next":{"title":"N+1 Problem","permalink":"/handbook/docs/prisma/N+1 Problem"}}');var s=o(74848),r=o(28453);const l={sidebar_position:9},t=void 0,c={},a=[{value:"Why Do We Need Connection Pooling",id:"why-do-we-need-connection-pooling",level:2},{value:"Prisma and Connection Pooling",id:"prisma-and-connection-pooling",level:2},{value:"Driver-level pooling (default)",id:"driver-level-pooling-default",level:3},{value:"External poolers (recommended for serverless)",id:"external-poolers-recommended-for-serverless",level:3},{value:"Configuring Connection Pooling",id:"configuring-connection-pooling",level:2},{value:"Example of Connection Pooling",id:"example-of-connection-pooling",level:2},{value:"Query without pooling (serverless issue)",id:"query-without-pooling-serverless-issue",level:3},{value:"Optimized Example with Pooling",id:"optimized-example-with-pooling",level:3},{value:"Connection Pooling with PgBouncer (PostgreSQL Example)",id:"connection-pooling-with-pgbouncer-postgresql-example",level:2},{value:"Monitoring Connection Pool",id:"monitoring-connection-pool",level:2}];function d(n){const e={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.p,{children:"A database connection is a link between your application and the database."}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Creating and tearing down a connection is expensive (it takes time and resources)."}),"\n",(0,s.jsx)(e.li,{children:"Instead of creating a new connection for every query, a connection pool keeps a set of database connections open and reuses them."}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"This ensures:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Lower latency (faster queries since no need to re-establish connections)."}),"\n",(0,s.jsx)(e.li,{children:"Efficient resource usage (database and app aren\u2019t overloaded with connection churn)."}),"\n",(0,s.jsx)(e.li,{children:"Scalability (can handle many simultaneous requests)."}),"\n"]}),"\n",(0,s.jsxs)(e.p,{children:["Prisma relies on an underlying database driver (like ",(0,s.jsx)(e.code,{children:"node-postgres"})," for PostgreSQL, ",(0,s.jsx)(e.code,{children:"mysql2"})," for MySQL) and usually uses a pool to manage connections."]}),"\n",(0,s.jsx)(e.h2,{id:"why-do-we-need-connection-pooling",children:"Why Do We Need Connection Pooling"}),"\n",(0,s.jsx)(e.p,{children:"Without pooling:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Each request to your app = opens a new database connection."}),"\n",(0,s.jsx)(e.li,{children:"Under load (e.g., 1000 requests/sec), this causes connection storms \u2192 database crashes or slows down."}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"With pooling:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"A fixed number of connections are maintained."}),"\n",(0,s.jsx)(e.li,{children:"Requests share these connections."}),"\n",(0,s.jsx)(e.li,{children:"Idle connections are reused instead of destroyed."}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"prisma-and-connection-pooling",children:"Prisma and Connection Pooling"}),"\n",(0,s.jsx)(e.p,{children:"Prisma supports connection pooling through the database driver or an external pooler like PgBouncer for PostgreSQL."}),"\n",(0,s.jsx)(e.p,{children:"There are two main strategies:"}),"\n",(0,s.jsx)(e.h3,{id:"driver-level-pooling-default",children:"Driver-level pooling (default)"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Prisma\u2019s underlying database drivers (Postgres/MySQL) already manage a pool."}),"\n",(0,s.jsx)(e.li,{children:"Pool size can be configured via the connection string."}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"external-poolers-recommended-for-serverless",children:"External poolers (recommended for serverless)"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"In serverless environments (e.g., AWS Lambda, Vercel), every function execution may create a new Prisma client, causing too many database connections."}),"\n",(0,s.jsx)(e.li,{children:"Solution: Use PgBouncer (for PostgreSQL) or ProxySQL (for MySQL) as an external pooler."}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"configuring-connection-pooling",children:"Configuring Connection Pooling"}),"\n",(0,s.jsx)(e.p,{children:"You can configure pooling via the connection string:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-env",children:'# Basic connection string\r\nDATABASE_URL="postgresql://user:password@localhost:5432/mydb"\r\n\r\n# With pooling options\r\nDATABASE_URL="postgresql://user:password@localhost:5432/mydb?connection_limit=10&pool_timeout=30"\n'})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"connection_limit=10"})," \u2192 max 10 connections in pool."]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"pool_timeout=30"})," \u2192 wait 30s for a free connection before erroring."]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"example-of-connection-pooling",children:"Example of Connection Pooling"}),"\n",(0,s.jsx)(e.h3,{id:"query-without-pooling-serverless-issue",children:"Query without pooling (serverless issue)"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:"// \u274c Not using pooling correctly in serverless\r\nexport default async function handler(req, res) {\r\n  const prisma = new PrismaClient();\r\n  const users = await prisma.user.findMany();\r\n  res.json(users);\r\n}\n"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Each request creates a new PrismaClient."}),"\n",(0,s.jsx)(e.li,{children:"Each client opens multiple DB connections."}),"\n",(0,s.jsx)(e.li,{children:"In high traffic, DB can exceed its max connections and crash."}),"\n"]}),"\n",(0,s.jsx)(e.h3,{id:"optimized-example-with-pooling",children:"Optimized Example with Pooling"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-ts",children:'// \u2705 Correct: Reuse PrismaClient instance\r\nimport { PrismaClient } from "@prisma/client";\r\n\r\nlet prisma: PrismaClient;\r\n\r\ndeclare global {\r\n  var prisma: PrismaClient | undefined;\r\n}\r\n\r\nif (!global.prisma) {\r\n  global.prisma = new PrismaClient();\r\n}\r\nprisma = global.prisma;\r\n\r\nexport default async function handler(req, res) {\r\n  const users = await prisma.user.findMany();\r\n  res.json(users);\r\n}\n'})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Only one PrismaClient instance is reused."}),"\n",(0,s.jsx)(e.li,{children:"Prevents connection storming."}),"\n",(0,s.jsx)(e.li,{children:"Database connections are pooled and reused."}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"connection-pooling-with-pgbouncer-postgresql-example",children:"Connection Pooling with PgBouncer (PostgreSQL Example)"}),"\n",(0,s.jsx)(e.p,{children:"In serverless or multi-instance apps, you should use PgBouncer for more stable pooling."}),"\n",(0,s.jsx)(e.p,{children:"Connection string via PgBouncer:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-env",children:'DATABASE_URL="postgresql://user:password@pgbouncer-host:6432/mydb"\n'})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"Instead of connecting directly to PostgreSQL, Prisma connects through PgBouncer."}),"\n",(0,s.jsx)(e.li,{children:"PgBouncer maintains a stable pool of connections."}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"monitoring-connection-pool",children:"Monitoring Connection Pool"}),"\n",(0,s.jsx)(e.p,{children:"You should monitor pool usage to avoid bottlenecks."}),"\n",(0,s.jsx)(e.p,{children:"For PostgreSQL:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sl",children:"SELECT * FROM pg_stat_activity;\n"})}),"\n",(0,s.jsx)(e.p,{children:"For MySQL:"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-sql",children:"SHOW PROCESSLIST;\n"})}),"\n",(0,s.jsx)(e.p,{children:"You can check:"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"How many connections are active."}),"\n",(0,s.jsx)(e.li,{children:"Whether connections are waiting (indicating pool size too small)."}),"\n"]})]})}function p(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(d,{...n})}):d(n)}}}]);