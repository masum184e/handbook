"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[4035],{17198(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"redis/Persistence","title":"Persistence","description":"Redis Database Backup","source":"@site/docs/redis/7. Persistence.md","sourceDirName":"redis","slug":"/redis/Persistence","permalink":"/handbook/docs/redis/Persistence","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7},"sidebar":"redisApiSidebar","previous":{"title":"Key Management","permalink":"/handbook/docs/redis/Key Management"},"next":{"title":"Pub/Sub","permalink":"/handbook/docs/redis/Pub_Sub"}}');var r=s(74848),l=s(28453);const d={sidebar_position:7},a=void 0,c={},o=[{value:"Redis Database Backup",id:"redis-database-backup",level:2},{value:"How RDB Works",id:"how-rdb-works",level:3},{value:"Configuring RDB in <code>redis.conf</code>",id:"configuring-rdb-in-redisconf",level:3},{value:"Performance Considerations",id:"performance-considerations",level:3},{value:"Append Only File",id:"append-only-file",level:2},{value:"Configuring AOF in redis.conf",id:"configuring-aof-in-redisconf",level:3},{value:"Recovery with AOF",id:"recovery-with-aof",level:3},{value:"Commands for Managing AOF",id:"commands-for-managing-aof",level:3},{value:"Hybrid Persistence",id:"hybrid-persistence",level:2},{value:"How Hybrid Persistence Works",id:"how-hybrid-persistence-works",level:3},{value:"Configuring Hybrid Persistence",id:"configuring-hybrid-persistence",level:3},{value:"Check AOF File",id:"check-aof-file",level:3},{value:"Restart Redis",id:"restart-redis",level:3},{value:"Performance",id:"performance",level:3},{value:"Backup &amp; Restore Strategies",id:"backup--restore-strategies",level:2},{value:"Restore from RDB",id:"restore-from-rdb",level:3},{value:"Restore from AOF",id:"restore-from-aof",level:3},{value:"Restore from Hybrid Persistence",id:"restore-from-hybrid-persistence",level:3},{value:"Example Workflow of Backup",id:"example-workflow-of-backup",level:3}];function t(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"redis-database-backup",children:"Redis Database Backup"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"RDB (Redis Database Backup) is one of the two main persistence mechanisms in Redis (the other is AOF)."}),"\n",(0,r.jsxs)(n.li,{children:["It works by taking point-in-time snapshots of your dataset and saving them to disk as a binary file (",(0,r.jsx)(n.code,{children:"dump.rdb"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"These snapshots can later be loaded when Redis restarts \u2192 ensuring data durability."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Think of it like taking a photo of your data at specific intervals."}),"\n",(0,r.jsx)(n.h3,{id:"how-rdb-works",children:"How RDB Works"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"When certain conditions are met, Redis forks a background process."}),"\n",(0,r.jsxs)(n.li,{children:["This process writes the entire dataset from memory into an RDB file (",(0,r.jsx)(n.code,{children:"dump.rdb"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Redis keeps serving clients during this snapshot (thanks to forking)."}),"\n"]}),"\n",(0,r.jsxs)(n.h3,{id:"configuring-rdb-in-redisconf",children:["Configuring RDB in ",(0,r.jsx)(n.code,{children:"redis.conf"})]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Automatic Snapshots"}),"\n",(0,r.jsx)(n.p,{children:"Defined using save rules:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"save 900 1      # Snapshot if 1 key changed in 900 seconds (15 min)\r\nsave 300 10     # Snapshot if 10 keys changed in 300 seconds (5 min)\r\nsave 60 10000   # Snapshot if 10000 keys changed in 60 seconds\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Format: ",(0,r.jsx)(n.code,{children:"save <seconds> <changes>"})]}),"\n",(0,r.jsx)(n.li,{children:"You can define multiple rules."}),"\n",(0,r.jsx)(n.li,{children:"To disable RDB snapshots:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'save ""\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"RDB File Settings"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"dbfilename dump.rdb        # Default snapshot file name\r\ndir /var/lib/redis/        # Directory to save RDB files\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Manual Snapshots"}),"\n",(0,r.jsx)(n.p,{children:"You can force snapshots with commands:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"SAVE"})," \u2192 Creates snapshot in main thread (blocks clients)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"BGSAVE"})," \u2192 Forks a background process (non-blocking, preferred)."]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"127.0.0.1:6379> BGSAVE\r\nBackground saving started\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The file ",(0,r.jsx)(n.code,{children:"dump.rdb"})," will be created in your Redis data directory."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"performance-considerations",children:"Performance Considerations"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Advantages of RDB"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Compact binary format \u2192 good for backups & replication."}),"\n",(0,r.jsx)(n.li,{children:"Faster recovery time compared to AOF."}),"\n",(0,r.jsx)(n.li,{children:"Low overhead during normal operations (most work is done in background)."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Drawbacks"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Data loss risk \u2192 since snapshots happen at intervals, any changes after the last snapshot may be lost if Redis crashes.\r\n(e.g., if snapshot every 5 minutes, and crash happens after 4 minutes, you lose last 4 minutes of data)."}),"\n",(0,r.jsx)(n.li,{children:"Forking can be expensive for very large datasets (can cause CPU + memory spikes)."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"append-only-file",children:"Append Only File"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"AOF (Append Only File) is a persistence method where every write operation Redis executes is logged to a file."}),"\n",(0,r.jsxs)(n.li,{children:["Instead of taking snapshots (like RDB), Redis appends commands to a log file (",(0,r.jsx)(n.code,{children:"appendonly.aof"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"On restart, Redis replays the log to rebuild the dataset."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Think of it as a black box recorder \u2014 every change is stored so nothing is lost."}),"\n",(0,r.jsx)(n.h3,{id:"configuring-aof-in-redisconf",children:"Configuring AOF in redis.conf"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Enable AOF"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:'appendonly yes\r\nappendfilename "appendonly.aof"\n'})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Sync Policy (",(0,r.jsx)(n.code,{children:"appendfsync"}),")"]}),"\n",(0,r.jsx)(n.p,{children:"This controls how often Redis writes AOF changes to disk:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"appendfsync always      # Write every command to disk immediately (safest, slowest)\r\nappendfsync everysec    # Default: write once per second (good balance)\r\nappendfsync no          # Let OS decide when to flush (fastest, risky)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Most production systems use ",(0,r.jsx)(n.code,{children:"everysec"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Rewrite Policy"}),"\n",(0,r.jsx)(n.p,{children:"Since AOF keeps growing, Redis rewrites the log periodically to compact it.\r\nSettings:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"auto-aof-rewrite-percentage 100   # Rewrite when AOF file is 100% larger than last rewrite\r\nauto-aof-rewrite-min-size 64mb    # Minimum file size before rewriting\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"recovery-with-aof",children:"Recovery with AOF"}),"\n",(0,r.jsx)(n.p,{children:"When Redis restarts:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"It reads the AOF file."}),"\n",(0,r.jsx)(n.li,{children:"Replays the commands one by one."}),"\n",(0,r.jsx)(n.li,{children:"Reconstructs the dataset in memory."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["This guarantees minimal data loss (at most 1 second if using ",(0,r.jsx)(n.code,{children:"everysec"}),")."]}),"\n",(0,r.jsx)(n.h3,{id:"commands-for-managing-aof",children:"Commands for Managing AOF"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Rewrite AOF manually: ",(0,r.jsx)(n.code,{children:"BGREWRITEAOF"}),". Creates a new compact AOF file in the background."]}),"\n",(0,r.jsxs)(n.li,{children:["Check AOF status: ",(0,r.jsx)(n.code,{children:"CONFIG GET appendonly"})]}),"\n",(0,r.jsxs)(n.li,{children:["Enable AOF at runtime: ",(0,r.jsx)(n.code,{children:"CONFIG SET appendonly yes"})]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"hybrid-persistence",children:"Hybrid Persistence"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Redis originally supported RDB (snapshots) and AOF (append-only file) separately."}),"\n",(0,r.jsx)(n.li,{children:"Since Redis 4.0, a hybrid persistence mode was introduced."}),"\n",(0,r.jsx)(n.li,{children:"It stores a binary RDB snapshot (fast to reload) plus AOF logs (for recent changes)."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Think of it as:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Take a photo (RDB) of the dataset \u2192 fast to recover."}),"\n",(0,r.jsx)(n.li,{children:"Record the video (AOF) of changes after that snapshot \u2192 durable with minimal data loss."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The combined persistence file is written to AOF."}),"\n",(0,r.jsx)(n.h3,{id:"how-hybrid-persistence-works",children:"How Hybrid Persistence Works"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Redis periodically creates RDB snapshots."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Instead of writing only commands to AOF, Redis writes:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"The latest RDB snapshot (as binary dump)."}),"\n",(0,r.jsx)(n.li,{children:"Plus incremental AOF commands since that snapshot."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"On restart, Redis:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Loads the RDB part (fast load)."}),"\n",(0,r.jsx)(n.li,{children:"Replays the AOF portion (ensures recent durability)."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"configuring-hybrid-persistence",children:"Configuring Hybrid Persistence"}),"\n",(0,r.jsxs)(n.p,{children:["In ",(0,r.jsx)(n.code,{children:"redis.conf"}),", enable AOF persistence and allow RDB preamble:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-conf",children:"appendonly yes\r\naof-use-rdb-preamble yes\r\nappendfsync everysec\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"appendonly yes"})," \u2192 Enables AOF logging."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"aof-use-rdb-preamble yes"})," \u2192 Hybrid persistence ON (default since Redis 4.0)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"appendfsync everysec"})," \u2192 Sync once per second (balance durability + performance)."]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"check-aof-file",children:"Check AOF File"}),"\n",(0,r.jsxs)(n.p,{children:["Open ",(0,r.jsx)(n.code,{children:"appendonly.aof"})," \u2192 you\u2019ll see it begins with an RDB binary block, followed by AOF commands:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"<binary RDB data>\r\n*3\r\n$3\r\nSET\r\n$6\r\nuser:2\r\n$6\r\nBillah\n"})}),"\n",(0,r.jsx)(n.p,{children:"The first part is RDB, the rest are AOF commands."}),"\n",(0,r.jsx)(n.h3,{id:"restart-redis",children:"Restart Redis"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo systemctl restart redis-server\n"})}),"\n",(0,r.jsx)(n.p,{children:"Redis reloads:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"RDB portion (fast load of bulk data)."}),"\n",(0,r.jsx)(n.li,{children:"AOF portion (applies latest changes)."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"performance",children:"Performance"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Advantages of Hybrid Persistence"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Faster restart than pure AOF (thanks to RDB snapshot)."}),"\n",(0,r.jsx)(n.li,{children:"More durable than pure RDB (thanks to AOF tail)."}),"\n",(0,r.jsx)(n.li,{children:"Smaller AOF files (since bulk dataset is stored as RDB)."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Drawbacks"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Slightly more complex than pure RDB or AOF."}),"\n",(0,r.jsx)(n.li,{children:"Still some performance overhead compared to RDB-only."}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"backup--restore-strategies",children:"Backup & Restore Strategies"}),"\n",(0,r.jsx)(n.h3,{id:"restore-from-rdb",children:"Restore from RDB"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Stop Redis server:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo systemctl stop redis-server\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsxs)(n.li,{children:["Replace the current ",(0,r.jsx)(n.code,{children:"dump.rdb"})," with your backup:"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cp /backups/dump-2025-09-04.rdb /var/lib/redis/dump.rdb\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:"Restart Redis:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo systemctl start redis-server\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsx)(n.li,{children:"Verify:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"redis-cli GET user:1\n"})}),"\n",(0,r.jsx)(n.h3,{id:"restore-from-aof",children:"Restore from AOF"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Stop Redis:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo systemctl stop redis-server\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsxs)(n.li,{children:["Replace ",(0,r.jsx)(n.code,{children:"appendonly.aof"})," with your backup:"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cp /backups/appendonly-2025-09-04.aof /var/lib/redis/appendonly.aof\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:"Restart Redis \u2192 Redis will replay all commands from AOF."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"restore-from-hybrid-persistence",children:"Restore from Hybrid Persistence"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Stop Redis."}),"\n",(0,r.jsx)(n.li,{children:"Copy backup AOF (with RDB preamble) into place."}),"\n",(0,r.jsx)(n.li,{children:"Restart Redis \u2192 it loads the RDB snapshot, then replays the AOF tail."}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"example-workflow-of-backup",children:"Example Workflow of Backup"}),"\n",(0,r.jsx)(n.p,{children:"Backup (Daily RDB Backup with Cron)"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"0 2 * * * redis-cli BGSAVE && cp /var/lib/redis/dump.rdb /backups/dump-$(date +\\%F).rdb\n"})}),"\n",(0,r.jsx)(n.p,{children:"Runs every day at 2 AM."}),"\n",(0,r.jsx)(n.p,{children:"Restore"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"sudo systemctl stop redis-server\r\ncp /backups/dump-2025-09-04.rdb /var/lib/redis/dump.rdb\r\nsudo systemctl start redis-server\n"})})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(t,{...e})}):t(e)}},28453(e,n,s){s.d(n,{R:()=>d,x:()=>a});var i=s(96540);const r={},l=i.createContext(r);function d(e){const n=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),i.createElement(l.Provider,{value:n},e.children)}}}]);