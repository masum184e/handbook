"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[543],{28453(e,n,i){i.d(n,{R:()=>r,x:()=>t});var s=i(96540);const c={},l=s.createContext(c);function r(e){const n=s.useContext(l);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:r(e.components),s.createElement(l.Provider,{value:n},e.children)}},29274(e,n,i){i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"redis/Transactions","title":"Transactions","description":"MULTI, EXEC, DISCARD, WATCH","source":"@site/docs/redis/9. Transactions.md","sourceDirName":"redis","slug":"/redis/Transactions","permalink":"/handbook/docs/redis/Transactions","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":9,"frontMatter":{}}');var c=i(74848),l=i(28453);const r={},t=void 0,o={},a=[{value:"MULTI, EXEC, DISCARD, WATCH",id:"multi-exec-discard-watch",level:2},{value:"<code>MULTI</code>",id:"multi",level:3},{value:"<code>EXEC</code>",id:"exec",level:3},{value:"<code>DISCARD</code>",id:"discard",level:3},{value:"<code>WATCH</code>",id:"watch",level:3},{value:"Preventing Race Conditions with WATCH",id:"preventing-race-conditions-with-watch",level:3},{value:"Transaction Flow Summary",id:"transaction-flow-summary",level:3},{value:"Optimistic Locking",id:"optimistic-locking",level:2},{value:"How Optimistic Locking Works",id:"how-optimistic-locking-works",level:3},{value:"Bank Account Transfer",id:"bank-account-transfer",level:3},{value:"Ensuring atomic operations",id:"ensuring-atomic-operations",level:2},{value:"How Redis Ensures Atomicity",id:"how-redis-ensures-atomicity",level:3},{value:"Examples of Atomic Operations",id:"examples-of-atomic-operations",level:3},{value:"Tips to Ensure Atomicity in Redis",id:"tips-to-ensure-atomicity-in-redis",level:3}];function d(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.h2,{id:"multi-exec-discard-watch",children:"MULTI, EXEC, DISCARD, WATCH"}),"\n",(0,c.jsx)(n.p,{children:"A transaction in Redis is a sequence of commands that are executed in order, as a single isolated operation."}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"It ensures atomicity \u2192 either all commands execute or none do."}),"\n",(0,c.jsxs)(n.li,{children:["Transactions in Redis use the commands:","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"MULTI"})," \u2192 Start a transaction"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"EXEC"})," \u2192 Execute the transaction"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"DISCARD"})," \u2192 Cancel the transaction"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"WATCH"})," \u2192 Watch keys for changes (optimistic locking)"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"multi",children:(0,c.jsx)(n.code,{children:"MULTI"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Marks the start of a transaction."}),"\n",(0,c.jsxs)(n.li,{children:["After ",(0,c.jsx)(n.code,{children:"MULTI"}),", commands are queued, not executed immediately."]}),"\n",(0,c.jsxs)(n.li,{children:["The queued commands will run only when ",(0,c.jsx)(n.code,{children:"EXEC"})," is called."]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:'MULTI\r\nSET user:1 "Masum"\r\nINCR counter\r\nEXEC\n'})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"MULTI"})," \u2192 starts transaction"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"SET"})," and ",(0,c.jsx)(n.code,{children:"INCR"})," are queued"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"EXEC"})," \u2192 executes both in sequence"]}),"\n",(0,c.jsx)(n.li,{children:"Atomicity ensures that either both run successfully or none run"}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"exec",children:(0,c.jsx)(n.code,{children:"EXEC"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["Executes all commands queued after ",(0,c.jsx)(n.code,{children:"MULTI"}),"."]}),"\n",(0,c.jsx)(n.li,{children:"If a command fails (like syntax error), only that command fails, but others run."}),"\n",(0,c.jsx)(n.li,{children:"The whole transaction is atomic from an isolation perspective \u2192 no other client\u2019s command can interleave between them."}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"discard",children:(0,c.jsx)(n.code,{children:"DISCARD"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Cancels a transaction."}),"\n",(0,c.jsxs)(n.li,{children:["Clears all commands queued after ",(0,c.jsx)(n.code,{children:"MULTI"}),"."]}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"watch",children:(0,c.jsx)(n.code,{children:"WATCH"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Provides optimistic locking."}),"\n",(0,c.jsxs)(n.li,{children:["You can ",(0,c.jsx)(n.code,{children:"WATCH"})," one or more keys."]}),"\n",(0,c.jsxs)(n.li,{children:["If any watched key is modified by another client before ",(0,c.jsx)(n.code,{children:"EXEC"}),", the transaction is aborted (returns ",(0,c.jsx)(n.code,{children:"nil"}),")."]}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"Useful for implementing check-and-set (CAS) logic."}),"\n",(0,c.jsx)(n.h3,{id:"preventing-race-conditions-with-watch",children:"Preventing Race Conditions with WATCH"}),"\n",(0,c.jsx)(n.p,{children:"Client A:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"WATCH balance\r\nval = GET balance   # suppose balance = 100\r\nMULTI\r\nSET balance 90      # deduct 10\r\nEXEC\n"})}),"\n",(0,c.jsxs)(n.p,{children:["If Client B modifies ",(0,c.jsx)(n.code,{children:"balance"})," before Client A executes ",(0,c.jsx)(n.code,{children:"EXEC"}),":"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"SET balance 50\n"})}),"\n",(0,c.jsxs)(n.p,{children:["Then Client A\u2019s ",(0,c.jsx)(n.code,{children:"EXEC"})," will fail:"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"(nil)\n"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"WATCH"})," balance \u2192 monitors the ",(0,c.jsx)(n.code,{children:"balance"})," key."]}),"\n",(0,c.jsxs)(n.li,{children:["Since another client modified it before ",(0,c.jsx)(n.code,{children:"EXEC"}),", Redis aborts the transaction."]}),"\n",(0,c.jsx)(n.li,{children:"This prevents race conditions (like double spending)."}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"transaction-flow-summary",children:"Transaction Flow Summary"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"WATCH key1 key2"})," \u2192 (optional) watch keys for changes."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"MULTI"})," \u2192 start transaction."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"Queue"})," commands (",(0,c.jsx)(n.code,{children:"SET"}),", ",(0,c.jsx)(n.code,{children:"INCR"}),", etc.)."]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"EXEC"})," \u2192 execute transaction if watched keys unchanged.","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"If watched keys were modified \u2192 transaction aborts."}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"DISCARD"})," \u2192 cancel transaction manually if needed."]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"optimistic-locking",children:"Optimistic Locking"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Optimistic locking is a technique to handle concurrent updates safely without using traditional locks."}),"\n",(0,c.jsxs)(n.li,{children:["In Redis, it is implemented via the ",(0,c.jsx)(n.code,{children:"WATCH"})," command."]}),"\n",(0,c.jsx)(n.li,{children:"The idea: \u201cI hope no one else changes this key while I\u2019m working on it.\u201d"}),"\n",(0,c.jsx)(n.li,{children:"If the key changes before the transaction executes, Redis aborts the transaction to prevent race conditions."}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"This is particularly useful in high-concurrency environments like counters, wallets, or stock management."}),"\n",(0,c.jsx)(n.h3,{id:"how-optimistic-locking-works",children:"How Optimistic Locking Works"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"WATCH keys \u2192 Redis monitors these keys."}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"Read the key(s) \u2192 get their current values."}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"MULTI \u2192 start a transaction and queue commands."}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"EXEC \u2192 attempt to execute transaction."}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["If any watched key changed since ",(0,c.jsx)(n.code,{children:"WATCH"}),", transaction fails (returns ",(0,c.jsx)(n.code,{children:"nil"}),")."]}),"\n",(0,c.jsx)(n.li,{children:"Otherwise, all queued commands execute atomically."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"Key point: Optimistic locking is non-blocking. Other clients can still read/write the key; your transaction simply aborts if conflict occurs."}),"\n",(0,c.jsx)(n.h3,{id:"bank-account-transfer",children:"Bank Account Transfer"}),"\n",(0,c.jsx)(n.p,{children:"Imagine we want to deduct $10 from Alice\u2019s balance safely, even if multiple clients try to modify it."}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:["Setup: ",(0,c.jsx)(n.code,{children:"SET balance:alice 100"})]}),"\n",(0,c.jsx)(n.li,{children:"Safe Deduction Using WATCH"}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"WATCH balance:alice         # Monitor the key\r\n\r\nval = GET balance:alice      # Suppose val = 100\r\nif val >= 10:\r\n    MULTI                    # Start transaction\r\n    DECRBY balance:alice 10  # Deduct 10\r\n    EXEC                     # Attempt to execute transaction\n"})}),"\n",(0,c.jsx)(n.p,{children:"Scenario 1: No other client modifies balance"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"EXEC"})," succeeds \u2192 balance becomes 90."]}),"\n"]}),"\n",(0,c.jsx)(n.p,{children:"Scenario 2: Another client modifies balance before EXEC"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"SET balance:alice 50\n"})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"EXEC"})," fails \u2192 returns (",(0,c.jsx)(n.code,{children:"nil"}),")"]}),"\n",(0,c.jsx)(n.li,{children:"You can retry the transaction if needed."}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"ensuring-atomic-operations",children:"Ensuring atomic operations"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Atomic operations are operations that are completed entirely or not at all, with no interference from other clients."}),"\n",(0,c.jsx)(n.li,{children:"In Redis, atomicity is built into many commands by default."}),"\n",(0,c.jsxs)(n.li,{children:["For example, commands like ",(0,c.jsx)(n.code,{children:"INCR"}),", ",(0,c.jsx)(n.code,{children:"DECR"}),", ",(0,c.jsx)(n.code,{children:"SETNX"}),", ",(0,c.jsx)(n.code,{children:"HSET"}),", and list operations like ",(0,c.jsx)(n.code,{children:"LPUSH"})," are atomic."]}),"\n",(0,c.jsx)(n.li,{children:"This means you don\u2019t need a transaction for single operations, even in a concurrent environment."}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"how-redis-ensures-atomicity",children:"How Redis Ensures Atomicity"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"Single-threaded execution:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Redis runs commands one at a time on a single main thread.\r\nThis ensures no two commands from different clients can interleave."}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"MULTI/EXEC transactions:"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["For multi-command operations, you can use ",(0,c.jsx)(n.code,{children:"MULTI"})," \u2192 ",(0,c.jsx)(n.code,{children:"EXEC"}),"."]}),"\n",(0,c.jsxs)(n.li,{children:["Redis executes all queued commands atomically after ",(0,c.jsx)(n.code,{children:"EXEC"}),"."]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:["Optimistic locking (",(0,c.jsx)(n.code,{children:"WATCH"}),"):"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsx)(n.li,{children:"Ensures atomicity when you need to check a key\u2019s value before modifying it."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"examples-of-atomic-operations",children:"Examples of Atomic Operations"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"Atomic INCR"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"SET counter 0\r\nINCR counter\n"})}),"\n",(0,c.jsxs)(n.p,{children:["Even if multiple clients run ",(0,c.jsx)(n.code,{children:"INCR counter"})," simultaneously, Redis ensures each increment is applied exactly once."]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"Atomic Check-and-Set (SETNX)"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:'SETNX lock "1"\n'})}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"SETNX"}),' = "SET if Not eXists"']}),"\n",(0,c.jsxs)(n.li,{children:["If the key doesn\u2019t exist \u2192 sets it and returns ",(0,c.jsx)(n.code,{children:"1"})]}),"\n",(0,c.jsxs)(n.li,{children:["If the key exists \u2192 does nothing and returns ",(0,c.jsx)(n.code,{children:"0"})]}),"\n",(0,c.jsx)(n.li,{children:"Useful for implementing distributed locks safely."}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"Atomic Multi-Key Operation with Transaction"}),"\n",(0,c.jsx)(n.p,{children:"Suppose you want to transfer money from Alice to Bob:"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:"WATCH balance:alice balance:bob   # Watch keys for changes\r\nalice_balance = GET balance:alice\r\n\r\nif alice_balance >= 10:\r\n    MULTI\r\n    DECRBY balance:alice 10\r\n    INCRBY balance:bob 10\r\n    EXEC\r\nelse:\r\n    DISCARD\n"})}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"MULTI"})," \u2192 queue multiple commands"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"EXEC"})," \u2192 executes all commands atomically"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.code,{children:"WATCH"})," \u2192 ensures no one else modifies balances during this transaction"]}),"\n"]}),"\n",(0,c.jsxs)(n.ol,{start:"4",children:["\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsx)(n.p,{children:"Atomic List Operation"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-bash",children:'LPUSH queue "task1"\n'})}),"\n",(0,c.jsx)(n.p,{children:"Even if multiple clients push to the same list simultaneously, Redis ensures each push is atomic."}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"tips-to-ensure-atomicity-in-redis",children:"Tips to Ensure Atomicity in Redis"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsx)(n.li,{children:"Use single commands whenever possible \u2192 they are already atomic."}),"\n",(0,c.jsxs)(n.li,{children:["For multiple commands on related keys, use ",(0,c.jsx)(n.code,{children:"MULTI/EXEC"})," to group them."]}),"\n",(0,c.jsxs)(n.li,{children:["Use ",(0,c.jsx)(n.code,{children:"WATCH"})," if you need to implement conditional updates safely."]}),"\n",(0,c.jsx)(n.li,{children:"Avoid long-running scripts or operations inside transactions \u2192 can block other clients."}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(d,{...e})}):d(e)}}}]);