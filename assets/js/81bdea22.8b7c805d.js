"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[14358],{28453(e,s,n){n.d(s,{R:()=>t,x:()=>d});var r=n(96540);const i={},l=r.createContext(i);function t(e){const s=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function d(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),r.createElement(l.Provider,{value:s},e.children)}},93292(e,s,n){n.r(s),n.d(s,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"rust/Web Application/Databases","title":"Databases","description":"Two Main Approaches in Rust","source":"@site/docs/rust/Web Application/3. Databases.md","sourceDirName":"rust/Web Application","slug":"/rust/Web Application/Databases","permalink":"/handbook/docs/rust/Web Application/Databases","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{}}');var i=n(74848),l=n(28453);const t={},d=void 0,a={},c=[{value:"Two Main Approaches in Rust",id:"two-main-approaches-in-rust",level:2},{value:"Diesel \u2014 Strongly Typed ORM",id:"diesel--strongly-typed-orm",level:2},{value:"Step 1: Dependencies (<code>Cargo.toml</code>)",id:"step-1-dependencies-cargotoml",level:3},{value:"Step 2: Database Setup (PostgreSQL)",id:"step-2-database-setup-postgresql",level:3},{value:"Step 3: Diesel Schema (<code>schema.rs</code>)",id:"step-3-diesel-schema-schemars",level:3},{value:"Step 4: Rust Models (<code>models.rs</code>)",id:"step-4-rust-models-modelsrs",level:3},{value:"Step 5: Database Operations (<code>main.rs</code>)",id:"step-5-database-operations-mainrs",level:3},{value:"SQLx \u2014 Async, SQL-First Library",id:"sqlx--async-sql-first-library",level:2},{value:"Step 1: Dependencies (<code>Cargo.toml</code>)",id:"step-1-dependencies-cargotoml-1",level:3},{value:"Step 2: Database Setup",id:"step-2-database-setup",level:2},{value:"Step 3: Rust Code (<code>main.rs</code>)",id:"step-3-rust-code-mainrs",level:3},{value:"Diesel vs SQLx \u2014 Comparison",id:"diesel-vs-sqlx--comparison",level:2},{value:"Which One Should You Use?",id:"which-one-should-you-use",level:2}];function o(e){const s={code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.h2,{id:"two-main-approaches-in-rust",children:"Two Main Approaches in Rust"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Approach"}),(0,i.jsx)(s.th,{children:"Example Library"}),(0,i.jsx)(s.th,{children:"Description"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"ORM (Object Relational Mapper)"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.strong,{children:"Diesel"})}),(0,i.jsx)(s.td,{children:"Maps database tables \u2192 Rust structs"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Query-based (SQL-first)"}),(0,i.jsx)(s.td,{children:(0,i.jsx)(s.strong,{children:"SQLx"})}),(0,i.jsx)(s.td,{children:"You write raw SQL but get compile-time safety"})]})]})]}),"\n",(0,i.jsx)(s.h2,{id:"diesel--strongly-typed-orm",children:"Diesel \u2014 Strongly Typed ORM"}),"\n",(0,i.jsx)(s.p,{children:"Diesel is a type-safe ORM for Rust that:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Uses Rust structs to represent database tables."}),"\n",(0,i.jsx)(s.li,{children:"Prevents SQL errors at compile time."}),"\n",(0,i.jsx)(s.li,{children:"Uses migrations and schema generation."}),"\n",(0,i.jsx)(s.li,{children:"Works with PostgreSQL, MySQL, and SQLite."}),"\n"]}),"\n",(0,i.jsxs)(s.h3,{id:"step-1-dependencies-cargotoml",children:["Step 1: Dependencies (",(0,i.jsx)(s.code,{children:"Cargo.toml"}),")"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-toml",children:'[dependencies]\r\ndiesel = { version = "2.1.0", features = ["postgres", "r2d2"] }\r\ndotenvy = "0.15"\r\nserde = { version = "1", features = ["derive"] }\n'})}),"\n",(0,i.jsx)(s.h3,{id:"step-2-database-setup-postgresql",children:"Step 2: Database Setup (PostgreSQL)"}),"\n",(0,i.jsxs)(s.p,{children:["Create a ",(0,i.jsx)(s.code,{children:".env"})," file:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"DATABASE_URL=postgres://user:password@localhost/mydb\n"})}),"\n",(0,i.jsx)(s.p,{children:"Initialize Diesel:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{children:"diesel setup\r\ndiesel migration generate create_users\n"})}),"\n",(0,i.jsx)(s.p,{children:"Edit the migration files:"}),"\n",(0,i.jsx)(s.p,{children:(0,i.jsxs)(s.strong,{children:["Up migration (",(0,i.jsx)(s.code,{children:"up.sql"}),")"]})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"CREATE TABLE users (\r\n    id SERIAL PRIMARY KEY,\r\n    name TEXT NOT NULL,\r\n    email TEXT NOT NULL\r\n);\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Down migration (",(0,i.jsx)(s.code,{children:"down.sql"}),")"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"DROP TABLE users;\n"})}),"\n",(0,i.jsx)(s.p,{children:"Run:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sh",children:"diesel migration run\n"})}),"\n",(0,i.jsxs)(s.h3,{id:"step-3-diesel-schema-schemars",children:["Step 3: Diesel Schema (",(0,i.jsx)(s.code,{children:"schema.rs"}),")"]}),"\n",(0,i.jsx)(s.p,{children:"Diesel auto-generates:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-rust",children:"diesel::table! {\r\n    users (id) {\r\n        id -> Int4,\r\n        name -> Text,\r\n        email -> Text,\r\n    }\r\n}\n"})}),"\n",(0,i.jsxs)(s.h3,{id:"step-4-rust-models-modelsrs",children:["Step 4: Rust Models (",(0,i.jsx)(s.code,{children:"models.rs"}),")"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-rust",children:"use diesel::prelude::*;\r\nuse serde::{Deserialize, Serialize};\r\n\r\n#[derive(Queryable, Serialize)]\r\npub struct User {\r\n    pub id: i32,\r\n    pub name: String,\r\n    pub email: String,\r\n}\r\n\r\n#[derive(Insertable, Deserialize)]\r\n#[diesel(table_name = crate::schema::users)]\r\npub struct NewUser {\r\n    pub name: String,\r\n    pub email: String,\r\n}\n"})}),"\n",(0,i.jsxs)(s.h3,{id:"step-5-database-operations-mainrs",children:["Step 5: Database Operations (",(0,i.jsx)(s.code,{children:"main.rs"}),")"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-rust",children:'use diesel::prelude::*;\r\nuse diesel::pg::PgConnection;\r\nuse dotenvy::dotenv;\r\nuse std::env;\r\n\r\nmod schema;\r\nmod models;\r\n\r\nuse models::{User, NewUser};\r\nuse schema::users::dsl::*;\r\n\r\nfn establish_connection() -> PgConnection {\r\n    dotenv().ok();\r\n    let database_url = env::var("DATABASE_URL").expect("DATABASE_URL must be set");\r\n    PgConnection::establish(&database_url).expect("Error connecting to database")\r\n}\r\n\r\n// CREATE\r\nfn create_user(conn: &mut PgConnection, new_user: NewUser) -> User {\r\n    diesel::insert_into(users)\r\n        .values(&new_user)\r\n        .get_result(conn)\r\n        .expect("Error saving new user")\r\n}\r\n\r\n// READ\r\nfn get_users(conn: &mut PgConnection) -> Vec<User> {\r\n    users.load::<User>(conn).expect("Error loading users")\r\n}\r\n\r\nfn main() {\r\n    let conn = &mut establish_connection();\r\n\r\n    let user = create_user(conn, NewUser {\r\n        name: "Alice".to_string(),\r\n        email: "alice@example.com".to_string(),\r\n    });\r\n\r\n    println!("Created user: {:?}", user);\r\n\r\n    let all_users = get_users(conn);\r\n    println!("All users: {:?}", all_users);\r\n}\n'})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"Queryable"}),": Maps DB rows \u2192 Rust structs."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"Insertable"}),": Maps Rust struct \u2192 DB row."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"schema.rs"}),": Ensures compile-time SQL safety."]}),"\n",(0,i.jsx)(s.li,{children:"`Diesel prevents invalid queries at compile time."}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"sqlx--async-sql-first-library",children:"SQLx \u2014 Async, SQL-First Library"}),"\n",(0,i.jsx)(s.p,{children:"SQLx is an async, non-blocking, SQL-first database library that:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Uses raw SQL queries."}),"\n",(0,i.jsx)(s.li,{children:"Validates SQL at compile time."}),"\n",(0,i.jsx)(s.li,{children:"Supports PostgreSQL, MySQL, SQLite."}),"\n",(0,i.jsx)(s.li,{children:"Works perfectly with async web frameworks (Axum, Actix, Rocket)."}),"\n"]}),"\n",(0,i.jsxs)(s.h3,{id:"step-1-dependencies-cargotoml-1",children:["Step 1: Dependencies (",(0,i.jsx)(s.code,{children:"Cargo.toml"}),")"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-toml",children:'[dependencies]\r\nsqlx = { version = "0.7", features = ["runtime-tokio-rustls", "postgres", "macros"] }\r\ntokio = { version = "1", features = ["full"] }\r\nserde = { version = "1", features = ["derive"] }\r\ndotenvy = "0.15"\n'})}),"\n",(0,i.jsx)(s.h2,{id:"step-2-database-setup",children:"Step 2: Database Setup"}),"\n",(0,i.jsx)(s.p,{children:"Same database table:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-sql",children:"CREATE TABLE users (\r\n    id SERIAL PRIMARY KEY,\r\n    name TEXT NOT NULL,\r\n    email TEXT NOT NULL\r\n);\n"})}),"\n",(0,i.jsxs)(s.h3,{id:"step-3-rust-code-mainrs",children:["Step 3: Rust Code (",(0,i.jsx)(s.code,{children:"main.rs"}),")"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-rust",children:'use serde::{Deserialize, Serialize};\r\nuse sqlx::{PgPool, postgres::PgPoolOptions};\r\nuse dotenvy::dotenv;\r\nuse std::env;\r\n\r\n#[derive(Debug, Serialize, Deserialize, sqlx::FromRow)]\r\nstruct User {\r\n    id: i32,\r\n    name: String,\r\n    email: String,\r\n}\r\n\r\n#[tokio::main]\r\nasync fn main() -> Result<(), sqlx::Error> {\r\n    dotenv().ok();\r\n    let database_url = env::var("DATABASE_URL").expect("DATABASE_URL must be set");\r\n\r\n    let pool = PgPoolOptions::new()\r\n        .max_connections(5)\r\n        .connect(&database_url)\r\n        .await?;\r\n\r\n    // CREATE\r\n    let new_user = User {\r\n        id: 0,\r\n        name: "Bob".to_string(),\r\n        email: "bob@example.com".to_string(),\r\n    };\r\n\r\n    let created: User = sqlx::query_as!(\r\n        User,\r\n        "INSERT INTO users (name, email) VALUES ($1, $2) RETURNING id, name, email",\r\n        new_user.name,\r\n        new_user.email\r\n    )\r\n    .fetch_one(&pool)\r\n    .await?;\r\n\r\n    println!("Created user: {:?}", created);\r\n\r\n    // READ\r\n    let users: Vec<User> = sqlx::query_as!(\r\n        User,\r\n        "SELECT id, name, email FROM users"\r\n    )\r\n    .fetch_all(&pool)\r\n    .await?;\r\n\r\n    println!("All users: {:?}", users);\r\n\r\n    Ok(())\r\n}\n'})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"query_as!"}),": Checks SQL at compile time."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"$1"}),", ",(0,i.jsx)(s.code,{children:"$2"}),": Parameter placeholders."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"fetch_one"}),", fetch_all: Execute queries asynchronously."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.code,{children:"PgPool"}),": Connection pool for async operations."]}),"\n"]}),"\n",(0,i.jsx)(s.h2,{id:"diesel-vs-sqlx--comparison",children:"Diesel vs SQLx \u2014 Comparison"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Feature"}),(0,i.jsx)(s.th,{children:"Diesel"}),(0,i.jsx)(s.th,{children:"SQLx"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Style"}),(0,i.jsx)(s.td,{children:"ORM"}),(0,i.jsx)(s.td,{children:"SQL-first"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Async"}),(0,i.jsx)(s.td,{children:"\u274c Mostly sync"}),(0,i.jsx)(s.td,{children:"\u2705 Fully async"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Type Safety"}),(0,i.jsx)(s.td,{children:"Very high"}),(0,i.jsx)(s.td,{children:"Very high"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Learning Curve"}),(0,i.jsx)(s.td,{children:"Steeper"}),(0,i.jsx)(s.td,{children:"Easier for SQL users"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Best For"}),(0,i.jsx)(s.td,{children:"Complex data models, compile-time safety"}),(0,i.jsx)(s.td,{children:"Async web APIs, microservices"})]})]})]}),"\n",(0,i.jsx)(s.h2,{id:"which-one-should-you-use",children:"Which One Should You Use?"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["Choose Diesel if:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"You want ORM-style code."}),"\n",(0,i.jsx)(s.li,{children:"You prefer compile-time query generation."}),"\n",(0,i.jsx)(s.li,{children:"You\u2019re building complex relational models."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(s.li,{children:["Choose SQLx if:","\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"You want async database access."}),"\n",(0,i.jsx)(s.li,{children:"You prefer writing SQL directly."}),"\n",(0,i.jsx)(s.li,{children:"You\u2019re building modern REST APIs with Axum/Actix/Rocket."}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:s}={...(0,l.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}}}]);