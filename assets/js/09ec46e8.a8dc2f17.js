"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[17947],{28453(e,n,i){i.d(n,{R:()=>l,x:()=>c});var r=i(96540);const s={},t=r.createContext(s);function l(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),r.createElement(t.Provider,{value:n},e.children)}},58795(e,n,i){i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>a,frontMatter:()=>l,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"nginx/Priority Rules","title":"Priority Rules","description":"When a request comes in, NGINX may have multiple location blocks that could match.","source":"@site/docs/nginx/28. Priority Rules.md","sourceDirName":"nginx","slug":"/nginx/Priority Rules","permalink":"/handbook/docs/nginx/Priority Rules","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":28,"frontMatter":{},"sidebar":"nginxApiSidebar","previous":{"title":"Regex","permalink":"/handbook/docs/nginx/Regex"},"next":{"title":"Rewrite & Redirect","permalink":"/handbook/docs/nginx/Rewrite & Redirect"}}');var s=i(74848),t=i(28453);const l={},c=void 0,d={},o=[{value:"The 4 Location Types (in Priority Context)",id:"the-4-location-types-in-priority-context",level:2},{value:"The Actual Matching Algorithm (Step by Step)",id:"the-actual-matching-algorithm-step-by-step",level:2},{value:"1. Exact Match (<code>=</code>)",id:"1-exact-match-",level:3},{value:"2. Prefix Match with <code>^~</code>",id:"2-prefix-match-with-",level:3},{value:"3. Regex Matches (~, ~*)",id:"3-regex-matches--",level:3},{value:"4. Normal Prefix Matches",id:"4-normal-prefix-matches",level:3},{value:"Visual Priority Order (Memory Trick)",id:"visual-priority-order-memory-trick",level:2},{value:"Full Example with Multiple Matches",id:"full-example-with-multiple-matches",level:2},{value:"Request-by-Request Breakdown",id:"request-by-request-breakdown",level:2},{value:"Why <code>^~</code> Exists (Very Important)",id:"why--exists-very-important",level:2},{value:"Without <code>^~</code>:",id:"without-",level:3},{value:"Fix",id:"fix",level:3}];function h(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.p,{children:["When a request comes in, NGINX may have multiple ",(0,s.jsx)(n.code,{children:"location"})," blocks that could match.\r\nTo avoid ambiguity, NGINX follows a strict priority algorithm to select one\u2014and only one\u2014location."]}),"\n",(0,s.jsx)(n.h2,{id:"the-4-location-types-in-priority-context",children:"The 4 Location Types (in Priority Context)"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Type"}),(0,s.jsx)(n.th,{children:"Syntax"}),(0,s.jsx)(n.th,{children:"Priority"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Exact match"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"location = /path"})}),(0,s.jsx)(n.td,{children:"Highest"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsxs)(n.strong,{children:["Prefix match (",(0,s.jsx)(n.code,{children:"^~"}),")"]})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"location ^~ /path/"})}),(0,s.jsx)(n.td,{children:"High"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Regex match"})}),(0,s.jsxs)(n.td,{children:[(0,s.jsx)(n.code,{children:"location ~"}),", ",(0,s.jsx)(n.code,{children:"~*"})]}),(0,s.jsx)(n.td,{children:"Medium"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"Normal prefix match"})}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"location /path/"})}),(0,s.jsx)(n.td,{children:"Low (longest wins)"})]})]})]}),"\n",(0,s.jsx)(n.h2,{id:"the-actual-matching-algorithm-step-by-step",children:"The Actual Matching Algorithm (Step by Step)"}),"\n",(0,s.jsx)(n.p,{children:"NGINX processes locations in this exact order:"}),"\n",(0,s.jsxs)(n.h3,{id:"1-exact-match-",children:["1. Exact Match (",(0,s.jsx)(n.code,{children:"="}),")"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location = /login {\r\n    return 403;\r\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["If the request URI is exactly ",(0,s.jsx)(n.code,{children:"/login"})]}),"\n",(0,s.jsx)(n.li,{children:"NGINX immediately stops searching"}),"\n",(0,s.jsx)(n.li,{children:"No other locations are checked"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Nothing can override an exact match"}),"\n",(0,s.jsxs)(n.h3,{id:"2-prefix-match-with-",children:["2. Prefix Match with ",(0,s.jsx)(n.code,{children:"^~"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ^~ /static/ {\r\n    root /var/www/static;\r\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["NGINX checks prefix locations marked with ",(0,s.jsx)(n.code,{children:"^~"})]}),"\n",(0,s.jsxs)(n.li,{children:["If matched:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Regex checks are skipped entirely"}),"\n",(0,s.jsx)(n.li,{children:"This location is selected"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Used to protect important prefixes from regex overrides"}),"\n",(0,s.jsx)(n.h3,{id:"3-regex-matches--",children:"3. Regex Matches (~, ~*)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ~ \\.php$ {\r\n    fastcgi_pass php;\r\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Regex locations are tested in the order they appear"}),"\n",(0,s.jsx)(n.li,{children:"First matching regex wins"}),"\n",(0,s.jsx)(n.li,{children:"Order matters!"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Regex can override normal prefix matches"}),"\n",(0,s.jsx)(n.h3,{id:"4-normal-prefix-matches",children:"4. Normal Prefix Matches"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location /api/ {\r\n    proxy_pass http://api;\r\n}\r\n\r\nlocation / {\r\n    try_files $uri $uri/ =404;\r\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Among normal prefixes:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Longest matching prefix wins"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"/api/"})," beats ",(0,s.jsx)(n.code,{children:"/"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"visual-priority-order-memory-trick",children:"Visual Priority Order (Memory Trick)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"=   (Exact)\r\n^~  (Strong prefix)\r\n~   (Regex \u2013 first match wins)\r\n/  (Longest normal prefix)\n"})}),"\n",(0,s.jsx)(n.h2,{id:"full-example-with-multiple-matches",children:"Full Example with Multiple Matches"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"server {\r\n\r\n    location = /admin {\r\n        return 403;\r\n    }\r\n\r\n    location ^~ /static/ {\r\n        root /var/www/static;\r\n    }\r\n\r\n    location ~ \\.php$ {\r\n        fastcgi_pass php;\r\n    }\r\n\r\n    location /static/images/ {\r\n        root /var/www/images;\r\n    }\r\n\r\n    location / {\r\n        try_files $uri $uri/ =404;\r\n    }\r\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"request-by-request-breakdown",children:"Request-by-Request Breakdown"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Request 1: ",(0,s.jsx)(n.code,{children:"/admin"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Exact match exists"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"location = /admin"})," is selected"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Request 2: ",(0,s.jsx)(n.code,{children:"/static/logo.png"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Matches ",(0,s.jsx)(n.code,{children:"^~ /static/"})]}),"\n",(0,s.jsx)(n.li,{children:"Regex is skipped"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"/static/"})," location used"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Request 3: ",(0,s.jsx)(n.code,{children:"/static/images/a.php"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"^~ /static/"})," matches"]}),"\n",(0,s.jsx)(n.li,{children:"Regex is skipped"}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"/static/"})," (not ",(0,s.jsx)(n.code,{children:".php"}),")"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Request 4: ",(0,s.jsx)(n.code,{children:"/index.php"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"No exact match"}),"\n",(0,s.jsxs)(n.li,{children:["No ",(0,s.jsx)(n.code,{children:"^~"})," prefix"]}),"\n",(0,s.jsxs)(n.li,{children:["Regex ",(0,s.jsx)(n.code,{children:"\\.php$"})," matches"]}),"\n",(0,s.jsx)(n.li,{children:"PHP location selected"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Request 5: ",(0,s.jsx)(n.code,{children:"/about/team"})]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"No exact"}),"\n",(0,s.jsxs)(n.li,{children:["No ",(0,s.jsx)(n.code,{children:"^~"})]}),"\n",(0,s.jsx)(n.li,{children:"No regex"}),"\n",(0,s.jsxs)(n.li,{children:["Prefix ",(0,s.jsx)(n.code,{children:"/"})," used"]}),"\n",(0,s.jsx)(n.li,{children:"default handler"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"why--exists-very-important",children:["Why ",(0,s.jsx)(n.code,{children:"^~"})," Exists (Very Important)"]}),"\n",(0,s.jsxs)(n.h3,{id:"without-",children:["Without ",(0,s.jsx)(n.code,{children:"^~"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location /images/ {\r\n    root /var/www/images;\r\n}\r\n\r\nlocation ~ \\.jpg$ {\r\n    root /var/www/jpg;\r\n}\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Request: ",(0,s.jsx)(n.code,{children:"/images/photo.jpg"})]}),"\n",(0,s.jsx)(n.li,{children:"Regex wins \u2192 wrong directory"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"fix",children:"Fix"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"location ^~ /images/ {\r\n    root /var/www/images;\r\n}\n"})})]})}function a(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}}}]);