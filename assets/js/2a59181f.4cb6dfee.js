"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[99092],{28453(e,s,r){r.d(s,{R:()=>o,x:()=>a});var n=r(96540);const i={},t=n.createContext(i);function o(e){const s=n.useContext(t);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),n.createElement(t.Provider,{value:s},e.children)}},64995(e,s,r){r.r(s),r.d(s,{assets:()=>d,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"prisma/N+1 Problem","title":"N+1 Problem","description":"The N+1 problem happens when you:","source":"@site/docs/prisma/10. N+1 Problem.md","sourceDirName":"prisma","slug":"/prisma/N+1 Problem","permalink":"/handbook/docs/prisma/N+1 Problem","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":10,"frontMatter":{"sidebar_position":10},"sidebar":"prismaApiSidebar","previous":{"title":"Connection Pooling","permalink":"/handbook/docs/prisma/Connection Pooling"},"next":{"title":"Prisma Studio","permalink":"/handbook/docs/prisma/Prisma Studio"}}');var i=r(74848),t=r(28453);const o={sidebar_position:10},a=void 0,d={},l=[{value:"Example of the N+1 Problem in Prisma",id:"example-of-the-n1-problem-in-prisma",level:2},{value:"Optimized Solutions in Prisma",id:"optimized-solutions-in-prisma",level:2},{value:"Eager Loading",id:"eager-loading",level:3},{value:"Use <code>select</code> for Partial Data",id:"use-select-for-partial-data",level:3},{value:"Use <code>prisma.$transaction</code> for Batch Queries",id:"use-prismatransaction-for-batch-queries",level:3},{value:"Performance Comparison",id:"performance-comparison",level:2}];function c(e){const s={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.p,{children:"The N+1 problem happens when you:"}),"\n",(0,i.jsxs)(s.ol,{children:["\n",(0,i.jsx)(s.li,{children:"Fetch a list of records (1 query)."}),"\n",(0,i.jsx)(s.li,{children:"Then for each record, you fetch related data separately (N queries)."}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"This leads to 1 (main query) + N (sub-queries) \u2192 hence the name N+1 queries."}),"\n",(0,i.jsx)(s.p,{children:"Problem: For large datasets, this can blow up into hundreds or thousands of queries, causing slow response times and database overload."}),"\n",(0,i.jsx)(s.h2,{id:"example-of-the-n1-problem-in-prisma",children:"Example of the N+1 Problem in Prisma"}),"\n",(0,i.jsx)(s.p,{children:"Imagine you want to fetch users and their posts."}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-ts",children:"// Step 1: Fetch all users\r\nconst users = await prisma.user.findMany();\r\n\r\n// Step 2: For each user, fetch posts separately\r\nfor (const user of users) {\r\n  user.posts = await prisma.post.findMany({\r\n    where: { authorId: user.id },\r\n  });\r\n}\r\n\r\nconsole.log(users);\n"})}),"\n",(0,i.jsx)(s.p,{children:"If you have:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:["10 users \u2192 ",(0,i.jsx)(s.code,{children:"1 + 10 = 11 queries"})]}),"\n",(0,i.jsxs)(s.li,{children:["1000 users \u2192 ",(0,i.jsx)(s.code,{children:"1 + 1000 = 1001 queries"})]}),"\n"]}),"\n",(0,i.jsx)(s.p,{children:"This does not scale."}),"\n",(0,i.jsx)(s.h2,{id:"optimized-solutions-in-prisma",children:"Optimized Solutions in Prisma"}),"\n",(0,i.jsx)(s.h3,{id:"eager-loading",children:"Eager Loading"}),"\n",(0,i.jsxs)(s.p,{children:["Prisma can load related data in a single query using ",(0,i.jsx)(s.code,{children:"include"}),"."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-ts",children:"// Fetch users and their posts in one query\r\nconst users = await prisma.user.findMany({\r\n  include: {\r\n    posts: true, // eager load posts\r\n  },\r\n});\n"})}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Prisma sends a JOIN-like query (or two optimized queries)."}),"\n",(0,i.jsx)(s.li,{children:"Instead of fetching posts per user separately, all posts are fetched in one go."}),"\n"]}),"\n",(0,i.jsxs)(s.h3,{id:"use-select-for-partial-data",children:["Use ",(0,i.jsx)(s.code,{children:"select"})," for Partial Data"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-ts",children:"const users = await prisma.user.findMany({\r\n  include: {\r\n    posts: {\r\n      select: {\r\n        id: true,\r\n        title: true,\r\n      },\r\n    },\r\n  },\r\n});\n"})}),"\n",(0,i.jsxs)(s.h3,{id:"use-prismatransaction-for-batch-queries",children:["Use ",(0,i.jsx)(s.code,{children:"prisma.$transaction"})," for Batch Queries"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-ts",children:"const [users, posts] = await prisma.$transaction([\r\n  prisma.user.findMany(),\r\n  prisma.post.findMany(),\r\n]);\r\n\r\n// Map posts to users in memory\r\nconst userMap = users.map((user) => ({\r\n  ...user,\r\n  posts: posts.filter((p) => p.authorId === user.id),\r\n}));\n"})}),"\n",(0,i.jsx)(s.h2,{id:"performance-comparison",children:"Performance Comparison"}),"\n",(0,i.jsx)(s.p,{children:"Let\u2019s say we have 100 users, each with 10 posts:"}),"\n",(0,i.jsxs)(s.table,{children:[(0,i.jsx)(s.thead,{children:(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.th,{children:"Approach"}),(0,i.jsx)(s.th,{children:"Queries Sent"}),(0,i.jsx)(s.th,{children:"Notes"})]})}),(0,i.jsxs)(s.tbody,{children:[(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Naive (N+1)"}),(0,i.jsx)(s.td,{children:"101"}),(0,i.jsx)(s.td,{children:"1 for users + 100 for posts"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"include"})," (Eager Loading)"]}),(0,i.jsx)(s.td,{children:"1"}),(0,i.jsx)(s.td,{children:"Single optimized query"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsxs)(s.td,{children:[(0,i.jsx)(s.code,{children:"$transaction"})," batching"]}),(0,i.jsx)(s.td,{children:"2"}),(0,i.jsx)(s.td,{children:"One for users, one for posts"})]}),(0,i.jsxs)(s.tr,{children:[(0,i.jsx)(s.td,{children:"Dataloader batching"}),(0,i.jsx)(s.td,{children:"2"}),(0,i.jsx)(s.td,{children:"1 for users, 1 batched for posts"})]})]})]})]})}function h(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);