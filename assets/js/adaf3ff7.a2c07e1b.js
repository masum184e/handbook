"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[86167],{10025(n,e,s){s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"rust/Asynchronous/Async Runtimes","title":"Async Runtimes","description":"Why do we need an async runtime","source":"@site/docs/rust/Asynchronous/3. Async Runtimes.md","sourceDirName":"rust/Asynchronous","slug":"/rust/Asynchronous/Async Runtimes","permalink":"/handbook/docs/rust/Asynchronous/Async Runtimes","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"rustApiSidebar","previous":{"title":"Futures","permalink":"/handbook/docs/rust/Asynchronous/Futures"},"next":{"title":"Async I_O","permalink":"/handbook/docs/rust/Asynchronous/Async I_O"}}');var r=s(74848),l=s(28453);const t={},d=void 0,c={},o=[{value:"Why do we need an async runtime",id:"why-do-we-need-an-async-runtime",level:2},{value:"What is an async runtime?",id:"what-is-an-async-runtime",level:2},{value:"Core components of an async runtime",id:"core-components-of-an-async-runtime",level:2},{value:"Executor",id:"executor",level:3},{value:"Scheduler",id:"scheduler",level:3},{value:"Reactor (IO driver)",id:"reactor-io-driver",level:3},{value:"Timer system",id:"timer-system",level:3},{value:"Tokio runtime (industry standard)",id:"tokio-runtime-industry-standard",level:2},{value:"Example: Basic Tokio runtime",id:"example-basic-tokio-runtime",level:3},{value:"What <code>#[tokio::main]</code> does",id:"what-tokiomain-does",level:3},{value:"Tokio task spawning and scheduling",id:"tokio-task-spawning-and-scheduling",level:2},{value:"Blocking vs non-blocking in Tokio",id:"blocking-vs-non-blocking-in-tokio",level:2},{value:"Blocking (bad)",id:"blocking-bad",level:3},{value:"Correct way",id:"correct-way",level:3},{value:"CPU-bound work",id:"cpu-bound-work",level:3},{value:"async-std runtime (stdlib-like design)",id:"async-std-runtime-stdlib-like-design",level:2},{value:"Spawning tasks in async-std",id:"spawning-tasks-in-async-std",level:2},{value:"Tokio vs async-std (practical comparison)",id:"tokio-vs-async-std-practical-comparison",level:2},{value:"Mixing runtimes (don\u2019t)",id:"mixing-runtimes-dont",level:2},{value:"When to choose which runtime",id:"when-to-choose-which-runtime",level:2},{value:"Mental model summary",id:"mental-model-summary",level:2}];function a(n){const e={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.h2,{id:"why-do-we-need-an-async-runtime",children:"Why do we need an async runtime"}),"\n",(0,r.jsxs)(e.p,{children:["Rust gives you: ",(0,r.jsx)(e.code,{children:"async fn"}),", ",(0,r.jsx)(e.code,{children:"Future"}),", ",(0,r.jsx)(e.code,{children:".await"})]}),"\n",(0,r.jsx)(e.p,{children:"But Rust does not give you: A scheduler, An event loop, IO drivers, Timers"}),"\n",(0,r.jsx)(e.p,{children:"This is intentional."}),"\n",(0,r.jsx)(e.p,{children:"Rust async is runtime-agnostic."}),"\n",(0,r.jsx)(e.p,{children:"So this code:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-rust",children:'async fn hello() {\r\n    println!("hello");\r\n}\r\n\r\nfn main() {\r\n    hello(); // creates a future, does not run it\r\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"Needs something to:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Poll the future"}),"\n",(0,r.jsx)(e.li,{children:"Wake it when it can make progress"}),"\n",(0,r.jsx)(e.li,{children:"Manage IO and timers"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"That \u201csomething\u201d is an async runtime."}),"\n",(0,r.jsx)(e.h2,{id:"what-is-an-async-runtime",children:"What is an async runtime?"}),"\n",(0,r.jsx)(e.p,{children:"An async runtime is a library that provides:"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:"An executor + IO reactor + timer + task scheduler"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"All working together."}),"\n",(0,r.jsx)(e.p,{children:"Conceptually:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n          \u2502   Executor  \u2502\r\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n                 \u2502 polls\r\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n          \u2502   Futures   \u2502\r\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n                 \u2502 register wakers\r\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n          \u2502 Reactor     \u2502  \u2190 epoll / kqueue / IOCP\r\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2518\r\n                 \u2502 wake\r\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2510\r\n          \u2502   Scheduler \u2502\r\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.h2,{id:"core-components-of-an-async-runtime",children:"Core components of an async runtime"}),"\n",(0,r.jsx)(e.h3,{id:"executor",children:"Executor"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Polls futures"}),"\n",(0,r.jsxs)(e.li,{children:["Stops polling when they return ",(0,r.jsx)(e.code,{children:"Pending"})]}),"\n",(0,r.jsx)(e.li,{children:"Resumes them when woken"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"This is the heart of async."}),"\n",(0,r.jsx)(e.h3,{id:"scheduler",children:"Scheduler"}),"\n",(0,r.jsx)(e.p,{children:"Decides:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Which task runs next"}),"\n",(0,r.jsx)(e.li,{children:"On which thread"}),"\n",(0,r.jsx)(e.li,{children:"When to yield"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Schedulers can be:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Single-threaded"}),"\n",(0,r.jsx)(e.li,{children:"Multi-threaded (work stealing)"}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"reactor-io-driver",children:"Reactor (IO driver)"}),"\n",(0,r.jsx)(e.p,{children:"Listens for:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Socket readiness"}),"\n",(0,r.jsx)(e.li,{children:"File IO completion"}),"\n",(0,r.jsx)(e.li,{children:"OS events"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Uses OS primitives:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:["Linux: ",(0,r.jsx)(e.code,{children:"epoll"})]}),"\n",(0,r.jsxs)(e.li,{children:["macOS: ",(0,r.jsx)(e.code,{children:"kqueue"})]}),"\n",(0,r.jsxs)(e.li,{children:["Windows: ",(0,r.jsx)(e.code,{children:"IOCP"})]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"timer-system",children:"Timer system"}),"\n",(0,r.jsxs)(e.p,{children:["Handles: ",(0,r.jsx)(e.code,{children:"sleep"}),", ",(0,r.jsx)(e.code,{children:"timeout"}),", interval-based tasks"]}),"\n",(0,r.jsx)(e.h2,{id:"tokio-runtime-industry-standard",children:"Tokio runtime (industry standard)"}),"\n",(0,r.jsx)(e.p,{children:"Tokio is:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"High performance"}),"\n",(0,r.jsx)(e.li,{children:"Highly configurable"}),"\n",(0,r.jsx)(e.li,{children:"Production-grade"}),"\n",(0,r.jsx)(e.li,{children:"Used by: AWS, Discord, Cloudflare, etc."}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Tokio architecture"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Multi-threaded work-stealing scheduler"}),"\n",(0,r.jsx)(e.li,{children:"Separate IO reactor"}),"\n",(0,r.jsx)(e.li,{children:"Very explicit APIs"}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"example-basic-tokio-runtime",children:"Example: Basic Tokio runtime"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-rust",children:'use tokio::time::{sleep, Duration};\r\n\r\n#[tokio::main]\r\nasync fn main() {\r\n    println!("start");\r\n\r\n    sleep(Duration::from_secs(1)).await;\r\n\r\n    println!("end");\r\n}\n'})}),"\n",(0,r.jsxs)(e.h3,{id:"what-tokiomain-does",children:["What ",(0,r.jsx)(e.code,{children:"#[tokio::main]"})," does"]}),"\n",(0,r.jsx)(e.p,{children:"It expands to roughly:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-rust",children:"fn main() {\r\n    let runtime = tokio::runtime::Runtime::new().unwrap();\r\n    runtime.block_on(async {\r\n        // your async main\r\n    });\r\n}\n"})}),"\n",(0,r.jsx)(e.h2,{id:"tokio-task-spawning-and-scheduling",children:"Tokio task spawning and scheduling"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-rust",children:'use tokio::time::{sleep, Duration};\r\n\r\nasync fn worker(id: u32) {\r\n    println!("worker {} started", id);\r\n    sleep(Duration::from_secs(1)).await;\r\n    println!("worker {} finished", id);\r\n}\r\n\r\n#[tokio::main]\r\nasync fn main() {\r\n    for i in 1..=3 {\r\n        tokio::spawn(worker(i));\r\n    }\r\n\r\n    sleep(Duration::from_secs(2)).await;\r\n}\n'})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"tokio::spawn"})," creates a task"]}),"\n",(0,r.jsx)(e.li,{children:"Tasks are scheduled across runtime threads"}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:".await"})," yields control cooperatively"]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"blocking-vs-non-blocking-in-tokio",children:"Blocking vs non-blocking in Tokio"}),"\n",(0,r.jsx)(e.h3,{id:"blocking-bad",children:"Blocking (bad)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-rust",children:"std::thread::sleep(Duration::from_secs(1));\n"})}),"\n",(0,r.jsx)(e.p,{children:"This blocks a runtime worker thread."}),"\n",(0,r.jsx)(e.h3,{id:"correct-way",children:"Correct way"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-rust",children:"tokio::time::sleep(Duration::from_secs(1)).await;\n"})}),"\n",(0,r.jsx)(e.h3,{id:"cpu-bound-work",children:"CPU-bound work"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-rust",children:"tokio::task::spawn_blocking(|| {\r\n    heavy_computation();\r\n});\n"})}),"\n",(0,r.jsx)(e.p,{children:"This moves blocking work to a dedicated thread pool."}),"\n",(0,r.jsx)(e.h2,{id:"async-std-runtime-stdlib-like-design",children:"async-std runtime (stdlib-like design)"}),"\n",(0,r.jsx)(e.p,{children:"async-std aims to feel like Rust\u2019s standard library."}),"\n",(0,r.jsx)(e.p,{children:"Philosophy: Simple, Familiar APIs, Less configuration, Opinionated defaults"}),"\n",(0,r.jsx)(e.p,{children:"async-std example"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-rust",children:'use async_std::task;\r\nuse std::time::Duration;\r\n\r\nasync fn work() {\r\n    println!("working...");\r\n    task::sleep(Duration::from_secs(1)).await;\r\n    println!("done");\r\n}\r\n\r\nfn main() {\r\n    task::block_on(work());\r\n}\n'})}),"\n",(0,r.jsx)(e.p,{children:"Key differences"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"No macros required"}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"block_on"})," explicitly starts runtime"]}),"\n",(0,r.jsxs)(e.li,{children:["API mirrors ",(0,r.jsx)(e.code,{children:"std::thread"})]}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"spawning-tasks-in-async-std",children:"Spawning tasks in async-std"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-rust",children:'use async_std::task;\r\n\r\nasync fn worker(id: u32) {\r\n    println!("worker {} started", id);\r\n    task::sleep(std::time::Duration::from_secs(1)).await;\r\n    println!("worker {} finished", id);\r\n}\r\n\r\nfn main() {\r\n    task::block_on(async {\r\n        for i in 1..=3 {\r\n            task::spawn(worker(i));\r\n        }\r\n    });\r\n}\n'})}),"\n",(0,r.jsx)(e.h2,{id:"tokio-vs-async-std-practical-comparison",children:"Tokio vs async-std (practical comparison)"}),"\n",(0,r.jsxs)(e.table,{children:[(0,r.jsx)(e.thead,{children:(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.th,{children:"Feature"}),(0,r.jsx)(e.th,{children:"Tokio"}),(0,r.jsx)(e.th,{children:"async-std"})]})}),(0,r.jsxs)(e.tbody,{children:[(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Performance"}),(0,r.jsx)(e.td,{children:"Very high"}),(0,r.jsx)(e.td,{children:"Good"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Ecosystem"}),(0,r.jsx)(e.td,{children:"Huge"}),(0,r.jsx)(e.td,{children:"Smaller"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Configuration"}),(0,r.jsx)(e.td,{children:"Very flexible"}),(0,r.jsx)(e.td,{children:"Minimal"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"API style"}),(0,r.jsx)(e.td,{children:"Explicit"}),(0,r.jsx)(e.td,{children:"std-like"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Industry use"}),(0,r.jsx)(e.td,{children:"Dominant"}),(0,r.jsx)(e.td,{children:"Moderate"})]}),(0,r.jsxs)(e.tr,{children:[(0,r.jsx)(e.td,{children:"Learning curve"}),(0,r.jsx)(e.td,{children:"Steeper"}),(0,r.jsx)(e.td,{children:"Easier"})]})]})]}),"\n",(0,r.jsx)(e.h2,{id:"mixing-runtimes-dont",children:"Mixing runtimes (don\u2019t)"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"Tokio futures expect Tokio reactor"}),"\n",(0,r.jsx)(e.li,{children:"async-std futures expect async-std reactor"}),"\n",(0,r.jsx)(e.li,{children:"Mixing causes deadlocks or panics"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Use one runtime per application."}),"\n",(0,r.jsx)(e.h2,{id:"when-to-choose-which-runtime",children:"When to choose which runtime"}),"\n",(0,r.jsx)(e.p,{children:"Choose Tokio if:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"You\u2019re building servers"}),"\n",(0,r.jsx)(e.li,{children:"You need max performance"}),"\n",(0,r.jsx)(e.li,{children:"You depend on popular crates (hyper, tonic, axum)"}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Choose async-std if:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"You want simplicity"}),"\n",(0,r.jsx)(e.li,{children:"You\u2019re building small tools"}),"\n",(0,r.jsx)(e.li,{children:"You like std-like APIs"}),"\n"]}),"\n",(0,r.jsx)(e.h2,{id:"mental-model-summary",children:"Mental model summary"}),"\n",(0,r.jsx)(e.p,{children:"An async runtime is:"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsx)(e.p,{children:"A loop that keeps polling futures, listens to the OS for events, and wakes tasks when progress is possible."}),"\n"]}),"\n",(0,r.jsx)(e.p,{children:"Or simpler:"}),"\n",(0,r.jsxs)(e.blockquote,{children:["\n",(0,r.jsxs)(e.p,{children:["\u201cThe engine that makes ",(0,r.jsx)(e.code,{children:".await"})," actually work.\u201d"]}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(a,{...n})}):a(n)}},28453(n,e,s){s.d(e,{R:()=>t,x:()=>d});var i=s(96540);const r={},l=i.createContext(r);function t(n){const e=i.useContext(l);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function d(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:t(n.components),i.createElement(l.Provider,{value:e},n.children)}}}]);