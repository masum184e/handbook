"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[92108],{28453(n,e,s){s.d(e,{R:()=>o,x:()=>c});var r=s(96540);const i={},t=r.createContext(i);function o(n){const e=r.useContext(t);return r.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:o(n.components),r.createElement(t.Provider,{value:e},n.children)}},51771(n,e,s){s.r(e),s.d(e,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"nodejs/Monitoring","title":"Monitoring","description":"CPU Profiling","source":"@site/docs/nodejs/21. Monitoring.md","sourceDirName":"nodejs","slug":"/nodejs/Monitoring","permalink":"/handbook/docs/nodejs/Monitoring","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":21,"frontMatter":{},"sidebar":"nodejsApiSidebar","previous":{"title":"Database Optimization","permalink":"/handbook/docs/nodejs/Database Optimization"},"next":{"title":"index","permalink":"/handbook/docs/nodejs/"}}');var i=s(74848),t=s(28453);const o={},c=void 0,l={},d=[{value:"CPU Profiling",id:"cpu-profiling",level:2},{value:"Memory Profiling",id:"memory-profiling",level:2},{value:"Event Loop Profiling",id:"event-loop-profiling",level:2},{value:"Async Stack Traces &amp; Tracing",id:"async-stack-traces--tracing",level:2},{value:"Monitoring in Production",id:"monitoring-in-production",level:2},{value:"APM Tools",id:"apm-tools",level:2}];function a(n){const e={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,t.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.h2,{id:"cpu-profiling",children:"CPU Profiling"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["Using Node.js built-in profiler: ",(0,i.jsx)(e.code,{children:"node --prof app.js"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"This generates a log file (e.g., isolate-0xnnnn-v8.log)."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(e.li,{children:["Process it: ",(0,i.jsx)(e.code,{children:"node --prof-process isolate-0xnnnn-v8.log > processed.txt"}),"\r\nThis shows:","\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Which functions consume the most CPU"}),"\n",(0,i.jsx)(e.li,{children:"Where time is being spent"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"Useful for finding CPU-heavy functions."}),"\n",(0,i.jsx)(e.h2,{id:"memory-profiling",children:"Memory Profiling"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["Using Heap Snapshots\r\nStart Node.js with: ",(0,i.jsx)(e.code,{children:"node --inspect app.js"}),"\r\nOpen Chrome DevTools \u2192 Memory \u2192 Take Heap Snapshot."]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"You can:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Compare snapshots"}),"\n",(0,i.jsx)(e.li,{children:"Find memory leaks"}),"\n",(0,i.jsx)(e.li,{children:"Detect detached objects"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"Programmatic Heap Snapshot"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-js",children:'const v8 = require("v8");\r\nconst fs = require("fs");\r\n\r\nconst snapshot = v8.getHeapSnapshot();\r\nconst file = fs.createWriteStream("heap.heapsnapshot");\r\nsnapshot.pipe(file);\n'})}),"\n",(0,i.jsx)(e.h2,{id:"event-loop-profiling",children:"Event Loop Profiling"}),"\n",(0,i.jsx)(e.p,{children:"Measure Event Loop Lag"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-js",children:"setInterval(() => {\r\n  const start = Date.now();\r\n  setImmediate(() => {\r\n    const lag = Date.now() - start;\r\n    console.log(`Event loop lag: ${lag}ms`);\r\n  });\r\n}, 1000);\n"})}),"\n",(0,i.jsx)(e.p,{children:"High lag indicates blocking code."}),"\n",(0,i.jsx)(e.h2,{id:"async-stack-traces--tracing",children:"Async Stack Traces & Tracing"}),"\n",(0,i.jsx)(e.p,{children:"Enable async stack traces:"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-js",children:"node --async-stack-traces app.js\n"})}),"\n",(0,i.jsxs)(e.p,{children:["Use ",(0,i.jsx)(e.code,{children:"async_hooks"})," for tracing async behavior:"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{children:"const async_hooks = require('async_hooks');\r\nconst fs = require('fs');\r\n\r\nconst hook = async_hooks.createHook({\r\n  init(asyncId, type, triggerAsyncId) {\r\n    fs.writeSync(1, `Init: ${type} (${asyncId})\\n`);\r\n  }\r\n});\r\n\r\nhook.enable();\n"})}),"\n",(0,i.jsx)(e.h2,{id:"monitoring-in-production",children:"Monitoring in Production"}),"\n",(0,i.jsx)(e.p,{children:"Key Metrics to Monitor"}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"Metric"}),(0,i.jsx)(e.th,{children:"Why It Matters"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"CPU usage"}),(0,i.jsx)(e.td,{children:"Detects heavy workloads"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Memory usage"}),(0,i.jsx)(e.td,{children:"Detects leaks"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Event loop lag"}),(0,i.jsx)(e.td,{children:"Detects blocking"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Request latency"}),(0,i.jsx)(e.td,{children:"Detects slow endpoints"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Error rates"}),(0,i.jsx)(e.td,{children:"Detects failures"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Throughput (RPS)"}),(0,i.jsx)(e.td,{children:"Measures load handling"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"DB query time"}),(0,i.jsx)(e.td,{children:"Finds bottlenecks"})]})]})]}),"\n",(0,i.jsx)(e.p,{children:"Basic Runtime Metrics"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-js",children:"setInterval(() => {\r\n  const memory = process.memoryUsage();\r\n  const cpu = process.cpuUsage();\r\n\r\n  console.log({\r\n    rss: memory.rss,\r\n    heapUsed: memory.heapUsed,\r\n    cpuUser: cpu.user,\r\n    cpuSystem: cpu.system,\r\n  });\r\n}, 5000);\n"})}),"\n",(0,i.jsx)(e.p,{children:"Monitoring Express App with Metrics Endpoint"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-js",children:'const express = require("express");\r\nconst app = express();\r\n\r\napp.get("/metrics", (req, res) => {\r\n  const memory = process.memoryUsage();\r\n  const cpu = process.cpuUsage();\r\n\r\n  res.json({\r\n    uptime: process.uptime(),\r\n    memory,\r\n    cpu,\r\n    eventLoopLag: process.hrtime.bigint().toString(),\r\n  });\r\n});\r\n\r\napp.listen(3000);\n'})}),"\n",(0,i.jsx)(e.h2,{id:"apm-tools",children:"APM Tools"}),"\n",(0,i.jsxs)(e.table,{children:[(0,i.jsx)(e.thead,{children:(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.th,{children:"Tool"}),(0,i.jsx)(e.th,{children:"Features"})]})}),(0,i.jsxs)(e.tbody,{children:[(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"New Relic"}),(0,i.jsx)(e.td,{children:"Full tracing, metrics, errors"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Datadog"}),(0,i.jsx)(e.td,{children:"Metrics, logs, tracing"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"Elastic APM"}),(0,i.jsx)(e.td,{children:"Distributed tracing"})]}),(0,i.jsxs)(e.tr,{children:[(0,i.jsx)(e.td,{children:"AppDynamics"}),(0,i.jsx)(e.td,{children:"Performance monitoring"})]})]})]}),"\n",(0,i.jsxs)(e.p,{children:["Monitor with ",(0,i.jsx)(e.code,{children:"pm2"}),": ",(0,i.jsx)(e.code,{children:"pm2 monit"})]}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"Measuring Request Duration Middleware"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-js",children:'app.use((req, res, next) => {\r\n  const start = process.hrtime.bigint();\r\n\r\n  res.on("finish", () => {\r\n    const duration = Number(process.hrtime.bigint() - start) / 1e6;\r\n    console.log(`${req.method} ${req.url} - ${duration.toFixed(2)}ms`);\r\n  });\r\n\r\n  next();\r\n});\n'})}),"\n",(0,i.jsx)(e.p,{children:(0,i.jsx)(e.strong,{children:"Detecting Memory Leaks"})}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-js",children:"setInterval(() => {\r\n  console.log(process.memoryUsage().heapUsed);\r\n}, 10000);\n"})}),"\n",(0,i.jsx)(e.p,{children:"If memory grows continuously and never drops \u2192 possible memory leak."})]})}function h(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(a,{...n})}):a(n)}}}]);