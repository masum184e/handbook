"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[7204],{13812(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"mysql/Advance Features/Common Table Expressions","title":"Common Table Expressions","description":"A Common Table Expression (CTE) is a temporary result set defined within the execution of a single SQL statement, using the WITH clause.","source":"@site/docs/mysql/21. Advance Features/3. Common Table Expressions.md","sourceDirName":"mysql/21. Advance Features","slug":"/mysql/Advance Features/Common Table Expressions","permalink":"/handbook/docs/mysql/Advance Features/Common Table Expressions","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"mysqlSidebar","previous":{"title":"Temporary Table","permalink":"/handbook/docs/mysql/Advance Features/Temporary Table"},"next":{"title":"JSON","permalink":"/handbook/docs/mysql/Advance Features/JSON"}}');var l=s(74848),i=s(28453);const a={},t=void 0,d={},c=[{value:"Example of Simple CTE",id:"example-of-simple-cte",level:2},{value:"Example of Multiple CTEs",id:"example-of-multiple-ctes",level:2},{value:"Recursive CTEs",id:"recursive-ctes",level:2},{value:"CTE vs Subquery vs View",id:"cte-vs-subquery-vs-view",level:2}];function o(e){const n={code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(n.p,{children:["A Common Table Expression (CTE) is a temporary result set defined within the execution of a single SQL statement, using the ",(0,l.jsx)(n.code,{children:"WITH"})," clause."]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"It is not stored in the database (unlike a table or view)."}),"\n",(0,l.jsx)(n.li,{children:"It exists only for the duration of the query."}),"\n",(0,l.jsx)(n.li,{children:"It can make queries cleaner and easier to read, especially when dealing with complex joins, subqueries, or recursive queries."}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Think of it as a named temporary query that you can reuse in the same SQL statement."}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"WITH cte_name (column1, column2, ...) AS (\r\n    SELECT ...\r\n)\r\nSELECT * FROM cte_name;\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Advantages of CTEs"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Improves readability \u2192 Instead of deeply nested subqueries, break them into steps."}),"\n",(0,l.jsx)(n.li,{children:"Reusability within a query \u2192 A CTE can be referenced multiple times in the same statement."}),"\n",(0,l.jsx)(n.li,{children:"Recursive queries \u2192 Handle hierarchical data elegantly."}),"\n",(0,l.jsx)(n.li,{children:"Easier maintenance \u2192 Queries are modular and easier to debug."}),"\n",(0,l.jsx)(n.li,{children:"Acts like an inline view but more flexible."}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Limitations of CTEs"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Performance:"})," CTEs do not always optimize as well as derived tables.","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"In MySQL, non-recursive CTEs are often treated like inline views (they don\u2019t persist results)."}),"\n",(0,l.jsx)(n.li,{children:"For very large datasets, temporary tables may perform better."}),"\n"]}),"\n"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Scope limited:"})," A CTE exists only within the statement where it is defined."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"Not reusable across queries"})," \u2192 Unlike a view, a CTE can\u2019t be stored for future queries."]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"MySQL Recursive CTEs"})," have depth limits (default = 1000 levels)."]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"example-of-simple-cte",children:"Example of Simple CTE"}),"\n",(0,l.jsx)(n.p,{children:"Suppose we have an employees table:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"CREATE TABLE employees (\r\n    emp_id INT PRIMARY KEY,\r\n    name VARCHAR(100),\r\n    department VARCHAR(50),\r\n    salary DECIMAL(10,2),\r\n    manager_id INT\r\n);\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"Without CTE"})}),"\n",(0,l.jsx)(n.p,{children:"If you want to find employees with salary above the average salary, you might write:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT emp_id, name, salary\r\nFROM employees\r\nWHERE salary > (SELECT AVG(salary) FROM employees);\n"})}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"With CTE"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"WITH avg_salary AS (\r\n    SELECT AVG(salary) AS avg_sal FROM employees\r\n)\r\nSELECT emp_id, name, salary\r\nFROM employees, avg_salary\r\nWHERE employees.salary > avg_salary.avg_sal;\n"})}),"\n",(0,l.jsx)(n.p,{children:"Here avg_salary is a CTE that calculates the average salary and is reused in the main query."}),"\n",(0,l.jsx)(n.p,{children:"This makes the query cleaner and more readable."}),"\n",(0,l.jsx)(n.h2,{id:"example-of-multiple-ctes",children:"Example of Multiple CTEs"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"WITH dept_avg AS (\r\n    SELECT department, AVG(salary) AS avg_sal\r\n    FROM employees\r\n    GROUP BY department\r\n),\r\nhigh_paid AS (\r\n    SELECT emp_id, name, department, salary\r\n    FROM employees\r\n    WHERE salary > 70000\r\n)\r\nSELECT h.name, h.salary, d.avg_sal\r\nFROM high_paid h\r\nJOIN dept_avg d ON h.department = d.department;\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:["First CTE ",(0,l.jsx)(n.code,{children:"dept_avg"})," calculates average salary per department."]}),"\n",(0,l.jsxs)(n.li,{children:["Second CTE ",(0,l.jsx)(n.code,{children:"high_paid"})," selects high salary employees."]}),"\n",(0,l.jsx)(n.li,{children:"Final query joins them."}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"recursive-ctes",children:"Recursive CTEs"}),"\n",(0,l.jsx)(n.p,{children:"Recursive CTEs are used for hierarchical data, like org charts or parent-child relationships."}),"\n",(0,l.jsxs)(n.p,{children:["Suppose each employee has a ",(0,l.jsx)(n.code,{children:"manager_id"})," (who is also an employee)."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"WITH RECURSIVE employee_hierarchy AS (\r\n    -- Anchor member: start with top-level manager (CEO, manager_id IS NULL)\r\n    SELECT emp_id, name, manager_id, 1 AS level\r\n    FROM employees\r\n    WHERE manager_id IS NULL\r\n\r\n    UNION ALL\r\n\r\n    -- Recursive member: find employees reporting to the previous level\r\n    SELECT e.emp_id, e.name, e.manager_id, eh.level + 1\r\n    FROM employees e\r\n    INNER JOIN employee_hierarchy eh ON e.manager_id = eh.emp_id\r\n)\r\nSELECT * FROM employee_hierarchy;\n"})}),"\n",(0,l.jsx)(n.p,{children:"This will produce a tree-like structure of employees with their reporting levels."}),"\n",(0,l.jsx)(n.h2,{id:"cte-vs-subquery-vs-view",children:"CTE vs Subquery vs View"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Feature"}),(0,l.jsx)(n.th,{children:"Subquery"}),(0,l.jsx)(n.th,{children:"CTE"}),(0,l.jsx)(n.th,{children:"View"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Readability"}),(0,l.jsx)(n.td,{children:"\u274c Harder"}),(0,l.jsx)(n.td,{children:"\u2705 Cleaner"}),(0,l.jsx)(n.td,{children:"\u2705 Good"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Reusable in same query"}),(0,l.jsx)(n.td,{children:"\u274c No"}),(0,l.jsx)(n.td,{children:"\u2705 Yes"}),(0,l.jsx)(n.td,{children:"\u2705 Yes"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Reusable in different queries"}),(0,l.jsx)(n.td,{children:"\u274c No"}),(0,l.jsx)(n.td,{children:"\u274c No"}),(0,l.jsx)(n.td,{children:"\u2705 Yes"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Stored permanently"}),(0,l.jsx)(n.td,{children:"\u274c No"}),(0,l.jsx)(n.td,{children:"\u274c No"}),(0,l.jsx)(n.td,{children:"\u2705 Yes"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Recursive support"}),(0,l.jsx)(n.td,{children:"\u274c No"}),(0,l.jsx)(n.td,{children:"\u2705 Yes"}),(0,l.jsx)(n.td,{children:"\u274c No"})]})]})]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(o,{...e})}):o(e)}},28453(e,n,s){s.d(n,{R:()=>a,x:()=>t});var r=s(96540);const l={},i=r.createContext(l);function a(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);