"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[5983],{28453(n,e,l){l.d(e,{R:()=>s,x:()=>a});var r=l(96540);const i={},c=r.createContext(i);function s(n){const e=r.useContext(c);return r.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function a(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:s(n.components),r.createElement(c.Provider,{value:e},n.children)}},56463(n,e,l){l.r(e),l.d(e,{assets:()=>t,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"rust/Asynchronous/Cancellation","title":"Cancellation","description":"In Rust async:","source":"@site/docs/rust/Asynchronous/7. Cancellation.md","sourceDirName":"rust/Asynchronous","slug":"/rust/Asynchronous/Cancellation","permalink":"/handbook/docs/rust/Asynchronous/Cancellation","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":7,"frontMatter":{},"sidebar":"rustApiSidebar","previous":{"title":"Error Handling","permalink":"/handbook/docs/rust/Asynchronous/Error Handling"},"next":{"title":"Declarative Macros","permalink":"/handbook/docs/rust/Macros/Declarative Macros"}}');var i=l(74848),c=l(28453);const s={},a=void 0,t={},o=[{value:"Where cancellation comes from",id:"where-cancellation-comes-from",level:2},{value:"Cancellation is cooperative",id:"cancellation-is-cooperative",level:2},{value:"Cancellation safety (critical concept)",id:"cancellation-safety-critical-concept",level:2},{value:"Not cancellation-safe",id:"not-cancellation-safe",level:3},{value:"Cancellation-safe version",id:"cancellation-safe-version",level:3},{value:"Destructors (<code>Drop</code>) run on cancellation",id:"destructors-drop-run-on-cancellation",level:2},{value:"Timeouts are just cancellation",id:"timeouts-are-just-cancellation",level:2},{value:"Handling timeouts cleanly",id:"handling-timeouts-cleanly",level:2},{value:"<code>select!</code> = manual cancellation control",id:"select--manual-cancellation-control",level:2},{value:"Graceful cancellation with signals",id:"graceful-cancellation-with-signals",level:2},{value:"<code>CancellationToken</code> (Tokio utility)",id:"cancellationtoken-tokio-utility",level:2},{value:"Blocking and cancellation",id:"blocking-and-cancellation",level:2},{value:"Blocking code",id:"blocking-code",level:3},{value:"Async sleep",id:"async-sleep",level:3},{value:"Cancellation and streams",id:"cancellation-and-streams",level:2},{value:"Best practices",id:"best-practices",level:2},{value:"Mental model to remember forever",id:"mental-model-to-remember-forever",level:2}];function d(n){const e={blockquote:"blockquote",br:"br",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...n.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(e.p,{children:"In Rust async:"}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsx)(e.p,{children:"Cancellation means dropping a future before it completes."}),"\n"]}),"\n",(0,i.jsxs)(e.p,{children:["That\u2019s it.",(0,i.jsx)(e.br,{}),"\n","There is no \u201ccancel token\u201d built into the language."]}),"\n",(0,i.jsx)(e.p,{children:"If a future is:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Dropped \u2192 it is cancelled"}),"\n",(0,i.jsx)(e.li,{children:"Never polled again"}),"\n",(0,i.jsxs)(e.li,{children:["Its destructor (",(0,i.jsx)(e.code,{children:"Drop"}),") runs"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"where-cancellation-comes-from",children:"Where cancellation comes from"}),"\n",(0,i.jsx)(e.p,{children:"Common sources:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["Dropping a ",(0,i.jsx)(e.code,{children:"JoinHandle"})]}),"\n",(0,i.jsxs)(e.li,{children:["A ",(0,i.jsx)(e.code,{children:"select!"})," branch winning"]}),"\n",(0,i.jsx)(e.li,{children:"A timeout expiring"}),"\n",(0,i.jsx)(e.li,{children:"Shutdown signals"}),"\n",(0,i.jsx)(e.li,{children:"Parent task exiting"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:"let handle = tokio::spawn(do_work());\r\ndrop(handle); // task cancelled\n"})}),"\n",(0,i.jsx)(e.h2,{id:"cancellation-is-cooperative",children:"Cancellation is cooperative"}),"\n",(0,i.jsx)(e.p,{children:"Important rule:"}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsx)(e.p,{children:"Async Rust cancellation is cooperative, not forced."}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"That means:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"The runtime does not stop your code mid-instruction"}),"\n",(0,i.jsxs)(e.li,{children:["Cancellation only happens at ",(0,i.jsx)(e.code,{children:".await"})," points"]}),"\n",(0,i.jsx)(e.li,{children:"Your code must be written to be safely droppable"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"cancellation-safety-critical-concept",children:"Cancellation safety (critical concept)"}),"\n",(0,i.jsx)(e.p,{children:"A future is cancellation-safe if:"}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsxs)(e.p,{children:["Dropping it at any ",(0,i.jsx)(e.code,{children:".await"})," does not leave the program in a broken state."]}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"not-cancellation-safe",children:"Not cancellation-safe"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:'async fn write_two_steps(socket: &mut TcpStream) -> io::Result<()> {\r\n    socket.write_all(b"HELLO").await?;\r\n    socket.write_all(b"WORLD").await?;\r\n    Ok(())\r\n}\n'})}),"\n",(0,i.jsxs)(e.p,{children:["If cancelled after writing ",(0,i.jsx)(e.code,{children:"HELLO"}),":"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Protocol is broken"}),"\n",(0,i.jsx)(e.li,{children:"Peer sees partial message"}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"cancellation-safe-version",children:"Cancellation-safe version"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:'async fn write_message(socket: &mut TcpStream) -> io::Result<()> {\r\n    let msg = b"HELLOWORLD";\r\n    socket.write_all(msg).await?;\r\n    Ok(())\r\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"One await \u2192 atomic at protocol level."}),"\n",(0,i.jsxs)(e.h2,{id:"destructors-drop-run-on-cancellation",children:["Destructors (",(0,i.jsx)(e.code,{children:"Drop"}),") run on cancellation"]}),"\n",(0,i.jsx)(e.p,{children:"This is huge."}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:'struct Guard;\r\n\r\nimpl Drop for Guard {\r\n    fn drop(&mut self) {\r\n        println!("cleaning up");\r\n    }\r\n}\r\n\r\nasync fn task() {\r\n    let _guard = Guard;\r\n    tokio::time::sleep(Duration::from_secs(10)).await;\r\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"If task is cancelled:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"_guard"})," is dropped"]}),"\n",(0,i.jsx)(e.li,{children:"Cleanup runs"}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"This is your main tool for cleanup."}),"\n",(0,i.jsx)(e.h2,{id:"timeouts-are-just-cancellation",children:"Timeouts are just cancellation"}),"\n",(0,i.jsx)(e.p,{children:"Timeouts are implemented by cancelling the future."}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:"use tokio::time::{timeout, Duration};\r\n\r\nlet result = timeout(Duration::from_secs(1), async {\r\n    do_work().await\r\n}).await;\r\n\n"})}),"\n",(0,i.jsx)(e.p,{children:"If time expires:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"The inner future is dropped"}),"\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"timeout"})," returns ",(0,i.jsx)(e.code,{children:"Err(Elapsed)"})]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"handling-timeouts-cleanly",children:"Handling timeouts cleanly"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:'match timeout(Duration::from_secs(1), do_work()).await {\r\n    Ok(Ok(value)) => println!("success: {value}"),\r\n    Ok(Err(e)) => println!("task error: {e}"),\r\n    Err(_) => println!("timed out"),\r\n}\n'})}),"\n",(0,i.jsxs)(e.p,{children:["Nested ",(0,i.jsx)(e.code,{children:"Result"}),"s:"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Inner \u2192 task error"}),"\n",(0,i.jsx)(e.li,{children:"Outer \u2192 timeout error"}),"\n"]}),"\n",(0,i.jsxs)(e.h2,{id:"select--manual-cancellation-control",children:[(0,i.jsx)(e.code,{children:"select!"})," = manual cancellation control"]}),"\n",(0,i.jsxs)(e.p,{children:[(0,i.jsx)(e.code,{children:"select!"})," races futures and cancels losers."]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:'use tokio::select;\r\n\r\nasync fn slow() {\r\n    tokio::time::sleep(Duration::from_secs(5)).await;\r\n    println!("slow done");\r\n}\r\n\r\nasync fn fast() {\r\n    tokio::time::sleep(Duration::from_secs(1)).await;\r\n    println!("fast done");\r\n}\r\n\r\n#[tokio::main]\r\nasync fn main() {\r\n    select! {\r\n        _ = slow() => {}\r\n        _ = fast() => {}\r\n    }\r\n}\n'})}),"\n",(0,i.jsxs)(e.p,{children:["When ",(0,i.jsx)(e.code,{children:"fast"})," completes:"]}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:[(0,i.jsx)(e.code,{children:"slow"})," is dropped (cancelled)"]}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"graceful-cancellation-with-signals",children:"Graceful cancellation with signals"}),"\n",(0,i.jsx)(e.p,{children:"Using a cancellation channel"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:'use tokio::sync::watch;\r\n\r\nasync fn worker(mut shutdown: watch::Receiver<bool>) {\r\n    loop {\r\n        tokio::select! {\r\n            _ = shutdown.changed() => {\r\n                println!("shutting down");\r\n                break;\r\n            }\r\n            _ = do_work() => {}\r\n        }\r\n    }\r\n}\n'})}),"\n",(0,i.jsx)(e.p,{children:"This allows:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Explicit shutdown"}),"\n",(0,i.jsx)(e.li,{children:"Cleanup paths"}),"\n"]}),"\n",(0,i.jsxs)(e.h2,{id:"cancellationtoken-tokio-utility",children:[(0,i.jsx)(e.code,{children:"CancellationToken"})," (Tokio utility)"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:'use tokio_util::sync::CancellationToken;\r\n\r\nlet token = CancellationToken::new();\r\nlet child = token.child_token();\r\n\r\ntokio::spawn(async move {\r\n    tokio::select! {\r\n        _ = child.cancelled() => println!("cancelled"),\r\n        _ = do_work() => {}\r\n    }\r\n});\r\n\r\ntoken.cancel();\n'})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Structured cancellation"}),"\n",(0,i.jsx)(e.li,{children:"Tree-based propagation"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"blocking-and-cancellation",children:"Blocking and cancellation"}),"\n",(0,i.jsx)(e.h3,{id:"blocking-code",children:"Blocking code"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:"std::thread::sleep(Duration::from_secs(10));\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Cannot be cancelled"}),"\n",(0,i.jsx)(e.li,{children:"Freezes executor thread"}),"\n"]}),"\n",(0,i.jsx)(e.h3,{id:"async-sleep",children:"Async sleep"}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:"tokio::time::sleep(Duration::from_secs(10)).await;\n"})}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Cancellation-safe"}),"\n",(0,i.jsx)(e.li,{children:"Droppable"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"cancellation-and-streams",children:"Cancellation and streams"}),"\n",(0,i.jsx)(e.p,{children:"Streams are cancelled by:"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsx)(e.li,{children:"Dropping the stream"}),"\n",(0,i.jsx)(e.li,{children:"Exiting loop early"}),"\n"]}),"\n",(0,i.jsx)(e.pre,{children:(0,i.jsx)(e.code,{className:"language-rust",children:"while let Some(item) = stream.next().await {\r\n    if item == 42 {\r\n        break; // stream cancelled\r\n    }\r\n}\n"})}),"\n",(0,i.jsx)(e.h2,{id:"best-practices",children:"Best practices"}),"\n",(0,i.jsxs)(e.ul,{children:["\n",(0,i.jsxs)(e.li,{children:["Minimize ",(0,i.jsx)(e.code,{children:".await"})," in critical sections"]}),"\n",(0,i.jsx)(e.li,{children:"Use RAII for cleanup"}),"\n",(0,i.jsx)(e.li,{children:"Make protocol steps atomic"}),"\n",(0,i.jsxs)(e.li,{children:["Prefer ",(0,i.jsx)(e.code,{children:"select!"})," over flags"]}),"\n",(0,i.jsx)(e.li,{children:"Assume cancellation can happen anytime"}),"\n"]}),"\n",(0,i.jsx)(e.h2,{id:"mental-model-to-remember-forever",children:"Mental model to remember forever"}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsxs)(e.p,{children:["Cancellation = dropping a future at an ",(0,i.jsx)(e.code,{children:".await"}),"."]}),"\n"]}),"\n",(0,i.jsx)(e.p,{children:"Or:"}),"\n",(0,i.jsxs)(e.blockquote,{children:["\n",(0,i.jsx)(e.p,{children:"\u201cIf it can be awaited, it can be cancelled.\u201d"}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,c.R)(),...n.components};return e?(0,i.jsx)(e,{...n,children:(0,i.jsx)(d,{...n})}):d(n)}}}]);