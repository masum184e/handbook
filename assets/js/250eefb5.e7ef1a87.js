"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[86355],{28453(e,n,s){s.d(n,{R:()=>c,x:()=>t});var i=s(96540);const l={},r=i.createContext(l);function c(e){const n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:c(e.components),i.createElement(r.Provider,{value:n},e.children)}},42175(e,n,s){s.r(n),s.d(n,{assets:()=>d,contentTitle:()=>t,default:()=>o,frontMatter:()=>c,metadata:()=>i,toc:()=>a});const i=JSON.parse('{"id":"nginx/Health Checks","title":"Health Checks","description":"Health checks allow NGINX to determine whether a backend server is healthy or unhealthy and decide whether to send traffic to it.","source":"@site/docs/nginx/10. Health Checks.md","sourceDirName":"nginx","slug":"/nginx/Health Checks","permalink":"/handbook/docs/nginx/Health Checks","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":10,"frontMatter":{},"sidebar":"nginxApiSidebar","previous":{"title":"Load Balancing","permalink":"/handbook/docs/nginx/Load Balancing"},"next":{"title":"Static Files","permalink":"/handbook/docs/nginx/Static Files"}}');var l=s(74848),r=s(28453);const c={},t=void 0,d={},a=[{value:"Types of Health Checks in NGINX",id:"types-of-health-checks-in-nginx",level:2},{value:"Passive Health Checks (Open Source NGINX)",id:"passive-health-checks-open-source-nginx",level:2},{value:"Core Directives for Passive Health Checks",id:"core-directives-for-passive-health-checks",level:2},{value:"<code>max_fails</code>",id:"max_fails",level:3},{value:"<code>fail_timeout</code>",id:"fail_timeout",level:3},{value:"Combined Example",id:"combined-example",level:3},{value:"Full Passive Health Check Example",id:"full-passive-health-check-example",level:2},{value:"Request Flow Explanation",id:"request-flow-explanation",level:3},{value:"What Happens When All Backends Fail?",id:"what-happens-when-all-backends-fail",level:2},{value:"Passive Health Check Failure Conditions (Important)",id:"passive-health-check-failure-conditions-important",level:2},{value:"<code>backup</code> Servers (Failover Strategy)",id:"backup-servers-failover-strategy",level:2},{value:"Temporarily Disable a Backend",id:"temporarily-disable-a-backend",level:2},{value:"Active Health Checks (NGINX Plus Only)",id:"active-health-checks-nginx-plus-only",level:2},{value:"Passive vs Active Health Checks",id:"passive-vs-active-health-checks",level:2},{value:"Real-World Production Example",id:"real-world-production-example",level:2},{value:"Summary",id:"summary",level:2}];function h(e){const n={code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.p,{children:"Health checks allow NGINX to determine whether a backend server is healthy or unhealthy and decide whether to send traffic to it."}),"\n",(0,l.jsx)(n.p,{children:"Goal:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"If backend is unhealthy \u2192 stop sending requests to it\r\nIf backend recovers \u2192 resume traffic\n"})}),"\n",(0,l.jsx)(n.p,{children:"This ensures:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"High availability"}),"\n",(0,l.jsx)(n.li,{children:"Fault tolerance"}),"\n",(0,l.jsx)(n.li,{children:"Better user experience"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"types-of-health-checks-in-nginx",children:"Types of Health Checks in NGINX"}),"\n",(0,l.jsx)(n.p,{children:"NGINX supports two kinds of health checks:"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Type"}),(0,l.jsx)(n.th,{children:"Availability"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Passive health checks"}),(0,l.jsx)(n.td,{children:"\u2705 NGINX Open Source"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Active health checks"}),(0,l.jsx)(n.td,{children:"\u274c Open Source (\u2705 NGINX Plus)"})]})]})]}),"\n",(0,l.jsx)(n.h2,{id:"passive-health-checks-open-source-nginx",children:"Passive Health Checks (Open Source NGINX)"}),"\n",(0,l.jsx)(n.p,{children:"NGINX does not actively probe backends."}),"\n",(0,l.jsx)(n.p,{children:"Instead, it:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Sends real client requests"}),"\n",(0,l.jsx)(n.li,{children:"Monitors backend responses"}),"\n",(0,l.jsx)(n.li,{children:"Marks a server as failed if errors occur"}),"\n"]}),"\n",(0,l.jsx)(n.p,{children:"Failure conditions include:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Connection timeout"}),"\n",(0,l.jsx)(n.li,{children:"Connection refused"}),"\n",(0,l.jsx)(n.li,{children:"Invalid response"}),"\n",(0,l.jsx)(n.li,{children:"HTTP 500 / 502 / 503 / 504"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"core-directives-for-passive-health-checks",children:"Core Directives for Passive Health Checks"}),"\n",(0,l.jsxs)(n.p,{children:["These are defined inside the ",(0,l.jsx)(n.code,{children:"upstream"})," block."]}),"\n",(0,l.jsx)(n.h3,{id:"max_fails",children:(0,l.jsx)(n.code,{children:"max_fails"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"server backend1 max_fails=3;\n"})}),"\n",(0,l.jsx)(n.p,{children:"Number of failed attempts before marking server unhealthy"}),"\n",(0,l.jsx)(n.h3,{id:"fail_timeout",children:(0,l.jsx)(n.code,{children:"fail_timeout"})}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"server backend1 fail_timeout=30s;\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Time window for counting failures"}),"\n",(0,l.jsx)(n.li,{children:"Also the time server is considered down"}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"combined-example",children:"Combined Example"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"upstream app_backend {\r\n    server 10.0.0.11:8080 max_fails=3 fail_timeout=30s;\r\n    server 10.0.0.12:8080 max_fails=3 fail_timeout=30s;\r\n}\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"If a server fails 3 times within 30 seconds"}),"\n",(0,l.jsx)(n.li,{children:"NGINX marks it unavailable"}),"\n",(0,l.jsx)(n.li,{children:"Traffic is sent only to healthy servers"}),"\n",(0,l.jsx)(n.li,{children:"After 30 seconds, NGINX retries it"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"full-passive-health-check-example",children:"Full Passive Health Check Example"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"upstream api_backend {\r\n    least_conn;\r\n\r\n    server 10.0.0.11:8080 max_fails=3 fail_timeout=20s;\r\n    server 10.0.0.12:8080 max_fails=3 fail_timeout=20s;\r\n}\r\n\r\nserver {\r\n    listen 80;\r\n\r\n    location /api/ {\r\n        proxy_pass http://api_backend;\r\n\r\n        proxy_connect_timeout 3s;\r\n        proxy_read_timeout 10s;\r\n    }\r\n}\n"})}),"\n",(0,l.jsx)(n.h3,{id:"request-flow-explanation",children:"Request Flow Explanation"}),"\n",(0,l.jsxs)(n.ol,{children:["\n",(0,l.jsx)(n.li,{children:"Client sends request to NGINX"}),"\n",(0,l.jsx)(n.li,{children:"NGINX proxies request to backend"}),"\n",(0,l.jsxs)(n.li,{children:["If backend:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Times out"}),"\n",(0,l.jsx)(n.li,{children:"Refuses connection"}),"\n",(0,l.jsx)(n.li,{children:"Returns 5xx repeatedly"}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"NGINX increments failure counter"}),"\n",(0,l.jsx)(n.li,{children:"Once threshold reached \u2192 backend is skipped"}),"\n",(0,l.jsxs)(n.li,{children:["After ",(0,l.jsx)(n.code,{children:"fail_timeout"}),", backend is retried"]}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"what-happens-when-all-backends-fail",children:"What Happens When All Backends Fail?"}),"\n",(0,l.jsx)(n.p,{children:"If all servers in the upstream are marked down:"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"NGINX temporarily retries failed servers"}),"\n",(0,l.jsx)(n.li,{children:"If still unavailable \u2192 client receives 502 Bad Gateway"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"passive-health-check-failure-conditions-important",children:"Passive Health Check Failure Conditions (Important)"}),"\n",(0,l.jsx)(n.p,{children:"NGINX counts failures when:"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Condition"}),(0,l.jsx)(n.th,{children:"Counts as Failure"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"TCP connection refused"}),(0,l.jsx)(n.td,{children:"\u2705"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Timeout"}),(0,l.jsx)(n.td,{children:"\u2705"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"No response"}),(0,l.jsx)(n.td,{children:"\u2705"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"HTTP 500 / 502 / 503 / 504"}),(0,l.jsx)(n.td,{children:"\u2705"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"HTTP 404"}),(0,l.jsx)(n.td,{children:"\u274c"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"HTTP 401"}),(0,l.jsx)(n.td,{children:"\u274c"})]})]})]}),"\n",(0,l.jsxs)(n.h2,{id:"backup-servers-failover-strategy",children:[(0,l.jsx)(n.code,{children:"backup"})," Servers (Failover Strategy)"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"upstream app_backend {\r\n   server 10.0.0.11:8080;\r\n   server 10.0.0.12:8080;\r\n   server 10.0.0.99:8080 backup;\r\n}\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Backup server is used only if all primary servers fail"}),"\n",(0,l.jsx)(n.li,{children:"Useful for DR or reduced-capacity nodes"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"temporarily-disable-a-backend",children:"Temporarily Disable a Backend"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"   server 10.0.0.11:8080 down;\n"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Server is manually removed"}),"\n",(0,l.jsx)(n.li,{children:"Useful for maintenance"}),"\n",(0,l.jsx)(n.li,{children:"Requires reload to re-enable"}),"\n"]}),"\n",(0,l.jsx)(n.h2,{id:"active-health-checks-nginx-plus-only",children:"Active Health Checks (NGINX Plus Only)"}),"\n",(0,l.jsx)(n.p,{children:"Not available in open-source NGINX"}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"How Active Health Checks Work"})}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"NGINX sends periodic health probe requests"}),"\n",(0,l.jsx)(n.li,{children:"Uses a dedicated endpoint (e.g. /health)"}),"\n",(0,l.jsx)(n.li,{children:"Removes backend before user traffic fails"}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"health_check uri=/health interval=5s fails=2 passes=1;\n"})}),"\n",(0,l.jsx)(n.h2,{id:"passive-vs-active-health-checks",children:"Passive vs Active Health Checks"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"Feature"}),(0,l.jsx)(n.th,{children:"Passive"}),(0,l.jsx)(n.th,{children:"Active"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Available in OSS"}),(0,l.jsx)(n.td,{children:"\u2705"}),(0,l.jsx)(n.td,{children:"\u274c"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Sends probes"}),(0,l.jsx)(n.td,{children:"\u274c"}),(0,l.jsx)(n.td,{children:"\u2705"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Detects failures early"}),(0,l.jsx)(n.td,{children:"\u274c"}),(0,l.jsx)(n.td,{children:"\u2705"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Uses real traffic"}),(0,l.jsx)(n.td,{children:"\u2705"}),(0,l.jsx)(n.td,{children:"\u274c"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:"Complexity"}),(0,l.jsx)(n.td,{children:"Low"}),(0,l.jsx)(n.td,{children:"Medium"})]})]})]}),"\n",(0,l.jsx)(n.h2,{id:"real-world-production-example",children:"Real-World Production Example"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"upstream web_backend {\r\nleast_conn;\r\n\r\n    server 10.0.1.10:8080 max_fails=2 fail_timeout=15s;\r\n    server 10.0.1.11:8080 max_fails=2 fail_timeout=15s;\r\n    server 10.0.1.99:8080 backup;\r\n\r\n}\r\n\r\nserver {\r\nlisten 80;\r\n\r\n    location / {\r\n        proxy_pass http://web_backend;\r\n        proxy_connect_timeout 2s;\r\n        proxy_read_timeout 30s;\r\n    }\r\n\r\n}\n"})}),"\n",(0,l.jsx)(n.h2,{id:"summary",children:"Summary"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"Health checks prevent traffic to failed backends"}),"\n",(0,l.jsx)(n.li,{children:"Open-source NGINX supports passive health checks"}),"\n",(0,l.jsxs)(n.li,{children:["Key directives:","\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"max_fails"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"fail_timeout"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.code,{children:"backup"})}),"\n"]}),"\n"]}),"\n",(0,l.jsx)(n.li,{children:"Active health checks require NGINX Plus"}),"\n",(0,l.jsx)(n.li,{children:"Proper tuning is critical for reliability"}),"\n"]})]})}function o(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(h,{...e})}):h(e)}}}]);