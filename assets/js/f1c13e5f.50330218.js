"use strict";(globalThis.webpackChunkhandbook=globalThis.webpackChunkhandbook||[]).push([[25261],{28453(e,r,n){n.d(r,{R:()=>l,x:()=>t});var s=n(96540);const i={},a=s.createContext(i);function l(e){const r=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function t(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),s.createElement(a.Provider,{value:r},e.children)}},54507(e,r,n){n.r(r),n.d(r,{assets:()=>d,contentTitle:()=>t,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"prisma/Middleware","title":"Middleware","description":"Query Middleware","source":"@site/docs/prisma/7. Middleware.md","sourceDirName":"prisma","slug":"/prisma/Middleware","permalink":"/handbook/docs/prisma/Middleware","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"sidebar_position":7},"sidebar":"prismaApiSidebar","previous":{"title":"Advanced Query","permalink":"/handbook/docs/prisma/Advanced Query"},"next":{"title":"Transaction","permalink":"/handbook/docs/prisma/Transaction"}}');var i=n(74848),a=n(28453);const l={sidebar_position:7},t=void 0,d={},o=[{value:"Query Middleware",id:"query-middleware",level:2},{value:"How Prisma Middleware Works",id:"how-prisma-middleware-works",level:2},{value:"General Middleware Signature",id:"general-middleware-signature",level:2},{value:"Logging Middleware",id:"logging-middleware",level:2},{value:"Enforcing Soft Deletes",id:"enforcing-soft-deletes",level:2},{value:"Role-Based Access Control",id:"role-based-access-control",level:2},{value:"Query Transformation",id:"query-transformation",level:2}];function c(e){const r={code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.h2,{id:"query-middleware",children:"Query Middleware"}),"\n",(0,i.jsx)(r.p,{children:"In Prisma, middleware is a function that intercepts every query before it reaches the database (and after the database responds). It allows you to inspect, modify, or extend the behavior of queries globally, across your whole application."}),"\n",(0,i.jsx)(r.p,{children:"This is especially useful for:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"Logging queries"}),"\n",(0,i.jsx)(r.li,{children:"Measuring query performance (timing)"}),"\n",(0,i.jsx)(r.li,{children:"Enforcing business rules (like soft deletes, role-based filtering, multi-tenancy)"}),"\n",(0,i.jsx)(r.li,{children:"Debugging or analytics"}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Prisma\u2019s middleware works similarly to middleware in frameworks like Express, but at the database query level."}),"\n",(0,i.jsx)(r.h2,{id:"how-prisma-middleware-works",children:"How Prisma Middleware Works"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsxs)(r.li,{children:["Middleware functions are added to the Prisma client using ",(0,i.jsx)(r.code,{children:".use()"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:["Each middleware function receives:","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"params"}),": Metadata about the Prisma query (model, action, arguments)."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"next"}),": A function to call the next middleware (or execute the actual query)."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(r.li,{children:["Middleware can:","\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Inspect/modify ",(0,i.jsx)(r.code,{children:"params"})," before passing them on."]}),"\n",(0,i.jsx)(r.li,{children:"Run logic before/after the query executes."}),"\n",(0,i.jsx)(r.li,{children:"Return or override results."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"general-middleware-signature",children:"General Middleware Signature"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-prisma",children:"prisma.$use(async (params, next) => {\r\n  // logic before the query\r\n  const result = await next(params) // runs the next middleware or actual query\r\n  // logic after the query\r\n  return result\r\n})\n"})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"params"}),": contains details like ",(0,i.jsx)(r.code,{children:"{ model, action, args }"}),"."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"next(params)"}),": executes the query (or passes it to the next middleware)."]}),"\n",(0,i.jsxs)(r.li,{children:[(0,i.jsx)(r.code,{children:"result"}),": the returned data from the database."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"logging-middleware",children:"Logging Middleware"}),"\n",(0,i.jsx)(r.p,{children:"This middleware logs every query and measures execution time."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:'import { PrismaClient } from "@prisma/client";\r\n\r\nconst prisma = new PrismaClient();\r\n\r\nprisma.$use(async (params, next) => {\r\n  const start = Date.now();\r\n\r\n  // Run the query\r\n  const result = await next(params);\r\n\r\n  const duration = Date.now() - start;\r\n  console.log(`Query: ${params.model}.${params.action} took ${duration}ms`);\r\n\r\n  return result;\r\n});\r\n\r\n// Example query\r\nasync function main() {\r\n  await prisma.user.findMany();\r\n}\r\nmain();\n'})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Logs the ",(0,i.jsx)(r.code,{children:"model"})," (",(0,i.jsx)(r.code,{children:"User"}),") and ",(0,i.jsx)(r.code,{children:"action"})," (",(0,i.jsx)(r.code,{children:"findMany"}),")."]}),"\n",(0,i.jsx)(r.li,{children:"Measures how long the query took."}),"\n",(0,i.jsx)(r.li,{children:"Very useful for performance monitoring and debugging."}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"enforcing-soft-deletes",children:"Enforcing Soft Deletes"}),"\n",(0,i.jsx)(r.p,{children:"Imagine you want to implement soft deletes (mark a record as deleted instead of actually deleting it). You can use middleware to automatically filter out deleted records."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:'prisma.$use(async (params, next) => {\r\n  // Apply soft delete filter to all "find" queries\r\n  if (params.model === "User") {\r\n    if (params.action === "findMany") {\r\n      // Ensure "deleted = false" condition\r\n      params.args.where = {\r\n        ...params.args.where,\r\n        deleted: false,\r\n      };\r\n    }\r\n  }\r\n\r\n  return next(params);\r\n});\n'})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Intercepts all queries for the ",(0,i.jsx)(r.code,{children:"User"})," model."]}),"\n",(0,i.jsxs)(r.li,{children:["If the query is ",(0,i.jsx)(r.code,{children:"findMany"}),", it automatically adds ",(0,i.jsx)(r.code,{children:"deleted: false"})," to the ",(0,i.jsx)(r.code,{children:"where"})," filter."]}),"\n",(0,i.jsx)(r.li,{children:"Prevents accidentally showing soft-deleted records."}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"role-based-access-control",children:"Role-Based Access Control"}),"\n",(0,i.jsx)(r.p,{children:"You can enforce RBAC (Role-Based Access Control) at the query level."}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:'prisma.$use(async (params, next) => {\r\n  // Restrict update/delete queries on "Post" if the user is not an admin\r\n  if (params.model === "Post" && ["update", "delete"].includes(params.action)) {\r\n    if (\r\n      !params.args.where.authorId ||\r\n      params.args.where.authorId !== CURRENT_USER_ID\r\n    ) {\r\n      throw new Error("Unauthorized: You can only modify your own posts.");\r\n    }\r\n  }\r\n\r\n  return next(params);\r\n});\n'})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Protects the ",(0,i.jsx)(r.code,{children:"Post"})," model from unauthorized modifications."]}),"\n",(0,i.jsx)(r.li,{children:"Before executing, it checks if the current user is allowed to update/delete the record."}),"\n",(0,i.jsx)(r.li,{children:"If not, throws an error."}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"query-transformation",children:"Query Transformation"}),"\n",(0,i.jsx)(r.p,{children:"You can modify query arguments before they hit the DB. For example, enforcing case-insensitive searches:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-ts",children:'prisma.$use(async (params, next) => {\r\n  if (params.model === "User" && params.action === "findMany") {\r\n    if (params.args.where?.email) {\r\n      params.args.where.email = {\r\n        equals: params.args.where.email.toLowerCase(),\r\n        mode: "insensitive",\r\n      };\r\n    }\r\n  }\r\n\r\n  return next(params);\r\n});\n'})}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Whenever you query users by ",(0,i.jsx)(r.code,{children:"email"}),", it ensures the query is case-insensitive."]}),"\n",(0,i.jsx)(r.li,{children:"Prevents mismatched results due to case differences."}),"\n"]})]})}function u(e={}){const{wrapper:r}={...(0,a.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}}}]);