---
sidebar_position: 7
---

## Query Middleware

In Prisma, middleware is a function that intercepts every query before it reaches the database (and after the database responds). It allows you to inspect, modify, or extend the behavior of queries globally, across your whole application.

This is especially useful for:

- Logging queries
- Measuring query performance (timing)
- Enforcing business rules (like soft deletes, role-based filtering, multi-tenancy)
- Debugging or analytics

Prismaâ€™s middleware works similarly to middleware in frameworks like Express, but at the database query level.

## How Prisma Middleware Works

1. Middleware functions are added to the Prisma client using `.use()`.
2. Each middleware function receives:
   - `params`: Metadata about the Prisma query (model, action, arguments).
   - `next`: A function to call the next middleware (or execute the actual query).
3. Middleware can:
   - Inspect/modify `params` before passing them on.
   - Run logic before/after the query executes.
   - Return or override results.

## General Middleware Signature

```prisma
prisma.$use(async (params, next) => {
  // logic before the query
  const result = await next(params) // runs the next middleware or actual query
  // logic after the query
  return result
})
```

- `params`: contains details like `{ model, action, args }`.
- `next(params)`: executes the query (or passes it to the next middleware).
- `result`: the returned data from the database.

## Logging Middleware

This middleware logs every query and measures execution time.

```ts
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

prisma.$use(async (params, next) => {
  const start = Date.now();

  // Run the query
  const result = await next(params);

  const duration = Date.now() - start;
  console.log(`Query: ${params.model}.${params.action} took ${duration}ms`);

  return result;
});

// Example query
async function main() {
  await prisma.user.findMany();
}
main();
```

- Logs the `model` (`User`) and `action` (`findMany`).
- Measures how long the query took.
- Very useful for performance monitoring and debugging.

## Enforcing Soft Deletes

Imagine you want to implement soft deletes (mark a record as deleted instead of actually deleting it). You can use middleware to automatically filter out deleted records.

```ts
prisma.$use(async (params, next) => {
  // Apply soft delete filter to all "find" queries
  if (params.model === "User") {
    if (params.action === "findMany") {
      // Ensure "deleted = false" condition
      params.args.where = {
        ...params.args.where,
        deleted: false,
      };
    }
  }

  return next(params);
});
```

- Intercepts all queries for the `User` model.
- If the query is `findMany`, it automatically adds `deleted: false` to the `where` filter.
- Prevents accidentally showing soft-deleted records.

## Role-Based Access Control

You can enforce RBAC (Role-Based Access Control) at the query level.

```ts
prisma.$use(async (params, next) => {
  // Restrict update/delete queries on "Post" if the user is not an admin
  if (params.model === "Post" && ["update", "delete"].includes(params.action)) {
    if (
      !params.args.where.authorId ||
      params.args.where.authorId !== CURRENT_USER_ID
    ) {
      throw new Error("Unauthorized: You can only modify your own posts.");
    }
  }

  return next(params);
});
```

- Protects the `Post` model from unauthorized modifications.
- Before executing, it checks if the current user is allowed to update/delete the record.
- If not, throws an error.

## Query Transformation

You can modify query arguments before they hit the DB. For example, enforcing case-insensitive searches:

```ts
prisma.$use(async (params, next) => {
  if (params.model === "User" && params.action === "findMany") {
    if (params.args.where?.email) {
      params.args.where.email = {
        equals: params.args.where.email.toLowerCase(),
        mode: "insensitive",
      };
    }
  }

  return next(params);
});
```

- Whenever you query users by `email`, it ensures the query is case-insensitive.
- Prevents mismatched results due to case differences.
