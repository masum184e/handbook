---
sidebar_position: 10
---

The N+1 problem happens when you:

1. Fetch a list of records (1 query).
2. Then for each record, you fetch related data separately (N queries).

This leads to 1 (main query) + N (sub-queries) → hence the name N+1 queries.

Problem: For large datasets, this can blow up into hundreds or thousands of queries, causing slow response times and database overload.

## Example of the N+1 Problem in Prisma

Imagine you want to fetch users and their posts.

```ts
// Step 1: Fetch all users
const users = await prisma.user.findMany();

// Step 2: For each user, fetch posts separately
for (const user of users) {
  user.posts = await prisma.post.findMany({
    where: { authorId: user.id },
  });
}

console.log(users);
```

If you have:

- 10 users → `1 + 10 = 11 queries`
- 1000 users → `1 + 1000 = 1001 queries`

This does not scale.

## Optimized Solutions in Prisma

### Eager Loading

Prisma can load related data in a single query using `include`.

```ts
// Fetch users and their posts in one query
const users = await prisma.user.findMany({
  include: {
    posts: true, // eager load posts
  },
});
```

- Prisma sends a JOIN-like query (or two optimized queries).
- Instead of fetching posts per user separately, all posts are fetched in one go.

### Use `select` for Partial Data

```ts
const users = await prisma.user.findMany({
  include: {
    posts: {
      select: {
        id: true,
        title: true,
      },
    },
  },
});
```

### Use `prisma.$transaction` for Batch Queries

```ts
const [users, posts] = await prisma.$transaction([
  prisma.user.findMany(),
  prisma.post.findMany(),
]);

// Map posts to users in memory
const userMap = users.map((user) => ({
  ...user,
  posts: posts.filter((p) => p.authorId === user.id),
}));
```

## Performance Comparison

Let’s say we have 100 users, each with 10 posts:

| Approach                  | Queries Sent | Notes                            |
| ------------------------- | ------------ | -------------------------------- |
| Naive (N+1)               | 101          | 1 for users + 100 for posts      |
| `include` (Eager Loading) | 1            | Single optimized query           |
| `$transaction` batching   | 2            | One for users, one for posts     |
| Dataloader batching       | 2            | 1 for users, 1 batched for posts |
