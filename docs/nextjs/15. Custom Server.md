---
title: Custom Server
sidebar_position: 17
---

## Set Up Custom Server

By default, Next.js provides a built-in server (using Node.js) that handles:

- Routing
- API routes
- Static files
- SSR (server-side rendering)

But sometimes you need more control over the server, such as:

- Adding custom routes not handled by Next.js.
- Adding custom middleware (e.g., authentication, logging).
- Integrating with an existing backend (e.g., Express, Koa, Fastify).
- Setting up custom headers or proxies.
- For this, you can create a custom server instead of relying only on Next.jsâ€™s built-in one.

**Important Note (Next.js 13+)**

- In modern versions, Next.js recommends using Middleware, API routes, or Edge Functions instead of custom servers.
- But for self-hosted apps (not Vercel) or legacy apps, custom servers are still useful.

### Setting Up a Custom Server

1. **Install Dependencies**

   ```bash
   npm install next react react-dom express@4
   npm install --save-dev typescript @types/node @types/react @types/react-dom @types/express ts-node nodemon
   ```

2. **Update `package.json` Scripts**

   ```json
   "scripts": {
     "dev": "nodemon --watch server.ts --exec ts-node server.ts",
     "build": "next build",
     "start": "NODE_ENV=production node dist/server.js"
   }
   ```

   - `dev` â†’ runs your custom server in development mode (with hot reload).
   - `build` â†’ compiles your Next.js app.
   - `start` â†’ runs the compiled server in production.

3. **Write `server.ts`**

   ```ts
   import express, { type Request, type Response } from "express";
   import next from "next";

   const dev = process.env.NODE_ENV !== "production";
   const app = next({ dev });
   const handle = app.getRequestHandler(); // Next.js request handler

   app.prepare().then(() => {
     const server = express();

     server.get("/p/:id", (req: Request, res: Response) => {
       app.render(req, res, "/post", { id: req.params.id });
     });

     server.get("/hello", (_req: Request, res: Response) => {
       res.send("Hello from custom server!");
     });

     // Express 5 compatible catch-all
     server.all(/.*/, (req: Request, res: Response) => handle(req, res));

     server.listen(3000, (err?: Error) => {
       if (err) throw err;
       console.log("ðŸš€ Server running at http://localhost:3000");
     });
   });
   ```

   - `next({ dev })` â†’ Initializes Next.js in dev or production mode.
   - `app.prepare()` â†’ Prepares Next.js to handle requests.
   - `handle` â†’ Next.jsâ€™s built-in request handler (used for normal pages/static files).
   - `server.get('/p/:id')` â†’ Custom Express route mapping `/p/:id` â†’ Next.js `/post` page.
   - `server.all('*')` â†’ For all other routes, fall back to Next.js default handler.

### When to Use Custom Server?

**Use it if you need:**

- Custom routing logic (rewrites, redirects, slugs).
- Middleware (auth, logging, analytics).
- Integration with Express/Koa backend APIs.

**Avoid it if:**

- Youâ€™re deploying to Vercel â†’ Vercel does not support custom servers.
- You only need rewrites/redirects â†’ Use `next.config.js` instead.

### Differences vs. Default Next.js Server

| Feature               | Default Server (`next start`) | Custom Server                      |
| --------------------- | ----------------------------- | ---------------------------------- |
| Routing               | Automatic (file-based)        | Manual + Next.js handler           |
| Middleware            | Not supported                 | Fully supported (Express/Koa etc.) |
| Vercel support        | âœ… Yes                        | âŒ No                              |
| Deployment complexity | Easy                          | Higher (manage yourself)           |

## Custom Server Configuration

- `next.config.js` is a configuration file at the root of your Next.js project.
- It allows you to customize Next.jsâ€™s default behavior without modifying the framework itself.
- Common use cases:
  - Adding environment variables
  - Configuring custom webpack settings
  - Enabling experimental features
  - Optimizing images, redirects, and rewrites
  - Setting internationalization (i18n)

Think of it as the central place to tweak how Next.js works.

```ts
/** @type {import('next').NextConfig} */
const nextConfig = {
  reactStrictMode: true, // Enable React strict mode
  swcMinify: true, // Use SWC for faster builds
};

module.exports = nextConfig;
```

This enables React strict mode (catches potential problems) and SWC minification for faster builds.

### Common Custom Configurations

#### Environment Variables

You can define public and server-side environment variables.

```ts
const nextConfig = {
  env: {
    CUSTOM_API_URL: "https://api.example.com",
  },
};

module.exports = nextConfig;
```

- Accessible in your code: `console.log(process.env.CUSTOM_API_URL)`
- `env` variables are exposed to the browser too. For server-only secrets, use `.env.local`.

#### Custom Webpack Config

Modify Webpack to add loaders or plugins.

```ts
const nextConfig = {
  webpack: (config, { isServer }) => {
    // Example: Add a rule for SVG imports
    config.module.rules.push({
      test: /\.svg$/,
      use: ["@svgr/webpack"],
    });

    return config;
  },
};

module.exports = nextConfig;
```

This lets you import SVGs as React components:

```ts
import Logo from "@/public/logo.svg";
export default function Home() {
  return <Logo />;
}
```

#### Redirects

Define server-side redirects.

```ts
const nextConfig = {
  async redirects() {
    return [
      {
        source: "/old-blog/:slug*",
        destination: "/new-blog/:slug*",
        permanent: true,
      },
    ];
  },
};

module.exports = nextConfig;
```

Visiting `/old-blog/hello-world` â†’ Redirects to `/new-blog/hello-world`.

#### Rewrites

Rewrites allow you to mask an API endpoint with a different URL.

```ts
const nextConfig = {
  async rewrites() {
    return [
      {
        source: "/api/:path*",
        destination: "https://external-api.com/:path*",
      },
    ];
  },
};

module.exports = nextConfig;
```

Visiting `/api/users` â†’ Internally fetches from `https://external-api.com/users`.

#### Headers

Set custom HTTP headers (e.g., security headers).

```ts
const nextConfig = {
  async headers() {
    return [
      {
        source: "/(.*)",
        headers: [
          { key: "X-Frame-Options", value: "DENY" },
          { key: "X-Content-Type-Options", value: "nosniff" },
        ],
      },
    ];
  },
};

module.exports = nextConfig;
```

This applies headers to all routes.

#### Image Optimization

Control domains allowed for `<Image />`.

```ts
const nextConfig = {
  images: {
    domains: ["example.com", "cdn.example.org"],
  },
};

module.exports = nextConfig;
```

Lets you safely load images from external domains.

#### Internationalization (i18n)

Enable multiple locales.

```ts
const nextConfig = {
  i18n: {
    locales: ["en", "fr", "de"],
    defaultLocale: "en",
  },
};

module.exports = nextConfig;
```

Adds automatic locale-based routing:

- `/fr/about` â†’ French version
- `/de/about` â†’ German version
